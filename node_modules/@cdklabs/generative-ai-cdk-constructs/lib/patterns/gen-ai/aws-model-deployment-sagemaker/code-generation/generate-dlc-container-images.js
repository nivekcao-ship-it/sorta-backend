"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateDLCContainerImages = generateDLCContainerImages;
exports.getRepositories = getRepositories;
const node_child_process_1 = require("node:child_process");
const path = require("path");
const generate_utils_1 = require("./generate-utils");
const regionName = 'us-west-2';
const startVersionRegex = /^\d+\.\d+\.\d+-/;
const versionRegex = /-v\d+(\.\d+)*(-\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2})?$/;
const repositories = [
    'huggingface-pytorch-tgi-inference',
    'huggingface-pytorch-inference',
    'huggingface-tensorflow-inference',
    'huggingface-pytorch-inference-neuronx',
    'djl-inference',
];
const DEEP_LEARNING_CONTAINER_IMAGE_PATH = path.join(__dirname, '../deep-learning-container-image.ts');
async function generateDLCContainerImages() {
    console.log('Getting DLC container image data');
    const output = (0, node_child_process_1.execSync)(`aws ecr get-authorization-token --output text --query 'authorizationData[].authorizationToken' --region ${regionName}`);
    const token = output.toString();
    const repositoryTagData = {};
    for (const repositoryName of repositories) {
        console.log(repositoryName);
        const pageSize = 1000;
        const hostname = '763104351884.dkr.ecr.us-west-2.amazonaws.com';
        let link = `/v2/${repositoryName}/tags/list?n=${pageSize}`;
        let tags = [];
        while (link) {
            const [data, response] = await generate_utils_1.GenerateUtils.downloadJSON({
                hostname,
                port: 443,
                method: 'GET',
                path: link,
                headers: {
                    Authorization: `Basic ${token.trim()}`,
                },
            });
            tags.push(...data.tags);
            link = response.headers.link;
            if (link) {
                console.log(link);
                link = link.substring(1, link.indexOf('>')).split(hostname)[1];
                console.log('Link:', link);
            }
        }
        tags = tags.filter((tag) => startVersionRegex.test(tag));
        if (repositoryName == 'huggingface-tensorflow-inference' ||
            repositoryName == 'huggingface-pytorch-inference' ||
            repositoryName == 'huggingface-pytorch-inference-neuronx') {
            tags = tags.filter((tag) => tag.includes('-transformers'));
        }
        else if (repositoryName == 'huggingface-pytorch-tgi-inference') {
            tags = tags.filter((tag) => tag.includes('-tgi'));
        }
        else if (repositoryName == 'djl-inference') {
            tags = tags.filter((tag) => tag.includes('-deepspeed') ||
                tag.includes('-fastertransformer') ||
                tag.includes('-neuronx'));
        }
        tags = tags.map((tag) => tag.replace(versionRegex, ''));
        tags = Array.from(new Set(tags)).sort();
        repositoryTagData[repositoryName] = tags;
        console.log(tags);
    }
    generateCode(repositoryTagData);
}
async function getRepositories() {
    const repositoryNames = new Set();
    const GITHUB_URL = 'https://raw.githubusercontent.com/aws/sagemaker-python-sdk/master/src/sagemaker/image_uri_config';
    const fileNames = [
        `${GITHUB_URL}/huggingface-llm.json`,
        `${GITHUB_URL}/huggingface.json`,
        `${GITHUB_URL}/huggingface-neuronx.json`,
        `${GITHUB_URL}/djl-deepspeed.json`,
        `${GITHUB_URL}/djl-fastertransformer.json`,
        `${GITHUB_URL}/djl-neuronx.json`,
    ];
    for (const fileName of fileNames) {
        const [data] = await generate_utils_1.GenerateUtils.downloadJSON(fileName);
        console.log('Processing file:', fileName);
        const versions = data.versions || data.inference.versions;
        for (const version of Object.keys(versions)) {
            const versionData = versions[version];
            const versionAliases = versionData.version_aliases;
            const items = [];
            if (versionAliases) {
                for (const versionAlias of Object.keys(versionAliases)) {
                    items.push(versionData[versionAliases[versionAlias]]);
                }
            }
            else {
                items.push(versionData);
            }
            for (const item of items) {
                const repositoryName = item.repository;
                repositoryNames.add(repositoryName);
            }
        }
    }
    console.log('Repositories:', new Array(...repositories));
    return repositoryNames;
}
function generateCode(repositoryTagData) {
    let imagesStr = '';
    for (const repositoryName of Object.keys(repositoryTagData).sort()) {
        const tags = repositoryTagData[repositoryName].sort();
        const repositoryNameStr = generate_utils_1.GenerateUtils.replaceAll(repositoryName, '-', '_').toUpperCase();
        for (const tagName of tags) {
            const tagNameStr = generate_utils_1.GenerateUtils.replaceAllBatch(tagName, ['\\.', '-'], '_').toUpperCase();
            const name = `${repositoryNameStr}_${tagNameStr}`;
            imagesStr +=
                '  ' +
                    `public static readonly ${name} = this.fromDeepLearningContainerImage('${repositoryName}', '${tagName}');\n`;
        }
    }
    const fileStr = `/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */

import { Stack } from 'aws-cdk-lib';
import * as ecr from 'aws-cdk-lib/aws-ecr';
import * as iam from 'aws-cdk-lib/aws-iam';
import { FactName } from 'aws-cdk-lib/region-info';
import { Construct } from 'constructs';
import { ContainerImage, ContainerImageConfig } from './container-image';

export class DeepLearningContainerImage extends ContainerImage {
${imagesStr}

  public static fromDeepLearningContainerImage(
    repositoryName: string,
    tag: string,
    accountId?: string,
  ): ContainerImage {
    return new DeepLearningContainerImage(repositoryName, tag, accountId);
  }

  constructor(
    private readonly repositoryName: string,
    private readonly tag: string,
    private readonly accountId?: string,
  ) {
    super();
  }

  public bind(
    scope: Construct,
    grantable: iam.IGrantable,
  ): ContainerImageConfig {
    const accountId =
      this.accountId ??
      Stack.of(scope).regionalFact(FactName.DLC_REPOSITORY_ACCOUNT);

    const repository = ecr.Repository.fromRepositoryAttributes(
      scope,
      'DeepLearningContainerRepository',
      {
        repositoryName: this.repositoryName,
        repositoryArn: ecr.Repository.arnForLocalRepository(
          this.repositoryName,
          scope,
          accountId,
        ),
      },
    );

    repository.grantPull(grantable);

    return { imageName: repository.repositoryUri + ':' + this.tag };
  }
}
`;
    generate_utils_1.GenerateUtils.writeFileSyncWithDirs(DEEP_LEARNING_CONTAINER_IMAGE_PATH, fileStr);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUtZGxjLWNvbnRhaW5lci1pbWFnZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvcGF0dGVybnMvZ2VuLWFpL2F3cy1tb2RlbC1kZXBsb3ltZW50LXNhZ2VtYWtlci9jb2RlLWdlbmVyYXRpb24vZ2VuZXJhdGUtZGxjLWNvbnRhaW5lci1pbWFnZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7OztHQVdHOztBQXVCSCxnRUFnRUM7QUFFRCwwQ0EyQ0M7QUFsSUQsMkRBQThDO0FBQzlDLDZCQUE2QjtBQUM3QixxREFBaUQ7QUFFakQsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDO0FBQy9CLE1BQU0saUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7QUFDNUMsTUFBTSxZQUFZLEdBQUcsdURBQXVELENBQUM7QUFFN0UsTUFBTSxZQUFZLEdBQUc7SUFDbkIsbUNBQW1DO0lBQ25DLCtCQUErQjtJQUMvQixrQ0FBa0M7SUFDbEMsdUNBQXVDO0lBQ3ZDLGVBQWU7Q0FDaEIsQ0FBQztBQUVGLE1BQU0sa0NBQWtDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FDbEQsU0FBUyxFQUNULHFDQUFxQyxDQUN0QyxDQUFDO0FBRUssS0FBSyxVQUFVLDBCQUEwQjtJQUM5QyxPQUFPLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7SUFFaEQsTUFBTSxNQUFNLEdBQUcsSUFBQSw2QkFBUSxFQUNyQiwyR0FBMkcsVUFBVSxFQUFFLENBQ3hILENBQUM7SUFFRixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDaEMsTUFBTSxpQkFBaUIsR0FBMkMsRUFBRSxDQUFDO0lBQ3JFLEtBQUssTUFBTSxjQUFjLElBQUksWUFBWSxFQUFFLENBQUM7UUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUU1QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFD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Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztDQTRDVixDQUFDO0lBRUEsOEJBQWEsQ0FBQyxxQkFBcUIsQ0FBQyxrQ0FBa0MsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNuRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdub2RlOmNoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEdlbmVyYXRlVXRpbHMgfSBmcm9tICcuL2dlbmVyYXRlLXV0aWxzJztcblxuY29uc3QgcmVnaW9uTmFtZSA9ICd1cy13ZXN0LTInO1xuY29uc3Qgc3RhcnRWZXJzaW9uUmVnZXggPSAvXlxcZCtcXC5cXGQrXFwuXFxkKy0vO1xuY29uc3QgdmVyc2lvblJlZ2V4ID0gLy12XFxkKyhcXC5cXGQrKSooLVxcZHs0fS1cXGR7Mn0tXFxkezJ9LVxcZHsyfS1cXGR7Mn0tXFxkezJ9KT8kLztcblxuY29uc3QgcmVwb3NpdG9yaWVzID0gW1xuICAnaHVnZ2luZ2ZhY2UtcHl0b3JjaC10Z2ktaW5mZXJlbmNlJyxcbiAgJ2h1Z2dpbmdmYWNlLXB5dG9yY2gtaW5mZXJlbmNlJyxcbiAgJ2h1Z2dpbmdmYWNlLXRlbnNvcmZsb3ctaW5mZXJlbmNlJyxcbiAgJ2h1Z2dpbmdmYWNlLXB5dG9yY2gtaW5mZXJlbmNlLW5ldXJvbngnLFxuICAnZGpsLWluZmVyZW5jZScsXG5dO1xuXG5jb25zdCBERUVQX0xFQVJOSU5HX0NPTlRBSU5FUl9JTUFHRV9QQVRIID0gcGF0aC5qb2luKFxuICBfX2Rpcm5hbWUsXG4gICcuLi9kZWVwLWxlYXJuaW5nLWNvbnRhaW5lci1pbWFnZS50cycsXG4pO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVETENDb250YWluZXJJbWFnZXMoKSB7XG4gIGNvbnNvbGUubG9nKCdHZXR0aW5nIERMQyBjb250YWluZXIgaW1hZ2UgZGF0YScpO1xuXG4gIGNvbnN0IG91dHB1dCA9IGV4ZWNTeW5jKFxuICAgIGBhd3MgZWNyIGdldC1hdXRob3JpemF0aW9uLXRva2VuIC0tb3V0cHV0IHRleHQgLS1xdWVyeSAnYXV0aG9yaXphdGlvbkRhdGFbXS5hdXRob3JpemF0aW9uVG9rZW4nIC0tcmVnaW9uICR7cmVnaW9uTmFtZX1gLFxuICApO1xuXG4gIGNvbnN0IHRva2VuID0gb3V0cHV0LnRvU3RyaW5nKCk7XG4gIGNvbnN0IHJlcG9zaXRvcnlUYWdEYXRhOiB7IFtyZXBvc2l0b3J5TmFtZTogc3RyaW5nXTogc3RyaW5nW10gfSA9IHt9O1xuICBmb3IgKGNvbnN0IHJlcG9zaXRvcnlOYW1lIG9mIHJlcG9zaXRvcmllcykge1xuICAgIGNvbnNvbGUubG9nKHJlcG9zaXRvcnlOYW1lKTtcblxuICAgIGNvbnN0IHBhZ2VTaXplID0gMTAwMDtcbiAgICBjb25zdCBob3N0bmFtZSA9ICc3NjMxMDQzNTE4ODQuZGtyLmVjci51cy13ZXN0LTIuYW1hem9uYXdzLmNvbSc7XG4gICAgbGV0IGxpbmsgPSBgL3YyLyR7cmVwb3NpdG9yeU5hbWV9L3RhZ3MvbGlzdD9uPSR7cGFnZVNpemV9YDtcbiAgICBsZXQgdGFnczogc3RyaW5nW10gPSBbXTtcblxuICAgIHdoaWxlIChsaW5rKSB7XG4gICAgICBjb25zdCBbZGF0YSwgcmVzcG9uc2VdID0gYXdhaXQgR2VuZXJhdGVVdGlscy5kb3dubG9hZEpTT04oe1xuICAgICAgICBob3N0bmFtZSxcbiAgICAgICAgcG9ydDogNDQzLFxuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBwYXRoOiBsaW5rLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJhc2ljICR7dG9rZW4udHJpbSgpfWAsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgdGFncy5wdXNoKC4uLmRhdGEudGFncyk7XG5cbiAgICAgIGxpbmsgPSByZXNwb25zZS5oZWFkZXJzLmxpbms7XG4gICAgICBpZiAobGluaykge1xuICAgICAgICBjb25zb2xlLmxvZyhsaW5rKTtcbiAgICAgICAgbGluayA9IGxpbmsuc3Vic3RyaW5nKDEsIGxpbmsuaW5kZXhPZignPicpKS5zcGxpdChob3N0bmFtZSlbMV07XG4gICAgICAgIGNvbnNvbGUubG9nKCdMaW5rOicsIGxpbmspO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRhZ3MgPSB0YWdzLmZpbHRlcigodGFnOiBzdHJpbmcpID0+IHN0YXJ0VmVyc2lvblJlZ2V4LnRlc3QodGFnKSk7XG4gICAgaWYgKFxuICAgICAgcmVwb3NpdG9yeU5hbWUgPT0gJ2h1Z2dpbmdmYWNlLXRlbnNvcmZsb3ctaW5mZXJlbmNlJyB8fFxuICAgICAgcmVwb3NpdG9yeU5hbWUgPT0gJ2h1Z2dpbmdmYWNlLXB5dG9yY2gtaW5mZXJlbmNlJyB8fFxuICAgICAgcmVwb3NpdG9yeU5hbWUgPT0gJ2h1Z2dpbmdmYWNlLXB5dG9yY2gtaW5mZXJlbmNlLW5ldXJvbngnXG4gICAgKSB7XG4gICAgICB0YWdzID0gdGFncy5maWx0ZXIoKHRhZzogc3RyaW5nKSA9PiB0YWcuaW5jbHVkZXMoJy10cmFuc2Zvcm1lcnMnKSk7XG4gICAgfSBlbHNlIGlmIChyZXBvc2l0b3J5TmFtZSA9PSAnaHVnZ2luZ2ZhY2UtcHl0b3JjaC10Z2ktaW5mZXJlbmNlJykge1xuICAgICAgdGFncyA9IHRhZ3MuZmlsdGVyKCh0YWc6IHN0cmluZykgPT4gdGFnLmluY2x1ZGVzKCctdGdpJykpO1xuICAgIH0gZWxzZSBpZiAocmVwb3NpdG9yeU5hbWUgPT0gJ2RqbC1pbmZlcmVuY2UnKSB7XG4gICAgICB0YWdzID0gdGFncy5maWx0ZXIoXG4gICAgICAgICh0YWc6IHN0cmluZykgPT5cbiAgICAgICAgICB0YWcuaW5jbHVkZXMoJy1kZWVwc3BlZWQnKSB8fFxuICAgICAgICAgIHRhZy5pbmNsdWRlcygnLWZhc3RlcnRyYW5zZm9ybWVyJykgfHxcbiAgICAgICAgICB0YWcuaW5jbHVkZXMoJy1uZXVyb254JyksXG4gICAgICApO1xuICAgIH1cblxuICAgIHRhZ3MgPSB0YWdzLm1hcCgodGFnOiBzdHJpbmcpID0+IHRhZy5yZXBsYWNlKHZlcnNpb25SZWdleCwgJycpKTtcbiAgICB0YWdzID0gQXJyYXkuZnJvbShuZXcgU2V0KHRhZ3MpKS5zb3J0KCk7XG5cbiAgICByZXBvc2l0b3J5VGFnRGF0YVtyZXBvc2l0b3J5TmFtZV0gPSB0YWdzO1xuICAgIGNvbnNvbGUubG9nKHRhZ3MpO1xuICB9XG5cbiAgZ2VuZXJhdGVDb2RlKHJlcG9zaXRvcnlUYWdEYXRhKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFJlcG9zaXRvcmllcygpIHtcbiAgY29uc3QgcmVwb3NpdG9yeU5hbWVzID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgY29uc3QgR0lUSFVCX1VSTCA9XG4gICAgJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9hd3Mvc2FnZW1ha2VyLXB5dGhvbi1zZGsvbWFzdGVyL3NyYy9zYWdlbWFrZXIvaW1hZ2VfdXJpX2NvbmZpZyc7XG4gIGNvbnN0IGZpbGVOYW1lcyA9IFtcbiAgICBgJHtHSVRIVUJfVVJMfS9odWdnaW5nZmFjZS1sbG0uanNvbmAsXG4gICAgYCR7R0lUSFVCX1VSTH0vaHVnZ2luZ2ZhY2UuanNvbmAsXG4gICAgYCR7R0lUSFVCX1VSTH0vaHVnZ2luZ2ZhY2UtbmV1cm9ueC5qc29uYCxcbiAgICBgJHtHSVRIVUJfVVJMfS9kamwtZGVlcHNwZWVkLmpzb25gLFxuICAgIGAke0dJVEhVQl9VUkx9L2RqbC1mYXN0ZXJ0cmFuc2Zvcm1lci5qc29uYCxcbiAgICBgJHtHSVRIVUJfVVJMfS9kamwtbmV1cm9ueC5qc29uYCxcbiAgXTtcblxuICBmb3IgKGNvbnN0IGZpbGVOYW1lIG9mIGZpbGVOYW1lcykge1xuICAgIGNvbnN0IFtkYXRhXSA9IGF3YWl0IEdlbmVyYXRlVXRpbHMuZG93bmxvYWRKU09OKGZpbGVOYW1lKTtcblxuICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nIGZpbGU6JywgZmlsZU5hbWUpO1xuICAgIGNvbnN0IHZlcnNpb25zID0gZGF0YS52ZXJzaW9ucyB8fCBkYXRhLmluZmVyZW5jZS52ZXJzaW9ucztcblxuICAgIGZvciAoY29uc3QgdmVyc2lvbiBvZiBPYmplY3Qua2V5cyh2ZXJzaW9ucykpIHtcbiAgICAgIGNvbnN0IHZlcnNpb25EYXRhID0gdmVyc2lvbnNbdmVyc2lvbl07XG4gICAgICBjb25zdCB2ZXJzaW9uQWxpYXNlcyA9IHZlcnNpb25EYXRhLnZlcnNpb25fYWxpYXNlcztcblxuICAgICAgY29uc3QgaXRlbXM6IGFueVtdID0gW107XG4gICAgICBpZiAodmVyc2lvbkFsaWFzZXMpIHtcbiAgICAgICAgZm9yIChjb25zdCB2ZXJzaW9uQWxpYXMgb2YgT2JqZWN0LmtleXModmVyc2lvbkFsaWFzZXMpKSB7XG4gICAgICAgICAgaXRlbXMucHVzaCh2ZXJzaW9uRGF0YVt2ZXJzaW9uQWxpYXNlc1t2ZXJzaW9uQWxpYXNdXSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGl0ZW1zLnB1c2godmVyc2lvbkRhdGEpO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpIHtcbiAgICAgICAgY29uc3QgcmVwb3NpdG9yeU5hbWUgPSBpdGVtLnJlcG9zaXRvcnk7XG4gICAgICAgIHJlcG9zaXRvcnlOYW1lcy5hZGQocmVwb3NpdG9yeU5hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnNvbGUubG9nKCdSZXBvc2l0b3JpZXM6JywgbmV3IEFycmF5KC4uLnJlcG9zaXRvcmllcykpO1xuXG4gIHJldHVybiByZXBvc2l0b3J5TmFtZXM7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlQ29kZShyZXBvc2l0b3J5VGFnRGF0YTogeyBbcmVwb3NpdG9yeU5hbWU6IHN0cmluZ106IHN0cmluZ1tdIH0pIHtcbiAgbGV0IGltYWdlc1N0ciA9ICcnO1xuXG4gIGZvciAoY29uc3QgcmVwb3NpdG9yeU5hbWUgb2YgT2JqZWN0LmtleXMocmVwb3NpdG9yeVRhZ0RhdGEpLnNvcnQoKSkge1xuICAgIGNvbnN0IHRhZ3MgPSByZXBvc2l0b3J5VGFnRGF0YVtyZXBvc2l0b3J5TmFtZV0uc29ydCgpO1xuICAgIGNvbnN0IHJlcG9zaXRvcnlOYW1lU3RyID0gR2VuZXJhdGVVdGlscy5yZXBsYWNlQWxsKHJlcG9zaXRvcnlOYW1lLCAnLScsICdfJykudG9VcHBlckNhc2UoKTtcblxuICAgIGZvciAoY29uc3QgdGFnTmFtZSBvZiB0YWdzKSB7XG4gICAgICBjb25zdCB0YWdOYW1lU3RyID0gR2VuZXJhdGVVdGlscy5yZXBsYWNlQWxsQmF0Y2godGFnTmFtZSwgWydcXFxcLicsICctJ10sICdfJykudG9VcHBlckNhc2UoKTtcblxuICAgICAgY29uc3QgbmFtZSA9IGAke3JlcG9zaXRvcnlOYW1lU3RyfV8ke3RhZ05hbWVTdHJ9YDtcblxuICAgICAgaW1hZ2VzU3RyICs9XG4gICAgICAgICcgICcgK1xuICAgICAgICBgcHVibGljIHN0YXRpYyByZWFkb25seSAke25hbWV9ID0gdGhpcy5mcm9tRGVlcExlYXJuaW5nQ29udGFpbmVySW1hZ2UoJyR7cmVwb3NpdG9yeU5hbWV9JywgJyR7dGFnTmFtZX0nKTtcXG5gO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGZpbGVTdHIgPSBgLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBlY3IgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjcic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBGYWN0TmFtZSB9IGZyb20gJ2F3cy1jZGstbGliL3JlZ2lvbi1pbmZvJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgQ29udGFpbmVySW1hZ2UsIENvbnRhaW5lckltYWdlQ29uZmlnIH0gZnJvbSAnLi9jb250YWluZXItaW1hZ2UnO1xuXG5leHBvcnQgY2xhc3MgRGVlcExlYXJuaW5nQ29udGFpbmVySW1hZ2UgZXh0ZW5kcyBDb250YWluZXJJbWFnZSB7XG4ke2ltYWdlc1N0cn1cblxuICBwdWJsaWMgc3RhdGljIGZyb21EZWVwTGVhcm5pbmdDb250YWluZXJJbWFnZShcbiAgICByZXBvc2l0b3J5TmFtZTogc3RyaW5nLFxuICAgIHRhZzogc3RyaW5nLFxuICAgIGFjY291bnRJZD86IHN0cmluZyxcbiAgKTogQ29udGFpbmVySW1hZ2Uge1xuICAgIHJldHVybiBuZXcgRGVlcExlYXJuaW5nQ29udGFpbmVySW1hZ2UocmVwb3NpdG9yeU5hbWUsIHRhZywgYWNjb3VudElkKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVwb3NpdG9yeU5hbWU6IHN0cmluZyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRhZzogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWNjb3VudElkPzogc3RyaW5nLFxuICApIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVibGljIGJpbmQoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBncmFudGFibGU6IGlhbS5JR3JhbnRhYmxlLFxuICApOiBDb250YWluZXJJbWFnZUNvbmZpZyB7XG4gICAgY29uc3QgYWNjb3VudElkID1cbiAgICAgIHRoaXMuYWNjb3VudElkID8/XG4gICAgICBTdGFjay5vZihzY29wZSkucmVnaW9uYWxGYWN0KEZhY3ROYW1lLkRMQ19SRVBPU0lUT1JZX0FDQ09VTlQpO1xuXG4gICAgY29uc3QgcmVwb3NpdG9yeSA9IGVjci5SZXBvc2l0b3J5LmZyb21SZXBvc2l0b3J5QXR0cmlidXRlcyhcbiAgICAgIHNjb3BlLFxuICAgICAgJ0RlZXBMZWFybmluZ0NvbnRhaW5lclJlcG9zaXRvcnknLFxuICAgICAge1xuICAgICAgICByZXBvc2l0b3J5TmFtZTogdGhpcy5yZXBvc2l0b3J5TmFtZSxcbiAgICAgICAgcmVwb3NpdG9yeUFybjogZWNyLlJlcG9zaXRvcnkuYXJuRm9yTG9jYWxSZXBvc2l0b3J5KFxuICAgICAgICAgIHRoaXMucmVwb3NpdG9yeU5hbWUsXG4gICAgICAgICAgc2NvcGUsXG4gICAgICAgICAgYWNjb3VudElkLFxuICAgICAgICApLFxuICAgICAgfSxcbiAgICApO1xuXG4gICAgcmVwb3NpdG9yeS5ncmFudFB1bGwoZ3JhbnRhYmxlKTtcblxuICAgIHJldHVybiB7IGltYWdlTmFtZTogcmVwb3NpdG9yeS5yZXBvc2l0b3J5VXJpICsgJzonICsgdGhpcy50YWcgfTtcbiAgfVxufVxuYDtcblxuICBHZW5lcmF0ZVV0aWxzLndyaXRlRmlsZVN5bmNXaXRoRGlycyhERUVQX0xFQVJOSU5HX0NPTlRBSU5FUl9JTUFHRV9QQVRILCBmaWxlU3RyKTtcbn1cbiJdfQ==