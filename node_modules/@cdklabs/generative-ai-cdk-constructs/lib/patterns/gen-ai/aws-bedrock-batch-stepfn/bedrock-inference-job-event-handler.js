"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.BedrockInferenceJobEventHandler = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const cdk_nag_1 = require("cdk-nag");
const constructs_1 = require("constructs");
const bedrock_batch_sfn_lambda_code_1 = require("./bedrock-batch-sfn-lambda-code");
/**
 * EventBridge Rule and Lambda function which handles events from Bedrock Batch Inference Job
 * and reports success or failure to Step Functions.
 */
class BedrockInferenceJobEventHandler extends constructs_1.Construct {
    static getOrCreate(scope) {
        if (!BedrockInferenceJobEventHandler.instance) {
            const uniqueId = 'BedrockInferenceJobEventHandler330899f022e34160002006bb8b09cc5b'; // md5 sum of "BedrockInferenceJobEventHandler"
            BedrockInferenceJobEventHandler.instance = new BedrockInferenceJobEventHandler(aws_cdk_lib_1.Stack.of(scope), uniqueId);
        }
        return BedrockInferenceJobEventHandler.instance;
    }
    constructor(scope, id) {
        super(scope, id);
        const eventHandlerLambda = new aws_cdk_lib_1.aws_lambda.Function(this, 'BedrockEventHandler', {
            code: bedrock_batch_sfn_lambda_code_1.BedrockBatchSfnLambdaCode.getOrCreate(),
            handler: 'aws_bedrock_batch_sfn.bedrock_inference_job_event.handler',
            timeout: aws_cdk_lib_1.Duration.seconds(60),
            memorySize: 128,
            runtime: aws_cdk_lib_1.aws_lambda.Runtime.PYTHON_3_13,
            architecture: aws_cdk_lib_1.aws_lambda.Architecture.ARM_64,
        });
        eventHandlerLambda.addToRolePolicy(new aws_cdk_lib_1.aws_iam.PolicyStatement({
            actions: [
                'bedrock:ListTagsForResource',
                'bedrock:GetModelInvocationJob',
            ],
            resources: [
                aws_cdk_lib_1.Stack.of(this).formatArn({
                    service: 'bedrock',
                    resource: 'model-invocation-job',
                    resourceName: '*',
                }),
            ],
        }));
        eventHandlerLambda.addToRolePolicy(new aws_cdk_lib_1.aws_iam.PolicyStatement({
            actions: ['states:SendTaskSuccess', 'states:SendTaskFailure'],
            resources: ['*'],
        }));
        this.grantPrincipal = eventHandlerLambda.grantPrincipal;
        cdk_nag_1.NagSuppressions.addResourceSuppressions(eventHandlerLambda, [
            {
                id: 'AwsSolutions-IAM4',
                reason: 'Allow the use of AWS Managed Policies for Lambda execution.',
                appliesTo: [
                    'Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole',
                ],
            },
            {
                id: 'AwsSolutions-IAM5',
                reason: `Wildcards to read any object in the Bedrock Batch S3 bucket, get tags and details of any Bedrock
            batch inference jobs, and report success or failure of tasks to Step Functions which doesn't allow resource
            restriction.`,
            },
        ], true);
        new aws_cdk_lib_1.aws_events.Rule(this, 'BedrockInferenceJobEventHandler', {
            eventPattern: {
                source: ['aws.bedrock'],
                detailType: ['Batch Inference Job State Change'],
                detail: {
                    status: ['Completed', 'PartiallyCompleted', 'Failed', 'Expired', 'Stopped'],
                },
            },
            targets: [new aws_cdk_lib_1.aws_events_targets.LambdaFunction(eventHandlerLambda, {})],
        });
    }
}
exports.BedrockInferenceJobEventHandler = BedrockInferenceJobEventHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVkcm9jay1pbmZlcmVuY2Utam9iLWV2ZW50LWhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcGF0dGVybnMvZ2VuLWFpL2F3cy1iZWRyb2NrLWJhdGNoLXN0ZXBmbi9iZWRyb2NrLWluZmVyZW5jZS1qb2ItZXZlbnQtaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7OztBQUVILDZDQU9xQjtBQUNyQixxQ0FBMEM7QUFDMUMsMkNBQXVDO0FBQ3ZDLG1GQUE0RTtBQUU1RTs7O0dBR0c7QUFDSCxNQUFhLCtCQUFnQyxTQUFRLHNCQUFTO0lBQ3JELE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBZ0I7UUFDeEMsSUFBSSxDQUFDLCtCQUErQixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzlDLE1BQU0sUUFBUSxHQUFHLGlFQUFpRSxDQUFDLENBQUMsK0NBQStDO1lBQ25JLCtCQUErQixDQUFDLFFBQVEsR0FBRyxJQUFJLCtCQUErQixDQUFDLG1CQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzVHLENBQUM7UUFDRCxPQUFPLCtCQUErQixDQUFDLFFBQVEsQ0FBQztJQUNsRCxDQUFDO0lBTUQsWUFDRSxLQUFnQixFQUNoQixFQUFVO1FBRVYsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNqQixNQUFNLGtCQUFrQixHQUFHLElBQUksd0JBQU0sQ0FBQyxRQUFRLENBQzVDLElBQUksRUFDSixxQkFBcUIsRUFDckI7WUFDRSxJQUFJLEVBQUUseURBQXlCLENBQUMsV0FBVyxFQUFFO1lBQzdDLE9BQU8sRUFBRSwyREFBMkQ7WUFDcEUsT0FBTyxFQUFFLHNCQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUM3QixVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSx3QkFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1lBQ25DLFlBQVksRUFBRSx3QkFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNO1NBQ3pDLENBQ0YsQ0FBQztRQUVGLGtCQUFrQixDQUFDLGVBQWUsQ0FDaEMsSUFBSSxxQkFBRyxDQUFDLGVBQWUsQ0FBQztZQUN0QixPQUFPLEVBQUU7Z0JBQ1AsNkJBQTZCO2dCQUM3QiwrQkFBK0I7YUFDaEM7WUFDRCxTQUFTLEVBQUU7Z0JBQ1QsbUJBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDO29CQUN2QixPQUFPLEVBQUUsU0FBUztvQkFDbEIsUUFBUSxFQUFFLHNCQUFzQjtvQkFDaEMsWUFBWSxFQUFFLEdBQUc7aUJBQ2xCLENBQUM7YUFDSDtTQUNGLENBQUMsQ0FDSCxDQUFDO1FBQ0Ysa0JBQWtCLENBQUMsZUFBZSxDQUNoQyxJQUFJLHFCQUFHLENBQUMsZUFBZSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxDQUFDLHdCQUF3QixFQUFFLHdCQUF3QixDQUFDO1lBQzdELFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztTQUNqQixDQUFDLENBQ0gsQ0FBQztRQUNGLElBQUksQ0FBQyxjQUFjLEdBQUcsa0JBQWtCLENBQUMsY0FBYyxDQUFDO1FBRXhELHlCQUFlLENBQUMsdUJBQXVCLENBQ3JDLGtCQUFrQixFQUNsQjtZQUNFO2dCQUNFLEVBQUUsRUFBRSxtQkFBbUI7Z0JBQ3ZCLE1BQU0sRUFBRSw2REFBNkQ7Z0JBQ3JFLFNBQVMsRUFBRTtvQkFDVCx1RkFBdUY7aUJBQ3hGO2FBQ0Y7WUFDRDtnQkFDRSxFQUFFLEVBQUUsbUJBQW1CO2dCQUN2QixNQUFNLEVBQUU7O3lCQUVPO2FBQ2hCO1NBQ0YsRUFDRCxJQUFJLENBQ0wsQ0FBQztRQUVGLElBQUksd0JBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGlDQUFpQyxFQUFFO1lBQ3ZELFlBQVksRUFBRTtnQkFDWixNQUFNLEVBQUUsQ0FBQyxhQUFhLENBQUM7Z0JBQ3ZCLFVBQVUsRUFBRSxDQUFDLGtDQUFrQyxDQUFDO2dCQUNoRCxNQUFNLEVBQUU7b0JBQ04sTUFBTSxFQUFFLENBQUMsV0FBVyxFQUFFLG9CQUFvQixFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDO2lCQUM1RTthQUNGO1lBQ0QsT0FBTyxFQUFFLENBQUMsSUFBSSxnQ0FBTyxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUM5RCxDQUFDLENBQUM7SUFDTCxDQUFDO0NBR0Y7QUF2RkQsMEVBdUZDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHtcbiAgYXdzX2V2ZW50cyBhcyBldmVudHMsXG4gIGF3c19ldmVudHNfdGFyZ2V0cyBhcyB0YXJnZXRzLFxuICBhd3NfaWFtIGFzIGlhbSxcbiAgYXdzX2xhbWJkYSBhcyBsYW1iZGEsXG4gIER1cmF0aW9uLFxuICBTdGFjayxcbn0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgTmFnU3VwcHJlc3Npb25zIH0gZnJvbSAnY2RrLW5hZyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IEJlZHJvY2tCYXRjaFNmbkxhbWJkYUNvZGUgfSBmcm9tICcuL2JlZHJvY2stYmF0Y2gtc2ZuLWxhbWJkYS1jb2RlJztcblxuLyoqXG4gKiBFdmVudEJyaWRnZSBSdWxlIGFuZCBMYW1iZGEgZnVuY3Rpb24gd2hpY2ggaGFuZGxlcyBldmVudHMgZnJvbSBCZWRyb2NrIEJhdGNoIEluZmVyZW5jZSBKb2JcbiAqIGFuZCByZXBvcnRzIHN1Y2Nlc3Mgb3IgZmFpbHVyZSB0byBTdGVwIEZ1bmN0aW9ucy5cbiAqL1xuZXhwb3J0IGNsYXNzIEJlZHJvY2tJbmZlcmVuY2VKb2JFdmVudEhhbmRsZXIgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBpYW0uSUdyYW50YWJsZSB7XG4gIHB1YmxpYyBzdGF0aWMgZ2V0T3JDcmVhdGUoc2NvcGU6IENvbnN0cnVjdCk6IEJlZHJvY2tJbmZlcmVuY2VKb2JFdmVudEhhbmRsZXIge1xuICAgIGlmICghQmVkcm9ja0luZmVyZW5jZUpvYkV2ZW50SGFuZGxlci5pbnN0YW5jZSkge1xuICAgICAgY29uc3QgdW5pcXVlSWQgPSAnQmVkcm9ja0luZmVyZW5jZUpvYkV2ZW50SGFuZGxlcjMzMDg5OWYwMjJlMzQxNjAwMDIwMDZiYjhiMDljYzViJzsgLy8gbWQ1IHN1bSBvZiBcIkJlZHJvY2tJbmZlcmVuY2VKb2JFdmVudEhhbmRsZXJcIlxuICAgICAgQmVkcm9ja0luZmVyZW5jZUpvYkV2ZW50SGFuZGxlci5pbnN0YW5jZSA9IG5ldyBCZWRyb2NrSW5mZXJlbmNlSm9iRXZlbnRIYW5kbGVyKFN0YWNrLm9mKHNjb3BlKSwgdW5pcXVlSWQpO1xuICAgIH1cbiAgICByZXR1cm4gQmVkcm9ja0luZmVyZW5jZUpvYkV2ZW50SGFuZGxlci5pbnN0YW5jZTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBCZWRyb2NrSW5mZXJlbmNlSm9iRXZlbnRIYW5kbGVyO1xuXG4gIHB1YmxpYyByZWFkb25seSBncmFudFByaW5jaXBhbDogaWFtLklQcmluY2lwYWw7XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG4gICAgY29uc3QgZXZlbnRIYW5kbGVyTGFtYmRhID0gbmV3IGxhbWJkYS5GdW5jdGlvbihcbiAgICAgIHRoaXMsXG4gICAgICAnQmVkcm9ja0V2ZW50SGFuZGxlcicsXG4gICAgICB7XG4gICAgICAgIGNvZGU6IEJlZHJvY2tCYXRjaFNmbkxhbWJkYUNvZGUuZ2V0T3JDcmVhdGUoKSxcbiAgICAgICAgaGFuZGxlcjogJ2F3c19iZWRyb2NrX2JhdGNoX3Nmbi5iZWRyb2NrX2luZmVyZW5jZV9qb2JfZXZlbnQuaGFuZGxlcicsXG4gICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMoNjApLFxuICAgICAgICBtZW1vcnlTaXplOiAxMjgsXG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzEzLFxuICAgICAgICBhcmNoaXRlY3R1cmU6IGxhbWJkYS5BcmNoaXRlY3R1cmUuQVJNXzY0LFxuICAgICAgfSxcbiAgICApO1xuXG4gICAgZXZlbnRIYW5kbGVyTGFtYmRhLmFkZFRvUm9sZVBvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICdiZWRyb2NrOkxpc3RUYWdzRm9yUmVzb3VyY2UnLFxuICAgICAgICAgICdiZWRyb2NrOkdldE1vZGVsSW52b2NhdGlvbkpvYicsXG4gICAgICAgIF0sXG4gICAgICAgIHJlc291cmNlczogW1xuICAgICAgICAgIFN0YWNrLm9mKHRoaXMpLmZvcm1hdEFybih7XG4gICAgICAgICAgICBzZXJ2aWNlOiAnYmVkcm9jaycsXG4gICAgICAgICAgICByZXNvdXJjZTogJ21vZGVsLWludm9jYXRpb24tam9iJyxcbiAgICAgICAgICAgIHJlc291cmNlTmFtZTogJyonLFxuICAgICAgICAgIH0pLFxuICAgICAgICBdLFxuICAgICAgfSksXG4gICAgKTtcbiAgICBldmVudEhhbmRsZXJMYW1iZGEuYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBhY3Rpb25zOiBbJ3N0YXRlczpTZW5kVGFza1N1Y2Nlc3MnLCAnc3RhdGVzOlNlbmRUYXNrRmFpbHVyZSddLFxuICAgICAgICByZXNvdXJjZXM6IFsnKiddLFxuICAgICAgfSksXG4gICAgKTtcbiAgICB0aGlzLmdyYW50UHJpbmNpcGFsID0gZXZlbnRIYW5kbGVyTGFtYmRhLmdyYW50UHJpbmNpcGFsO1xuXG4gICAgTmFnU3VwcHJlc3Npb25zLmFkZFJlc291cmNlU3VwcHJlc3Npb25zKFxuICAgICAgZXZlbnRIYW5kbGVyTGFtYmRhLFxuICAgICAgW1xuICAgICAgICB7XG4gICAgICAgICAgaWQ6ICdBd3NTb2x1dGlvbnMtSUFNNCcsXG4gICAgICAgICAgcmVhc29uOiAnQWxsb3cgdGhlIHVzZSBvZiBBV1MgTWFuYWdlZCBQb2xpY2llcyBmb3IgTGFtYmRhIGV4ZWN1dGlvbi4nLFxuICAgICAgICAgIGFwcGxpZXNUbzogW1xuICAgICAgICAgICAgJ1BvbGljeTo6YXJuOjxBV1M6OlBhcnRpdGlvbj46aWFtOjphd3M6cG9saWN5L3NlcnZpY2Utcm9sZS9BV1NMYW1iZGFCYXNpY0V4ZWN1dGlvblJvbGUnLFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogJ0F3c1NvbHV0aW9ucy1JQU01JyxcbiAgICAgICAgICByZWFzb246IGBXaWxkY2FyZHMgdG8gcmVhZCBhbnkgb2JqZWN0IGluIHRoZSBCZWRyb2NrIEJhdGNoIFMzIGJ1Y2tldCwgZ2V0IHRhZ3MgYW5kIGRldGFpbHMgb2YgYW55IEJlZHJvY2tcbiAgICAgICAgICAgIGJhdGNoIGluZmVyZW5jZSBqb2JzLCBhbmQgcmVwb3J0IHN1Y2Nlc3Mgb3IgZmFpbHVyZSBvZiB0YXNrcyB0byBTdGVwIEZ1bmN0aW9ucyB3aGljaCBkb2Vzbid0IGFsbG93IHJlc291cmNlXG4gICAgICAgICAgICByZXN0cmljdGlvbi5gLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIHRydWUsXG4gICAgKTtcblxuICAgIG5ldyBldmVudHMuUnVsZSh0aGlzLCAnQmVkcm9ja0luZmVyZW5jZUpvYkV2ZW50SGFuZGxlcicsIHtcbiAgICAgIGV2ZW50UGF0dGVybjoge1xuICAgICAgICBzb3VyY2U6IFsnYXdzLmJlZHJvY2snXSxcbiAgICAgICAgZGV0YWlsVHlwZTogWydCYXRjaCBJbmZlcmVuY2UgSm9iIFN0YXRlIENoYW5nZSddLFxuICAgICAgICBkZXRhaWw6IHtcbiAgICAgICAgICBzdGF0dXM6IFsnQ29tcGxldGVkJywgJ1BhcnRpYWxseUNvbXBsZXRlZCcsICdGYWlsZWQnLCAnRXhwaXJlZCcsICdTdG9wcGVkJ10sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgdGFyZ2V0czogW25ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGV2ZW50SGFuZGxlckxhbWJkYSwge30pXSxcbiAgICB9KTtcbiAgfVxuXG5cbn0iXX0=