"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BedrockBatchSfn = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const aws_cdk_lib_1 = require("aws-cdk-lib");
const cdk_nag_1 = require("cdk-nag");
const bedrock_inference_job_event_handler_1 = require("./bedrock-inference-job-event-handler");
const create_model_invocation_job_function_1 = require("./create-model-invocation-job-function");
/**
 * A state machine fragment that creates a Bedrock Batch Inference Job and waits for its completion.
 *
 * Input schema:
 * ```
 * {
 *   "job_name": string,        // Required. Name of the batch inference job
 *   "manifest_keys": string[],    // Required. List of S3 keys of the input manifest files
 *   "model_id": string        // Required. Model ID to use.
 * }
 * ```
 *
 * Output schema:
 * ```
 * {
 *   "status": string,        // Required. Status of the batch job. One of: "Completed" or "PartiallyCompleted"
 *   "bucket": string,        // Required. S3 bucket where the output is stored
 *   "keys": string[]         // Required. Array of S3 keys for the output files
 * }
 * ```
 *
 * Error schema:
 * ```
 * {
 *   "status": string,        // Required. Status will be one of: "Failed", "Stopped", or "Expired"
 *   "error": string,         // Required. Error code
 *   "cause": string          // Required. Error message
 * }
 * ```
 */
class BedrockBatchSfn extends aws_cdk_lib_1.aws_stepfunctions.StateMachineFragment {
    constructor(parent, id, props) {
        super(parent, id);
        if (props.timeout && (props.timeout.toHours() < 24 || props.timeout.toHours() > 168)) {
            throw new Error('Timeout must be between 24 hours and 1 week (168 hours).');
        }
        const batchJobEventHandler = bedrock_inference_job_event_handler_1.BedrockInferenceJobEventHandler.getOrCreate(this);
        props.bedrockBatchOutputBucket.grantRead(batchJobEventHandler);
        const bedrockBatchRole = new aws_cdk_lib_1.aws_iam.Role(this, 'BedrockBatchRole', {
            assumedBy: new aws_cdk_lib_1.aws_iam.ServicePrincipal('bedrock.amazonaws.com'),
        });
        let bedrockBatchPolicy;
        if (props.bedrockBatchPolicy) {
            bedrockBatchRole.addManagedPolicy(props.bedrockBatchPolicy);
            bedrockBatchPolicy = props.bedrockBatchPolicy;
        }
        else {
            bedrockBatchPolicy = new aws_cdk_lib_1.aws_iam.ManagedPolicy(this, 'BedrockBatchPolicy', {
                statements: [
                    new aws_cdk_lib_1.aws_iam.PolicyStatement({
                        sid: 'Inference',
                        actions: ['bedrock:InvokeModel', 'bedrock:CreateModelInvocationJob'],
                        resources: [
                            'arn:aws:bedrock:*::foundation-model/*',
                            aws_cdk_lib_1.Stack.of(this).formatArn({
                                service: 'bedrock',
                                resource: 'inference-profile',
                                resourceName: '*',
                            }),
                        ],
                    }),
                ],
            });
            if (bedrockBatchPolicy instanceof aws_cdk_lib_1.aws_iam.ManagedPolicy) {
                cdk_nag_1.NagSuppressions.addResourceSuppressions(bedrockBatchPolicy, [
                    {
                        id: 'AwsSolutions-IAM5',
                        reason: 'Wildcards allow Bedrock inference and model invocation jobs.',
                    },
                ], true);
            }
            bedrockBatchRole.addManagedPolicy(bedrockBatchPolicy);
        }
        bedrockBatchRole.assumeRolePolicy?.addStatements(new aws_cdk_lib_1.aws_iam.PolicyStatement({
            principals: [new aws_cdk_lib_1.aws_iam.ServicePrincipal('bedrock.amazonaws.com')],
            actions: ['sts:AssumeRole'],
            conditions: {
                StringEquals: {
                    'aws:SourceAccount': aws_cdk_lib_1.Stack.of(this).account,
                },
                ArnLike: {
                    'aws:SourceArn': aws_cdk_lib_1.Stack.of(this).formatArn({
                        service: 'bedrock',
                        resource: 'model-invocation-job',
                        resourceName: '*',
                    }),
                },
            },
        }));
        props.bedrockBatchInputBucket.grantRead(bedrockBatchRole);
        props.bedrockBatchOutputBucket.grantReadWrite(bedrockBatchRole);
        cdk_nag_1.NagSuppressions.addResourceSuppressions(this, [
            {
                id: 'AwsSolutions-IAM5',
                reason: 'This role has wildcards so any Bedrock model invocation job can work with any bedrock foundation model ' +
                    'and read and write any object in a specific S3 bucket.',
            },
        ], true);
        const createModelInvocationJobFunction = new create_model_invocation_job_function_1.CreateModelInvocationJobFunction(this, 'CreateModelInvocationJobFunction', {
            bedrockBatchPolicy: bedrockBatchPolicy,
        });
        bedrockBatchRole.grantPassRole(createModelInvocationJobFunction.role);
        const createModelInvocationJobTask = new aws_cdk_lib_1.aws_stepfunctions_tasks.LambdaInvoke(this, 'CreateModelInvocationJobTask', {
            lambdaFunction: createModelInvocationJobFunction,
            integrationPattern: aws_cdk_lib_1.aws_stepfunctions.IntegrationPattern.WAIT_FOR_TASK_TOKEN,
            heartbeatTimeout: aws_cdk_lib_1.aws_stepfunctions.Timeout.duration(props.timeout ? props.timeout : aws_cdk_lib_1.Duration.hours(48)),
            payload: aws_cdk_lib_1.aws_stepfunctions.TaskInput.fromObject({
                jobName: aws_cdk_lib_1.aws_stepfunctions.JsonPath.format('{}{}', aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$.job_name'), aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$.index')),
                roleArn: bedrockBatchRole.roleArn,
                modelId: aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$.model_id'),
                inputDataConfig: {
                    s3InputDataConfig: {
                        s3Uri: aws_cdk_lib_1.aws_stepfunctions.JsonPath.format('s3://' + props.bedrockBatchInputBucket.bucketName + '/{}', aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$.manifest_key')),
                    },
                },
                outputDataConfig: {
                    s3OutputDataConfig: {
                        s3Uri: aws_cdk_lib_1.aws_stepfunctions.JsonPath.format('s3://' + props.bedrockBatchOutputBucket.bucketName + '/output/{}/', aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$.job_name')),
                    },
                },
                timeoutDurationInHours: props.timeout ? props.timeout.toHours() : 48,
                TaskToken: aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$$.Task.Token'),
            }),
        });
        const batchEvaluateMap = new aws_cdk_lib_1.aws_stepfunctions.Map(this, 'BatchEvaluateMap', {
            inputPath: props.inputPath,
            itemsPath: aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$.manifest_keys'),
            itemSelector: {
                job_name: aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$.job_name'),
                model_id: aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$.model_id'),
                index: aws_cdk_lib_1.aws_stepfunctions.JsonPath.numberAt('$$.Map.Item.Index'),
                manifest_key: aws_cdk_lib_1.aws_stepfunctions.JsonPath.stringAt('$$.Map.Item.Value'),
            },
            resultPath: props.resultPath,
        });
        batchEvaluateMap.itemProcessor(createModelInvocationJobTask);
        this.startState = batchEvaluateMap;
        this.endStates = batchEvaluateMap.endStates;
    }
}
exports.BedrockBatchSfn = BedrockBatchSfn;
_a = JSII_RTTI_SYMBOL_1;
BedrockBatchSfn[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.BedrockBatchSfn", version: "0.1.309" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcGF0dGVybnMvZ2VuLWFpL2F3cy1iZWRyb2NrLWJhdGNoLXN0ZXBmbi9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBOzs7Ozs7Ozs7OztHQVdHO0FBRUgsNkNBT3FCO0FBQ3JCLHFDQUEwQztBQUUxQywrRkFBd0Y7QUFDeEYsaUdBQTBGO0FBK0UxRjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0E2Qkc7QUFDSCxNQUFhLGVBQWdCLFNBQVEsK0JBQUcsQ0FBQyxvQkFBb0I7SUFJM0QsWUFBWSxNQUFpQixFQUFFLEVBQVUsRUFBRSxLQUEyQjtRQUNwRSxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWxCLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNyRixNQUFNLElBQUksS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7UUFDOUUsQ0FBQztRQUVELE1BQU0sb0JBQW9CLEdBQUcscUVBQStCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9FLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUUvRCxNQUFNLGdCQUFnQixHQUFHLElBQUkscUJBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGtCQUFrQixFQUFFO1lBQzlELFNBQVMsRUFBRSxJQUFJLHFCQUFHLENBQUMsZ0JBQWdCLENBQUMsdUJBQXVCLENBQUM7U0FDN0QsQ0FBQyxDQUFDO1FBRUgsSUFBSSxrQkFBc0MsQ0FBQztRQUMzQyxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQzdCLGdC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Q0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDO2FBQ2xELENBQUM7U0FDSCxDQUNGLENBQUM7UUFFRixNQUFNLGdCQUFnQixHQUFHLElBQUksK0JBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLGtCQUFrQixFQUFFO1lBQzdELFNBQVMsRUFBRSxLQUFLLENBQUMsU0FBUztZQUMxQixTQUFTLEVBQUUsK0JBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDO1lBQ25ELFlBQVksRUFBRTtnQkFDWixRQUFRLEVBQUUsK0JBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztnQkFDN0MsUUFBUSxFQUFFLCtCQUFHLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUM7Z0JBQzdDLEtBQUssRUFBRSwrQkFBRyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUM7Z0JBQ2pELFlBQVksRUFBRSwrQkFBRyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUM7YUFDekQ7WUFDRCxVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVU7U0FDN0IsQ0FBQyxDQUFDO1FBQ0gsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFFN0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxnQkFBZ0IsQ0FBQztRQUNuQyxJQUFJLENBQUMsU0FBUyxHQUFHLGdCQUFnQixDQUFDLFNBQVMsQ0FBQztJQUU5QyxDQUFDOztBQTNKSCwwQ0E0SkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICBhd3NfaWFtIGFzIGlhbSxcbiAgYXdzX3MzIGFzIHMzLFxuICBhd3Nfc3RlcGZ1bmN0aW9ucyBhcyBzZm4sXG4gIGF3c19zdGVwZnVuY3Rpb25zX3Rhc2tzIGFzIHRhc2tzLFxuICBEdXJhdGlvbixcbiAgU3RhY2ssXG59IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IE5hZ1N1cHByZXNzaW9ucyB9IGZyb20gJ2Nkay1uYWcnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBCZWRyb2NrSW5mZXJlbmNlSm9iRXZlbnRIYW5kbGVyIH0gZnJvbSAnLi9iZWRyb2NrLWluZmVyZW5jZS1qb2ItZXZlbnQtaGFuZGxlcic7XG5pbXBvcnQgeyBDcmVhdGVNb2RlbEludm9jYXRpb25Kb2JGdW5jdGlvbiB9IGZyb20gJy4vY3JlYXRlLW1vZGVsLWludm9jYXRpb24tam9iLWZ1bmN0aW9uJztcblxuXG5leHBvcnQgaW50ZXJmYWNlIEJlZHJvY2tCYXRjaFNmblByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBTMyBidWNrZXQgd2hlcmUgdGhlIEJlZHJvY2sgQmF0Y2ggSW5mZXJlbmNlIEpvYiBnZXRzIHRoZSBpbnB1dCBtYW5pZmVzdHMuXG4gICAqL1xuICByZWFkb25seSBiZWRyb2NrQmF0Y2hJbnB1dEJ1Y2tldDogczMuSUJ1Y2tldDtcbiAgLyoqXG4gICAqIFRoZSBTMyBidWNrZXQgd2hlcmUgdGhlIEJlZHJvY2sgQmF0Y2ggSW5mZXJlbmNlIEpvYiBzdG9yZXMgdGhlIG91dHB1dC5cbiAgICovXG4gIHJlYWRvbmx5IGJlZHJvY2tCYXRjaE91dHB1dEJ1Y2tldDogczMuSUJ1Y2tldDtcbiAgLyoqXG4gICAqIElBTSBwb2xpY3kgdXNlZCBmb3IgQmVkcm9jayBiYXRjaCBwcm9jZXNzaW5nXG4gICAqXG4gICAqIFRoZSBwb2xpY3kgbXVzdCBoYXZlIHRoZSBmb2xsb3dpbmcgcGVybWlzc2lvbnMgZm9yIHRoZSBtb2RlbHMgYW5kIGluZmVyZW5jZSBwcm9maWxlcyB5b3UgcGxhbiB0byB1c2U6XG4gICAqIC0gYmVkcm9jazpJbnZva2VNb2RlbFxuICAgKiAtIGJlZHJvY2s6Q3JlYXRlTW9kZWxJbnZvY2F0aW9uSm9iXG4gICAqXG4gICAqIEBkZWZhdWx0XG4gICAqIGNvbnN0IGJlZHJvY2tCYXRjaFBvbGljeSA9IG5ldyBpYW0uTWFuYWdlZFBvbGljeSh0aGlzLCAnQmVkcm9ja0JhdGNoUG9saWN5Jywge1xuICAgKiAgICAgICAgIHN0YXRlbWVudHM6IFtcbiAgICogICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICogICAgICAgICAgICAgc2lkOiAnSW5mZXJlbmNlJyxcbiAgICogICAgICAgICAgICAgYWN0aW9uczogWydiZWRyb2NrOkludm9rZU1vZGVsJywgJ2JlZHJvY2s6Q3JlYXRlTW9kZWxJbnZvY2F0aW9uSm9iJ10sXG4gICAqICAgICAgICAgICAgIHJlc291cmNlczogW1xuICAgKiAgICAgICAgICAgICAgICdhcm46YXdzOmJlZHJvY2s6Kjo6Zm91bmRhdGlvbi1tb2RlbC8qJyxcbiAgICogICAgICAgICAgICAgICBTdGFjay5vZih0aGlzKS5mb3JtYXRBcm4oe1xuICAgKiAgICAgICAgICAgICAgICAgc2VydmljZTogJ2JlZHJvY2snLFxuICAgKiAgICAgICAgICAgICAgICAgcmVzb3VyY2U6ICdpbmZlcmVuY2UtcHJvZmlsZScsXG4gICAqICAgICAgICAgICAgICAgICByZXNvdXJjZU5hbWU6ICcqJyxcbiAgICogICAgICAgICAgICAgICB9KSxcbiAgICogICAgICAgICAgICAgXSxcbiAgICogICAgICAgICAgIH0pLFxuICAgKiAgICAgICAgIF0sXG4gICAqICAgICAgIH0pO1xuICAgKi9cbiAgcmVhZG9ubHkgYmVkcm9ja0JhdGNoUG9saWN5PzogaWFtLklNYW5hZ2VkUG9saWN5O1xuICAvKipcbiAgICogVGhlIHRpbWVvdXQgZHVyYXRpb24gZm9yIHRoZSBiYXRjaCBpbmZlcmVuY2Ugam9iLlxuICAgKiBNdXN0IGJlIGJldHdlZW4gMjQgaG91cnMgYW5kIDEgd2VlayAoMTY4IGhvdXJzKS5cbiAgICpcbiAgICogQGRlZmF1bHQgRHVyYXRpb24uaG91cnMoNDgpXG4gICAqL1xuICByZWFkb25seSB0aW1lb3V0PzogRHVyYXRpb247XG4gIC8qKlxuICAgKiBKU09OUGF0aCBleHByZXNzaW9uIHRvIHNlbGVjdCBwYXJ0IG9mIHRoZSBzdGF0ZSB0byBiZSB0aGUgaW5wdXQgdG8gdGhpcyBzdGF0ZS5cbiAgICogTWF5IGFsc28gYmUgdGhlIHNwZWNpYWwgdmFsdWUgSnNvblBhdGguIERJU0NBUkQsIHdoaWNoIHdpbGwgY2F1c2UgdGhlIGVmZmVjdGl2ZSBpbnB1dCB0byBiZSB0aGUgZW1wdHkgb2JqZWN0IHt9LlxuICAgKlxuICAgKiBJbnB1dCBzY2hlbWE6XG4gICAqIGBgYFxuICAgKiB7XG4gICAqICAgXCJqb2JfbmFtZVwiOiBzdHJpbmcsICAgICAgICAvLyBSZXF1aXJlZC4gTmFtZSBvZiB0aGUgYmF0Y2ggaW5mZXJlbmNlIGpvYlxuICAgKiAgIFwibWFuaWZlc3Rfa2V5c1wiOiBzdHJpbmdbXSwgICAgLy8gUmVxdWlyZWQuIExpc3Qgb2YgUzMga2V5cyBvZiB0aGUgaW5wdXQgbWFuaWZlc3QgZmlsZXNcbiAgICogICBcIm1vZGVsX2lkXCI6IHN0cmluZyAgICAgICAgLy8gUmVxdWlyZWQuIE1vZGVsIElEIHRvIHVzZS5cbiAgICogfVxuICAgKiBgYGBcbiAgICpcbiAgICogQGRlZmF1bHQgVGhlIGVudGlyZSB0YXNrIGlucHV0IChKU09OIHBhdGggJyQnKVxuICAgKi9cbiAgcmVhZG9ubHkgaW5wdXRQYXRoPzogc3RyaW5nO1xuICAvKipcbiAgICogSlNPTlBhdGggZXhwcmVzc2lvbiB0byBpbmRpY2F0ZSB3aGVyZSB0byBpbmplY3QgdGhlIHN0YXRlJ3Mgb3V0cHV0XG4gICAqIE1heSBhbHNvIGJlIHRoZSBzcGVjaWFsIHZhbHVlIEpzb25QYXRoLiBESVNDQVJELCB3aGljaCB3aWxsIGNhdXNlIHRoZSBzdGF0ZSdzIGlucHV0IHRvIGJlY29tZSBpdHMgb3V0cHV0LlxuICAgKlxuICAgKiBPdXRwdXQgc2NoZW1hOlxuICAgKiBgYGBcbiAgICoge1xuICAgKiAgIFwic3RhdHVzXCI6IHN0cmluZywgICAgICAgIC8vIFJlcXVpcmVkLiBTdGF0dXMgb2YgdGhlIGJhdGNoIGpvYi4gT25lIG9mOiBcIkNvbXBsZXRlZFwiIG9yIFwiUGFydGlhbGx5Q29tcGxldGVkXCJcbiAgICogICBcImJ1Y2tldFwiOiBzdHJpbmcsICAgICAgICAvLyBSZXF1aXJlZC4gUzMgYnVja2V0IHdoZXJlIHRoZSBvdXRwdXQgaXMgc3RvcmVkXG4gICAqICAgXCJrZXlzXCI6IHN0cmluZ1tdICAgICAgICAgLy8gUmVxdWlyZWQuIEFycmF5IG9mIFMzIGtleXMgZm9yIHRoZSBvdXRwdXQgZmlsZXNcbiAgICogfVxuICAgKiBgYGBcbiAgICpcbiAgICogQGRlZmF1bHQgUmVwbGFjZXMgdGhlIGVudGlyZSBpbnB1dCB3aXRoIHRoZSByZXN1bHQgKEpTT04gcGF0aCAnJCcpXG4gICAqL1xuICByZWFkb25seSByZXN1bHRQYXRoPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIEEgc3RhdGUgbWFjaGluZSBmcmFnbWVudCB0aGF0IGNyZWF0ZXMgYSBCZWRyb2NrIEJhdGNoIEluZmVyZW5jZSBKb2IgYW5kIHdhaXRzIGZvciBpdHMgY29tcGxldGlvbi5cbiAqXG4gKiBJbnB1dCBzY2hlbWE6XG4gKiBgYGBcbiAqIHtcbiAqICAgXCJqb2JfbmFtZVwiOiBzdHJpbmcsICAgICAgICAvLyBSZXF1aXJlZC4gTmFtZSBvZiB0aGUgYmF0Y2ggaW5mZXJlbmNlIGpvYlxuICogICBcIm1hbmlmZXN0X2tleXNcIjogc3RyaW5nW10sICAgIC8vIFJlcXVpcmVkLiBMaXN0IG9mIFMzIGtleXMgb2YgdGhlIGlucHV0IG1hbmlmZXN0IGZpbGVzXG4gKiAgIFwibW9kZWxfaWRcIjogc3RyaW5nICAgICAgICAvLyBSZXF1aXJlZC4gTW9kZWwgSUQgdG8gdXNlLlxuICogfVxuICogYGBgXG4gKlxuICogT3V0cHV0IHNjaGVtYTpcbiAqIGBgYFxuICoge1xuICogICBcInN0YXR1c1wiOiBzdHJpbmcsICAgICAgICAvLyBSZXF1aXJlZC4gU3RhdHVzIG9mIHRoZSBiYXRjaCBqb2IuIE9uZSBvZjogXCJDb21wbGV0ZWRcIiBvciBcIlBhcnRpYWxseUNvbXBsZXRlZFwiXG4gKiAgIFwiYnVja2V0XCI6IHN0cmluZywgICAgICAgIC8vIFJlcXVpcmVkLiBTMyBidWNrZXQgd2hlcmUgdGhlIG91dHB1dCBpcyBzdG9yZWRcbiAqICAgXCJrZXlzXCI6IHN0cmluZ1tdICAgICAgICAgLy8gUmVxdWlyZWQuIEFycmF5IG9mIFMzIGtleXMgZm9yIHRoZSBvdXRwdXQgZmlsZXNcbiAqIH1cbiAqIGBgYFxuICpcbiAqIEVycm9yIHNjaGVtYTpcbiAqIGBgYFxuICoge1xuICogICBcInN0YXR1c1wiOiBzdHJpbmcsICAgICAgICAvLyBSZXF1aXJlZC4gU3RhdHVzIHdpbGwgYmUgb25lIG9mOiBcIkZhaWxlZFwiLCBcIlN0b3BwZWRcIiwgb3IgXCJFeHBpcmVkXCJcbiAqICAgXCJlcnJvclwiOiBzdHJpbmcsICAgICAgICAgLy8gUmVxdWlyZWQuIEVycm9yIGNvZGVcbiAqICAgXCJjYXVzZVwiOiBzdHJpbmcgICAgICAgICAgLy8gUmVxdWlyZWQuIEVycm9yIG1lc3NhZ2VcbiAqIH1cbiAqIGBgYFxuICovXG5leHBvcnQgY2xhc3MgQmVkcm9ja0JhdGNoU2ZuIGV4dGVuZHMgc2ZuLlN0YXRlTWFjaGluZUZyYWdtZW50IHtcbiAgcmVhZG9ubHkgZW5kU3RhdGVzOiBzZm4uSU5leHRhYmxlW107XG4gIHJlYWRvbmx5IHN0YXJ0U3RhdGU6IHNmbi5TdGF0ZTtcblxuICBjb25zdHJ1Y3RvcihwYXJlbnQ6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEJlZHJvY2tCYXRjaFNmblByb3BzKSB7XG4gICAgc3VwZXIocGFyZW50LCBpZCk7XG5cbiAgICBpZiAocHJvcHMudGltZW91dCAmJiAocHJvcHMudGltZW91dC50b0hvdXJzKCkgPCAyNCB8fCBwcm9wcy50aW1lb3V0LnRvSG91cnMoKSA+IDE2OCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGltZW91dCBtdXN0IGJlIGJldHdlZW4gMjQgaG91cnMgYW5kIDEgd2VlayAoMTY4IGhvdXJzKS4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBiYXRjaEpvYkV2ZW50SGFuZGxlciA9IEJlZHJvY2tJbmZlcmVuY2VKb2JFdmVudEhhbmRsZXIuZ2V0T3JDcmVhdGUodGhpcyk7XG4gICAgcHJvcHMuYmVkcm9ja0JhdGNoT3V0cHV0QnVja2V0LmdyYW50UmVhZChiYXRjaEpvYkV2ZW50SGFuZGxlcik7XG5cbiAgICBjb25zdCBiZWRyb2NrQmF0Y2hSb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsICdCZWRyb2NrQmF0Y2hSb2xlJywge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2JlZHJvY2suYW1hem9uYXdzLmNvbScpLFxuICAgIH0pO1xuXG4gICAgbGV0IGJlZHJvY2tCYXRjaFBvbGljeTogaWFtLklNYW5hZ2VkUG9saWN5O1xuICAgIGlmIChwcm9wcy5iZWRyb2NrQmF0Y2hQb2xpY3kpIHtcbiAgICAgIGJlZHJvY2tCYXRjaFJvbGUuYWRkTWFuYWdlZFBvbGljeShwcm9wcy5iZWRyb2NrQmF0Y2hQb2xpY3kpO1xuICAgICAgYmVkcm9ja0JhdGNoUG9saWN5ID0gcHJvcHMuYmVkcm9ja0JhdGNoUG9saWN5O1xuICAgIH0gZWxzZSB7XG4gICAgICBiZWRyb2NrQmF0Y2hQb2xpY3kgPSBuZXcgaWFtLk1hbmFnZWRQb2xpY3kodGhpcywgJ0JlZHJvY2tCYXRjaFBvbGljeScsIHtcbiAgICAgICAgc3RhdGVtZW50czogW1xuICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIHNpZDogJ0luZmVyZW5jZScsXG4gICAgICAgICAgICBhY3Rpb25zOiBbJ2JlZHJvY2s6SW52b2tlTW9kZWwnLCAnYmVkcm9jazpDcmVhdGVNb2RlbEludm9jYXRpb25Kb2InXSxcbiAgICAgICAgICAgIHJlc291cmNlczogW1xuICAgICAgICAgICAgICAnYXJuOmF3czpiZWRyb2NrOio6OmZvdW5kYXRpb24tbW9kZWwvKicsXG4gICAgICAgICAgICAgIFN0YWNrLm9mKHRoaXMpLmZvcm1hdEFybih7XG4gICAgICAgICAgICAgICAgc2VydmljZTogJ2JlZHJvY2snLFxuICAgICAgICAgICAgICAgIHJlc291cmNlOiAnaW5mZXJlbmNlLXByb2ZpbGUnLFxuICAgICAgICAgICAgICAgIHJlc291cmNlTmFtZTogJyonLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSksXG4gICAgICAgIF0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGJlZHJvY2tCYXRjaFBvbGljeSBpbnN0YW5jZW9mIGlhbS5NYW5hZ2VkUG9saWN5KSB7XG4gICAgICAgIE5hZ1N1cHByZXNzaW9ucy5hZGRSZXNvdXJjZVN1cHByZXNzaW9ucyhcbiAgICAgICAgICBiZWRyb2NrQmF0Y2hQb2xpY3ksXG4gICAgICAgICAgW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBpZDogJ0F3c1NvbHV0aW9ucy1JQU01JyxcbiAgICAgICAgICAgICAgcmVhc29uOiAnV2lsZGNhcmRzIGFsbG93IEJlZHJvY2sgaW5mZXJlbmNlIGFuZCBtb2RlbCBpbnZvY2F0aW9uIGpvYnMuJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgICB0cnVlLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgYmVkcm9ja0JhdGNoUm9sZS5hZGRNYW5hZ2VkUG9saWN5KGJlZHJvY2tCYXRjaFBvbGljeSk7XG5cblxuICAgIH1cblxuICAgIGJlZHJvY2tCYXRjaFJvbGUuYXNzdW1lUm9sZVBvbGljeT8uYWRkU3RhdGVtZW50cyhcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgcHJpbmNpcGFsczogW25ldyBpYW0uU2VydmljZVByaW5jaXBhbCgnYmVkcm9jay5hbWF6b25hd3MuY29tJyldLFxuICAgICAgICBhY3Rpb25zOiBbJ3N0czpBc3N1bWVSb2xlJ10sXG4gICAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgICdhd3M6U291cmNlQWNjb3VudCc6IFN0YWNrLm9mKHRoaXMpLmFjY291bnQsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBBcm5MaWtlOiB7XG4gICAgICAgICAgICAnYXdzOlNvdXJjZUFybic6IFN0YWNrLm9mKHRoaXMpLmZvcm1hdEFybih7XG4gICAgICAgICAgICAgIHNlcnZpY2U6ICdiZWRyb2NrJyxcbiAgICAgICAgICAgICAgcmVzb3VyY2U6ICdtb2RlbC1pbnZvY2F0aW9uLWpvYicsXG4gICAgICAgICAgICAgIHJlc291cmNlTmFtZTogJyonLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBwcm9wcy5iZWRyb2NrQmF0Y2hJbnB1dEJ1Y2tldC5ncmFudFJlYWQoYmVkcm9ja0JhdGNoUm9sZSk7XG4gICAgcHJvcHMuYmVkcm9ja0JhdGNoT3V0cHV0QnVja2V0LmdyYW50UmVhZFdyaXRlKGJlZHJvY2tCYXRjaFJvbGUpO1xuXG4gICAgTmFnU3VwcHJlc3Npb25zLmFkZFJlc291cmNlU3VwcHJlc3Npb25zKFxuICAgICAgdGhpcyxcbiAgICAgIFtcbiAgICAgICAge1xuICAgICAgICAgIGlkOiAnQXdzU29sdXRpb25zLUlBTTUnLFxuICAgICAgICAgIHJlYXNvbjpcbiAgICAgICAgICAgICdUaGlzIHJvbGUgaGFzIHdpbGRjYXJkcyBzbyBhbnkgQmVkcm9jayBtb2RlbCBpbnZvY2F0aW9uIGpvYiBjYW4gd29yayB3aXRoIGFueSBiZWRyb2NrIGZvdW5kYXRpb24gbW9kZWwgJyArXG4gICAgICAgICAgICAnYW5kIHJlYWQgYW5kIHdyaXRlIGFueSBvYmplY3QgaW4gYSBzcGVjaWZpYyBTMyBidWNrZXQuJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICB0cnVlLFxuICAgICk7XG5cbiAgICBjb25zdCBjcmVhdGVNb2RlbEludm9jYXRpb25Kb2JGdW5jdGlvbiA9XG4gICAgICBuZXcgQ3JlYXRlTW9kZWxJbnZvY2F0aW9uSm9iRnVuY3Rpb24oXG4gICAgICAgIHRoaXMsXG4gICAgICAgICdDcmVhdGVNb2RlbEludm9jYXRpb25Kb2JGdW5jdGlvbicsXG4gICAgICAgIHtcbiAgICAgICAgICBiZWRyb2NrQmF0Y2hQb2xpY3k6IGJlZHJvY2tCYXRjaFBvbGljeSxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgYmVkcm9ja0JhdGNoUm9sZS5ncmFudFBhc3NSb2xlKGNyZWF0ZU1vZGVsSW52b2NhdGlvbkpvYkZ1bmN0aW9uLnJvbGUhKTtcblxuICAgIGNvbnN0IGNyZWF0ZU1vZGVsSW52b2NhdGlvbkpvYlRhc2sgPSBuZXcgdGFza3MuTGFtYmRhSW52b2tlKFxuICAgICAgdGhpcyxcbiAgICAgICdDcmVhdGVNb2RlbEludm9jYXRpb25Kb2JUYXNrJyxcbiAgICAgIHtcbiAgICAgICAgbGFtYmRhRnVuY3Rpb246IGNyZWF0ZU1vZGVsSW52b2NhdGlvbkpvYkZ1bmN0aW9uLFxuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IHNmbi5JbnRlZ3JhdGlvblBhdHRlcm4uV0FJVF9GT1JfVEFTS19UT0tFTixcbiAgICAgICAgaGVhcnRiZWF0VGltZW91dDogc2ZuLlRpbWVvdXQuZHVyYXRpb24ocHJvcHMudGltZW91dCA/IHByb3BzLnRpbWVvdXQgOiBEdXJhdGlvbi5ob3Vycyg0OCkpLFxuICAgICAgICBwYXlsb2FkOiBzZm4uVGFza0lucHV0LmZyb21PYmplY3Qoe1xuICAgICAgICAgIGpvYk5hbWU6IHNmbi5Kc29uUGF0aC5mb3JtYXQoXG4gICAgICAgICAgICAne317fScsXG4gICAgICAgICAgICBzZm4uSnNvblBhdGguc3RyaW5nQXQoJyQuam9iX25hbWUnKSxcbiAgICAgICAgICAgIHNmbi5Kc29uUGF0aC5zdHJpbmdBdCgnJC5pbmRleCcpLFxuICAgICAgICAgICksXG4gICAgICAgICAgcm9sZUFybjogYmVkcm9ja0JhdGNoUm9sZS5yb2xlQXJuLFxuICAgICAgICAgIG1vZGVsSWQ6IHNmbi5Kc29uUGF0aC5zdHJpbmdBdCgnJC5tb2RlbF9pZCcpLFxuICAgICAgICAgIGlucHV0RGF0YUNvbmZpZzoge1xuICAgICAgICAgICAgczNJbnB1dERhdGFDb25maWc6IHtcbiAgICAgICAgICAgICAgczNVcmk6IHNmbi5Kc29uUGF0aC5mb3JtYXQoXG4gICAgICAgICAgICAgICAgJ3MzOi8vJyArIHByb3BzLmJlZHJvY2tCYXRjaElucHV0QnVja2V0LmJ1Y2tldE5hbWUgKyAnL3t9JyxcbiAgICAgICAgICAgICAgICBzZm4uSnNvblBhdGguc3RyaW5nQXQoJyQubWFuaWZlc3Rfa2V5JyksXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgb3V0cHV0RGF0YUNvbmZpZzoge1xuICAgICAgICAgICAgczNPdXRwdXREYXRhQ29uZmlnOiB7XG4gICAgICAgICAgICAgIHMzVXJpOiBzZm4uSnNvblBhdGguZm9ybWF0KFxuICAgICAgICAgICAgICAgICdzMzovLycgKyBwcm9wcy5iZWRyb2NrQmF0Y2hPdXRwdXRCdWNrZXQuYnVja2V0TmFtZSArICcvb3V0cHV0L3t9LycsXG4gICAgICAgICAgICAgICAgc2ZuLkpzb25QYXRoLnN0cmluZ0F0KCckLmpvYl9uYW1lJyksXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGltZW91dER1cmF0aW9uSW5Ib3VyczogcHJvcHMudGltZW91dCA/IHByb3BzLnRpbWVvdXQudG9Ib3VycygpIDogNDgsXG4gICAgICAgICAgVGFza1Rva2VuOiBzZm4uSnNvblBhdGguc3RyaW5nQXQoJyQkLlRhc2suVG9rZW4nKSxcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgICk7XG5cbiAgICBjb25zdCBiYXRjaEV2YWx1YXRlTWFwID0gbmV3IHNmbi5NYXAodGhpcywgJ0JhdGNoRXZhbHVhdGVNYXAnLCB7XG4gICAgICBpbnB1dFBhdGg6IHByb3BzLmlucHV0UGF0aCxcbiAgICAgIGl0ZW1zUGF0aDogc2ZuLkpzb25QYXRoLnN0cmluZ0F0KCckLm1hbmlmZXN0X2tleXMnKSxcbiAgICAgIGl0ZW1TZWxlY3Rvcjoge1xuICAgICAgICBqb2JfbmFtZTogc2ZuLkpzb25QYXRoLnN0cmluZ0F0KCckLmpvYl9uYW1lJyksXG4gICAgICAgIG1vZGVsX2lkOiBzZm4uSnNvblBhdGguc3RyaW5nQXQoJyQubW9kZWxfaWQnKSxcbiAgICAgICAgaW5kZXg6IHNmbi5Kc29uUGF0aC5udW1iZXJBdCgnJCQuTWFwLkl0ZW0uSW5kZXgnKSxcbiAgICAgICAgbWFuaWZlc3Rfa2V5OiBzZm4uSnNvblBhdGguc3RyaW5nQXQoJyQkLk1hcC5JdGVtLlZhbHVlJyksXG4gICAgICB9LFxuICAgICAgcmVzdWx0UGF0aDogcHJvcHMucmVzdWx0UGF0aCxcbiAgICB9KTtcbiAgICBiYXRjaEV2YWx1YXRlTWFwLml0ZW1Qcm9jZXNzb3IoY3JlYXRlTW9kZWxJbnZvY2F0aW9uSm9iVGFzayk7XG5cbiAgICB0aGlzLnN0YXJ0U3RhdGUgPSBiYXRjaEV2YWx1YXRlTWFwO1xuICAgIHRoaXMuZW5kU3RhdGVzID0gYmF0Y2hFdmFsdWF0ZU1hcC5lbmRTdGF0ZXM7XG5cbiAgfVxufSJdfQ==