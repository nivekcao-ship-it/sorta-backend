"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.GraphKnowledgeBase = exports.GraphKnowledgeBaseBase = exports.KnowledgeBaseBase = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
var knowledge_base_1 = require("./knowledge-base");
Object.defineProperty(exports, "KnowledgeBaseBase", { enumerable: true, get: function () { return knowledge_base_1.KnowledgeBaseBase; } });
const aws_cdk_lib_1 = require("aws-cdk-lib");
const bedrock = require("aws-cdk-lib/aws-bedrock");
const iam = require("aws-cdk-lib/aws-iam");
const knowledge_base_2 = require("./knowledge-base");
const vector_knowledge_base_1 = require("./vector-knowledge-base");
const utils_1 = require("../../../common/helpers/utils");
const graph_1 = require("../../neptune/graph");
/******************************************************************************
 *                              ABSTRACT CLASS
 *****************************************************************************/
class GraphKnowledgeBaseBase extends vector_knowledge_base_1.VectorKnowledgeBaseBase {
    constructor() {
        super(...arguments);
        this.type = knowledge_base_2.KnowledgeBaseType.VECTOR;
    }
}
exports.GraphKnowledgeBaseBase = GraphKnowledgeBaseBase;
_a = JSII_RTTI_SYMBOL_1;
GraphKnowledgeBaseBase[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.GraphKnowledgeBaseBase", version: "0.1.309" };
/******************************************************************************
 *                        		  CONSTRUCT
 *****************************************************************************/
/**
 * Creates a new Amazon Bedrock Knowledge Base using a Neptune Analytics vector store, this is also known as GraphRAG.
 *
 * GraphRAG is a capability that combines graph modeling with generative AI to enhance retrieval-augmented generation (RAG).
 * It automatically identifies and leverages relationships between entities and structural elements within documents,
 * enabling more comprehensive and contextually relevant responses from foundation models.
 *
 * Key benefits:
 * - More relevant responses by leveraging relationships between entities and structural elements across documents
 * - Enhanced search capabilities that connect content through multiple logical steps
 * - Better cross-document reasoning for more precise and contextually accurate answers
 * - Reduced hallucinations through improved information connectivity
 *
 * Limitations:
 * - AWS PrivateLink VPC endpoint connectivity is not supported
 * - Graph build configuration options are not customizable
 * - Autoscaling is not supported for Neptune Analytics graphs
 * - Only supports Amazon S3 as data source
 * - Uses Claude 3 Haiku model for automatic graph building with contextual enrichment
 * - Each data source limited to 1000 files (can be increased to max 10000 files)
 *
 * @see https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-build-graphs.html
 */
class GraphKnowledgeBase extends GraphKnowledgeBaseBase {
    // ------------------------------------------------------
    // Import Methods
    // ------------------------------------------------------
    static fromKnowledgeBaseAttributes(scope, id, attrs) {
        const stack = aws_cdk_lib_1.Stack.of(scope);
        class Import extends GraphKnowledgeBaseBase {
            constructor() {
                super(...arguments);
                this.role = iam.Role.fromRoleArn(this, `kb-${attrs.knowledgeBaseId}-role`, attrs.executionRoleArn);
                this.description = attrs.description;
                this.instruction = attrs.instruction;
                this.knowledgeBaseId = attrs.knowledgeBaseId;
                this.vectorStoreType = vector_knowledge_base_1.VectorStoreType.NEPTUNE_ANALYTICS;
                this.graph = graph_1.NeptuneGraph.fromGraphId(scope, 'Graph', attrs.graphId);
                this.knowledgeBaseArn = stack.formatArn({
                    service: 'bedrock',
                    resource: 'knowledge-base',
                    resourceName: attrs.knowledgeBaseId,
                    arnFormat: aws_cdk_lib_1.ArnFormat.SLASH_RESOURCE_NAME,
                });
            }
        }
        return new Import(scope, id);
    }
    constructor(scope, id, props) {
        super(scope, id);
        this.vectorStoreType = vector_knowledge_base_1.VectorStoreType.NEPTUNE_ANALYTICS;
        // ------------------------------------------------------
        // Set properties or defaults
        // ------------------------------------------------------
        // Create a new graph if not specified.
        this.graph =
            props.graph ??
                new graph_1.NeptuneGraph(this, 'Graph', {
                    vectorSearchDimension: props.embeddingModel.vectorDimensions,
                });
        this.name =
            props.name ?? (0, utils_1.generatePhysicalNameV2)(this, 'graph-kb', { maxLength: 32, separator: '-' });
        this.instruction = props.instruction;
        this.description = props.description;
        this.fieldMapping = {
            metadataField: props.fieldMapping?.metadataField ?? 'AMAZON_BEDROCK_METADATA',
            textField: props.fieldMapping?.textField ?? 'AMAZON_BEDROCK_TEXT',
        };
        this.embeddingModel = props.embeddingModel;
        // ------------------------------------------------------
        // Role
        // ------------------------------------------------------
        // Use existing role if provided, otherwise create a new one
        this.role = props.existingRole ?? (0, knowledge_base_2.createKnowledgeBaseServiceRole)(this);
        // ------------------------------------------------------
        // L1 Instantiation
        // ------------------------------------------------------
        this._resource = new bedrock.CfnKnowledgeBase(this, 'MyCfnKnowledgeBase', {
            name: this.name,
            roleArn: this.role.roleArn,
            description: props.description,
            knowledgeBaseConfiguration: {
                type: knowledge_base_2.KnowledgeBaseType.VECTOR,
                vectorKnowledgeBaseConfiguration: {
                    embeddingModelArn: props.embeddingModel.modelArn,
                    // Used this approach as if property is specified on models that do not
                    // support configurable dimensions CloudFormation throws an error at runtime
                    embeddingModelConfiguration: {
                        bedrockEmbeddingModelConfiguration: props.embeddingModel.modelId ===
                            bedrock.FoundationModelIdentifier.AMAZON_TITAN_EMBED_TEXT_V2_0.modelId
                            ? {
                                dimensions: props.embeddingModel.vectorDimensions,
                            }
                            : undefined,
                    },
                },
            },
            storageConfiguration: {
                type: vector_knowledge_base_1.VectorStoreType.NEPTUNE_ANALYTICS,
                neptuneAnalyticsConfiguration: {
                    graphArn: this.graph.graphArn,
                    fieldMapping: this.fieldMapping,
                },
            },
        });
        // ------------------------------------------------------
        // Grant permissions
        // ------------------------------------------------------
        // Add permissions only if it is a newly created role
        if (!props.existingRole) {
            let grant = this.graph.grantQuery(this.role);
            // Allow KB to create embeddings when ingesting data
            grant = grant.combine(this.embeddingModel.grantInvoke(this.role));
            // Ensure the permissions are in place before KB creation
            grant.applyBefore(this._resource);
        }
        // ------------------------------------------------------
        // Attribute assignments
        // ------------------------------------------------------
        this.knowledgeBaseArn = this._resource.attrKnowledgeBaseArn;
        this.knowledgeBaseId = this._resource.attrKnowledgeBaseId;
    }
}
exports.GraphKnowledgeBase = GraphKnowledgeBase;
_b = JSII_RTTI_SYMBOL_1;
GraphKnowledgeBase[_b] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.GraphKnowledgeBase", version: "0.1.309" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGgta25vd2xlZGdlLWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2RrLWxpYi9iZWRyb2NrL2tub3dsZWRnZS1iYXNlcy9ncmFwaC1rbm93bGVkZ2UtYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBOzs7Ozs7Ozs7OztHQVdHO0FBRUgsbURBQXFEO0FBQTVDLG1IQUFBLGlCQUFpQixPQUFBO0FBQzFCLDZDQUErQztBQUMvQyxtREFBbUQ7QUFDbkQsMkNBQTJDO0FBRTNDLHFEQU0wQjtBQUMxQixtRUFBbUY7QUFDbkYseURBQXVFO0FBQ3ZFLCtDQUFrRTtBQXlFbEU7OytFQUUrRTtBQUMvRSxNQUFzQixzQkFBdUIsU0FBUSwrQ0FBdUI7SUFBNUU7O1FBT2tCLFNBQUksR0FBc0Isa0NBQWlCLENBQUMsTUFBTSxDQUFDO0tBQ3BFOztBQVJELHdEQVFDOzs7QUFFRDs7K0VBRStFO0FBQy9FOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBc0JHO0FBQ0gsTUFBYSxrQkFBbUIsU0FBUSxzQkFBc0I7SUFDNUQseURBQXlEO0lBQ3pELGlCQUFpQjtJQUNqQix5REFBeUQ7SUFDbEQsTUFBTSxDQUFDLDJCQUEyQixDQUN2QyxLQUFnQixFQUNoQixFQUFVLEVBQ1YsS0FBbUM7UUFFbkMsTUFBTSxLQUFLLEdBQUcsbUJBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFOUIsTUFBTSxNQUFPLFNBQVEsc0JBQXNCO1lBQTNDOztnQkFDa0IsU0FBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUN6QyxJQUFJLEVBQ0osTUFBTSxLQUFLLENBQUMsZUFBZSxPQUFPLEVBQ2xDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FDdkIsQ0FBQztnQkFDYyxnQkFBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7Z0JBQ2hDLGdCQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztnQkFDaEMsb0JB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LENBQUMsQ0FBQyxTQUFTO3FCQUNoQjtpQkFDRjthQUNGO1lBQ0Qsb0JBQW9CLEVBQUU7Z0JBQ3BCLElBQUksRUFBRSx1Q0FBZSxDQUFDLGlCQUFpQjtnQkFDdkMsNkJBQTZCLEVBQUU7b0JBQzdCLFFBQVEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVE7b0JBQzdCLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtpQkFDaEM7YUFDRjtTQUNGLENBQUMsQ0FBQztRQUVILHlEQUF5RDtRQUN6RCxvQkFBb0I7UUFDcEIseURBQXlEO1FBQ3pELHFEQUFxRDtRQUNyRCxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3hCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QyxvREFBb0Q7WUFDcEQsS0FBSyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbEUseURBQXlEO1lBQ3pELEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BDLENBQUM7UUFFRCx5REFBeUQ7UUFDekQsd0JBQXdCO1FBQ3hCLHlEQUF5RDtRQUN6RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQztRQUM1RCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUM7SUFDNUQsQ0FBQzs7QUEzSUgsZ0RBNElDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuZXhwb3J0IHsgS25vd2xlZGdlQmFzZUJhc2UgfSBmcm9tICcuL2tub3dsZWRnZS1iYXNlJztcbmltcG9ydCB7IEFybkZvcm1hdCwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBiZWRyb2NrIGZyb20gJ2F3cy1jZGstbGliL2F3cy1iZWRyb2NrJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgQ29tbW9uS25vd2xlZGdlQmFzZUF0dHJpYnV0ZXMsXG4gIENvbW1vbktub3dsZWRnZUJhc2VQcm9wcyxcbiAgY3JlYXRlS25vd2xlZGdlQmFzZVNlcnZpY2VSb2xlLFxuICBJS25vd2xlZGdlQmFzZSxcbiAgS25vd2xlZGdlQmFzZVR5cGUsXG59IGZyb20gJy4va25vd2xlZGdlLWJhc2UnO1xuaW1wb3J0IHsgVmVjdG9yS25vd2xlZGdlQmFzZUJhc2UsIFZlY3RvclN0b3JlVHlwZSB9IGZyb20gJy4vdmVjdG9yLWtub3dsZWRnZS1iYXNlJztcbmltcG9ydCB7IGdlbmVyYXRlUGh5c2ljYWxOYW1lVjIgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vaGVscGVycy91dGlscyc7XG5pbXBvcnQgeyBJTmVwdHVuZUdyYXBoLCBOZXB0dW5lR3JhcGggfSBmcm9tICcuLi8uLi9uZXB0dW5lL2dyYXBoJztcbmltcG9ydCB7IE5lcHR1bmVHcmFwaE5vdGVib29rIH0gZnJvbSAnLi4vLi4vbmVwdHVuZS9ub3RlYm9vayc7XG5pbXBvcnQgeyBCZWRyb2NrRm91bmRhdGlvbk1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzJztcblxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgIENPTU1PTiBJTlRFUkZBQ0VTXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5leHBvcnQgaW50ZXJmYWNlIElHcmFwaEtub3dsZWRnZUJhc2UgZXh0ZW5kcyBJS25vd2xlZGdlQmFzZSB7XG4gIC8qKlxuICAgKiBUaGUgTmVwdHVuZSBBbmFseXRpY3MgdmVjdG9yIHN0b3JlXG4gICAqL1xuICByZWFkb25seSBncmFwaDogSU5lcHR1bmVHcmFwaDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBWZWN0b3JGaWVsZE1hcHBpbmcge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGZpZWxkIGluIHdoaWNoIEFtYXpvbiBCZWRyb2NrIHN0b3JlcyBtZXRhZGF0YSBhYm91dCB0aGUgdmVjdG9yIHN0b3JlLlxuICAgKiBAZGVmYXVsdCBcIkFNQVpPTl9CRURST0NLX01FVEFEQVRBXCJcbiAgICovXG4gIHJlYWRvbmx5IG1ldGFkYXRhRmllbGQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGZpZWxkIGluIHdoaWNoIEFtYXpvbiBCZWRyb2NrIHN0b3JlcyB0aGUgcmF3IHRleHQgZnJvbSB5b3VyIGRhdGEuXG4gICAqIFRoZSB0ZXh0IGlzIHNwbGl0IGFjY29yZGluZyB0byB0aGUgY2h1bmtpbmcgc3RyYXRlZ3kgeW91IGNob29zZS5cbiAgICogQGRlZmF1bHQgXCJBTUFaT05fQkVEUk9DS19URVhUXCJcbiAgICovXG4gIHJlYWRvbmx5IHRleHRGaWVsZDogc3RyaW5nO1xufVxuXG4vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gKiAgICAgICAgICAgICAgICAgICAgICAgIFBST1BTIEZPUiBORVcgQ09OU1RSVUNUXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGNyZWF0aW5nIGEgS2VuZHJhIEluZGV4IEtub3dsZWRnZSBCYXNlLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEdyYXBoS25vd2xlZGdlQmFzZVByb3BzIGV4dGVuZHMgQ29tbW9uS25vd2xlZGdlQmFzZVByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBlbWJlZGRpbmdzIG1vZGVsIGZvciB0aGUga25vd2xlZGdlIGJhc2UuXG4gICAqL1xuICByZWFkb25seSBlbWJlZGRpbmdNb2RlbDogQmVkcm9ja0ZvdW5kYXRpb25Nb2RlbDtcblxuICAvKipcbiAgICogVGhlIE5lcHR1bmUgQW5hbHl0aWNzIHZlY3RvciBzdG9yZVxuICAgKiBAZGVmYXVsdCAtIEEgbmV3IE5lcHR1bmUgQW5hbHl0aWNzIHZlY3RvciBzdG9yZSBpcyBjcmVhdGVkXG4gICAqL1xuICByZWFkb25seSBncmFwaD86IElOZXB0dW5lR3JhcGg7XG5cbiAgLyoqXG4gICAqIFRoZSB2ZWN0b3IgZmllbGQgbWFwcGluZyBjb25maWd1cmF0aW9uLlxuICAgKiBAZGVmYXVsdCAtIHsgbWV0YWRhdGFGaWVsZDogXCJBTUFaT05fQkVEUk9DS19NRVRBREFUQVwiLCB0ZXh0RmllbGQ6IFwiQU1BWk9OX0JFRFJPQ0tfVEVYVFwiIH1cbiAgICovXG4gIHJlYWRvbmx5IGZpZWxkTWFwcGluZz86IFZlY3RvckZpZWxkTWFwcGluZztcbn1cblxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogICAgICAgICAgICAgICAgICAgICAgQVRUUlMgRk9SIElNUE9SVEVEIENPTlNUUlVDVFxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciBpbXBvcnRpbmcgYSBrbm93bGVkZ2UgYmFzZSBvdXRzaWRlIG9mIHRoaXMgc3RhY2tcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBHcmFwaEtub3dsZWRnZUJhc2VBdHRyaWJ1dGVzIGV4dGVuZHMgQ29tbW9uS25vd2xlZGdlQmFzZUF0dHJpYnV0ZXMge1xuICAvKipcbiAgICogVGhlIElEIG9mIHRoZSBOZXB0dW5lIEFuYWx5dGljcyB2ZWN0b3Igc3RvcmVcbiAgICovXG4gIHJlYWRvbmx5IGdyYXBoSWQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHZlY3RvciBmaWVsZCBtYXBwaW5nIGNvbmZpZ3VyYXRpb24uXG4gICAqIEBkZWZhdWx0IC0geyBtZXRhZGF0YUZpZWxkOiBcIkFNQVpPTl9CRURST0NLX01FVEFEQVRBXCIsIHRleHRGaWVsZDogXCJBTUFaT05fQkVEUk9DS19URVhUXCIgfVxuICAgKi9cbiAgcmVhZG9ubHkgZmllbGRNYXBwaW5nOiBWZWN0b3JGaWVsZE1hcHBpbmc7XG59XG5cbi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQUJTVFJBQ1QgQ0xBU1NcbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBHcmFwaEtub3dsZWRnZUJhc2VCYXNlIGV4dGVuZHMgVmVjdG9yS25vd2xlZGdlQmFzZUJhc2Uge1xuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkga25vd2xlZGdlQmFzZUFybjogc3RyaW5nO1xuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkga25vd2xlZGdlQmFzZUlkOiBzdHJpbmc7XG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSByb2xlOiBpYW0uSVJvbGU7XG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSBncmFwaDogSU5lcHR1bmVHcmFwaDtcbiAgcHVibGljIGFic3RyYWN0IHJlYWRvbmx5IGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkgaW5zdHJ1Y3Rpb24/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSB0eXBlOiBLbm93bGVkZ2VCYXNlVHlwZSA9IEtub3dsZWRnZUJhc2VUeXBlLlZFQ1RPUjtcbn1cblxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogICAgICAgICAgICAgICAgICAgICAgICBcdFx0ICBDT05TVFJVQ1RcbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cbi8qKlxuICogQ3JlYXRlcyBhIG5ldyBBbWF6b24gQmVkcm9jayBLbm93bGVkZ2UgQmFzZSB1c2luZyBhIE5lcHR1bmUgQW5hbHl0aWNzIHZlY3RvciBzdG9yZSwgdGhpcyBpcyBhbHNvIGtub3duIGFzIEdyYXBoUkFHLlxuICpcbiAqIEdyYXBoUkFHIGlzIGEgY2FwYWJpbGl0eSB0aGF0IGNvbWJpbmVzIGdyYXBoIG1vZGVsaW5nIHdpdGggZ2VuZXJhdGl2ZSBBSSB0byBlbmhhbmNlIHJldHJpZXZhbC1hdWdtZW50ZWQgZ2VuZXJhdGlvbiAoUkFHKS5cbiAqIEl0IGF1dG9tYXRpY2FsbHkgaWRlbnRpZmllcyBhbmQgbGV2ZXJhZ2VzIHJlbGF0aW9uc2hpcHMgYmV0d2VlbiBlbnRpdGllcyBhbmQgc3RydWN0dXJhbCBlbGVtZW50cyB3aXRoaW4gZG9jdW1lbnRzLFxuICogZW5hYmxpbmcgbW9yZSBjb21wcmVoZW5zaXZlIGFuZCBjb250ZXh0dWFsbHkgcmVsZXZhbnQgcmVzcG9uc2VzIGZyb20gZm91bmRhdGlvbiBtb2RlbHMuXG4gKlxuICogS2V5IGJlbmVmaXRzOlxuICogLSBNb3JlIHJlbGV2YW50IHJlc3BvbnNlcyBieSBsZXZlcmFnaW5nIHJlbGF0aW9uc2hpcHMgYmV0d2VlbiBlbnRpdGllcyBhbmQgc3RydWN0dXJhbCBlbGVtZW50cyBhY3Jvc3MgZG9jdW1lbnRzXG4gKiAtIEVuaGFuY2VkIHNlYXJjaCBjYXBhYmlsaXRpZXMgdGhhdCBjb25uZWN0IGNvbnRlbnQgdGhyb3VnaCBtdWx0aXBsZSBsb2dpY2FsIHN0ZXBzXG4gKiAtIEJldHRlciBjcm9zcy1kb2N1bWVudCByZWFzb25pbmcgZm9yIG1vcmUgcHJlY2lzZSBhbmQgY29udGV4dHVhbGx5IGFjY3VyYXRlIGFuc3dlcnNcbiAqIC0gUmVkdWNlZCBoYWxsdWNpbmF0aW9ucyB0aHJvdWdoIGltcHJvdmVkIGluZm9ybWF0aW9uIGNvbm5lY3Rpdml0eVxuICpcbiAqIExpbWl0YXRpb25zOlxuICogLSBBV1MgUHJpdmF0ZUxpbmsgVlBDIGVuZHBvaW50IGNvbm5lY3Rpdml0eSBpcyBub3Qgc3VwcG9ydGVkXG4gKiAtIEdyYXBoIGJ1aWxkIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBhcmUgbm90IGN1c3RvbWl6YWJsZVxuICogLSBBdXRvc2NhbGluZyBpcyBub3Qgc3VwcG9ydGVkIGZvciBOZXB0dW5lIEFuYWx5dGljcyBncmFwaHNcbiAqIC0gT25seSBzdXBwb3J0cyBBbWF6b24gUzMgYXMgZGF0YSBzb3VyY2VcbiAqIC0gVXNlcyBDbGF1ZGUgMyBIYWlrdSBtb2RlbCBmb3IgYXV0b21hdGljIGdyYXBoIGJ1aWxkaW5nIHdpdGggY29udGV4dHVhbCBlbnJpY2htZW50XG4gKiAtIEVhY2ggZGF0YSBzb3VyY2UgbGltaXRlZCB0byAxMDAwIGZpbGVzIChjYW4gYmUgaW5jcmVhc2VkIHRvIG1heCAxMDAwMCBmaWxlcylcbiAqXG4gKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9iZWRyb2NrL2xhdGVzdC91c2VyZ3VpZGUva25vd2xlZGdlLWJhc2UtYnVpbGQtZ3JhcGhzLmh0bWxcbiAqL1xuZXhwb3J0IGNsYXNzIEdyYXBoS25vd2xlZGdlQmFzZSBleHRlbmRzIEdyYXBoS25vd2xlZGdlQmFzZUJhc2Uge1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gSW1wb3J0IE1ldGhvZHNcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHB1YmxpYyBzdGF0aWMgZnJvbUtub3dsZWRnZUJhc2VBdHRyaWJ1dGVzKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBhdHRyczogR3JhcGhLbm93bGVkZ2VCYXNlQXR0cmlidXRlcyxcbiAgKTogSUdyYXBoS25vd2xlZGdlQmFzZSB7XG4gICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZihzY29wZSk7XG5cbiAgICBjbGFzcyBJbXBvcnQgZXh0ZW5kcyBHcmFwaEtub3dsZWRnZUJhc2VCYXNlIHtcbiAgICAgIHB1YmxpYyByZWFkb25seSByb2xlID0gaWFtLlJvbGUuZnJvbVJvbGVBcm4oXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGBrYi0ke2F0dHJzLmtub3dsZWRnZUJhc2VJZH0tcm9sZWAsXG4gICAgICAgIGF0dHJzLmV4ZWN1dGlvblJvbGVBcm4sXG4gICAgICApO1xuICAgICAgcHVibGljIHJlYWRvbmx5IGRlc2NyaXB0aW9uID0gYXR0cnMuZGVzY3JpcHRpb247XG4gICAgICBwdWJsaWMgcmVhZG9ubHkgaW5zdHJ1Y3Rpb24gPSBhdHRycy5pbnN0cnVjdGlvbjtcbiAgICAgIHB1YmxpYyByZWFkb25seSBrbm93bGVkZ2VCYXNlSWQgPSBhdHRycy5rbm93bGVkZ2VCYXNlSWQ7XG4gICAgICBwdWJsaWMgcmVhZG9ubHkgdmVjdG9yU3RvcmVUeXBlID0gVmVjdG9yU3RvcmVUeXBlLk5FUFRVTkVfQU5BTFlUSUNTO1xuICAgICAgcHVibGljIHJlYWRvbmx5IGdyYXBoID0gTmVwdHVuZUdyYXBoLmZyb21HcmFwaElkKHNjb3BlLCAnR3JhcGgnLCBhdHRycy5ncmFwaElkKTtcbiAgICAgIHB1YmxpYyByZWFkb25seSBrbm93bGVkZ2VCYXNlQXJuID0gc3RhY2suZm9ybWF0QXJuKHtcbiAgICAgICAgc2VydmljZTogJ2JlZHJvY2snLFxuICAgICAgICByZXNvdXJjZTogJ2tub3dsZWRnZS1iYXNlJyxcbiAgICAgICAgcmVzb3VyY2VOYW1lOiBhdHRycy5rbm93bGVkZ2VCYXNlSWQsXG4gICAgICAgIGFybkZvcm1hdDogQXJuRm9ybWF0LlNMQVNIX1JFU09VUkNFX05BTUUsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBJbXBvcnQoc2NvcGUsIGlkKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gQXR0cmlidXRlc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gaW5oZXJpdGVkXG4gIHB1YmxpYyByZWFkb25seSBrbm93bGVkZ2VCYXNlQXJuOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBrbm93bGVkZ2VCYXNlSWQ6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHJvbGU6IGlhbS5JUm9sZTtcbiAgcHVibGljIHJlYWRvbmx5IGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgbm90ZWJvb2s/OiBOZXB0dW5lR3JhcGhOb3RlYm9vaztcbiAgcHVibGljIHJlYWRvbmx5IGluc3RydWN0aW9uPzogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgZ3JhcGg6IElOZXB0dW5lR3JhcGg7XG4gIHB1YmxpYyByZWFkb25seSB2ZWN0b3JTdG9yZVR5cGUgPSBWZWN0b3JTdG9yZVR5cGUuTkVQVFVORV9BTkFMWVRJQ1M7XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBrbm93bGVkZ2UgYmFzZS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBlbWJlZGRpbmdzIG1vZGVsIGZvciB0aGUga25vd2xlZGdlIGJhc2UuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZW1iZWRkaW5nTW9kZWw6IEJlZHJvY2tGb3VuZGF0aW9uTW9kZWw7XG5cbiAgLyoqXG4gICAqIFRoZSB2ZWN0b3IgZmllbGQgbWFwcGluZyBjb25maWd1cmF0aW9uLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGZpZWxkTWFwcGluZzogVmVjdG9yRmllbGRNYXBwaW5nO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgX3Jlc291cmNlOiBiZWRyb2NrLkNmbktub3dsZWRnZUJhc2U7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEdyYXBoS25vd2xlZGdlQmFzZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBTZXQgcHJvcGVydGllcyBvciBkZWZhdWx0c1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIENyZWF0ZSBhIG5ldyBncmFwaCBpZiBub3Qgc3BlY2lmaWVkLlxuICAgIHRoaXMuZ3JhcGggPVxuICAgICAgcHJvcHMuZ3JhcGggPz9cbiAgICAgIG5ldyBOZXB0dW5lR3JhcGgodGhpcywgJ0dyYXBoJywge1xuICAgICAgICB2ZWN0b3JTZWFyY2hEaW1lbnNpb246IHByb3BzLmVtYmVkZGluZ01vZGVsLnZlY3RvckRpbWVuc2lvbnMhLFxuICAgICAgfSk7XG5cbiAgICB0aGlzLm5hbWUgPVxuICAgICAgcHJvcHMubmFtZSA/PyBnZW5lcmF0ZVBoeXNpY2FsTmFtZVYyKHRoaXMsICdncmFwaC1rYicsIHsgbWF4TGVuZ3RoOiAzMiwgc2VwYXJhdG9yOiAnLScgfSk7XG4gICAgdGhpcy5pbnN0cnVjdGlvbiA9IHByb3BzLmluc3RydWN0aW9uO1xuICAgIHRoaXMuZGVzY3JpcHRpb24gPSBwcm9wcy5kZXNjcmlwdGlvbjtcbiAgICB0aGlzLmZpZWxkTWFwcGluZyA9IHtcbiAgICAgIG1ldGFkYXRhRmllbGQ6IHByb3BzLmZpZWxkTWFwcGluZz8ubWV0YWRhdGFGaWVsZCA/PyAnQU1BWk9OX0JFRFJPQ0tfTUVUQURBVEEnLFxuICAgICAgdGV4dEZpZWxkOiBwcm9wcy5maWVsZE1hcHBpbmc/LnRleHRGaWVsZCA/PyAnQU1BWk9OX0JFRFJPQ0tfVEVYVCcsXG4gICAgfTtcbiAgICB0aGlzLmVtYmVkZGluZ01vZGVsID0gcHJvcHMuZW1iZWRkaW5nTW9kZWw7XG5cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBSb2xlXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gVXNlIGV4aXN0aW5nIHJvbGUgaWYgcHJvdmlkZWQsIG90aGVyd2lzZSBjcmVhdGUgYSBuZXcgb25lXG4gICAgdGhpcy5yb2xlID0gcHJvcHMuZXhpc3RpbmdSb2xlID8/IGNyZWF0ZUtub3dsZWRnZUJhc2VTZXJ2aWNlUm9sZSh0aGlzKTtcblxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIEwxIEluc3RhbnRpYXRpb25cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICB0aGlzLl9yZXNvdXJjZSA9IG5ldyBiZWRyb2NrLkNmbktub3dsZWRnZUJhc2UodGhpcywgJ015Q2ZuS25vd2xlZGdlQmFzZScsIHtcbiAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgIHJvbGVBcm46IHRoaXMucm9sZS5yb2xlQXJuLFxuICAgICAgZGVzY3JpcHRpb246IHByb3BzLmRlc2NyaXB0aW9uLFxuICAgICAga25vd2xlZGdlQmFzZUNvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgdHlwZTogS25vd2xlZGdlQmFzZVR5cGUuVkVDVE9SLFxuICAgICAgICB2ZWN0b3JLbm93bGVkZ2VCYXNlQ29uZmlndXJhdGlvbjoge1xuICAgICAgICAgIGVtYmVkZGluZ01vZGVsQXJuOiBwcm9wcy5lbWJlZGRpbmdNb2RlbC5tb2RlbEFybixcbiAgICAgICAgICAvLyBVc2VkIHRoaXMgYXBwcm9hY2ggYXMgaWYgcHJvcGVydHkgaXMgc3BlY2lmaWVkIG9uIG1vZGVscyB0aGF0IGRvIG5vdFxuICAgICAgICAgIC8vIHN1cHBvcnQgY29uZmlndXJhYmxlIGRpbWVuc2lvbnMgQ2xvdWRGb3JtYXRpb24gdGhyb3dzIGFuIGVycm9yIGF0IHJ1bnRpbWVcbiAgICAgICAgICBlbWJlZGRpbmdNb2RlbENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICAgIGJlZHJvY2tFbWJlZGRpbmdNb2RlbENvbmZpZ3VyYXRpb246XG4gICAgICAgICAgICAgIHByb3BzLmVtYmVkZGluZ01vZGVsLm1vZGVsSWQgPT09XG4gICAgICAgICAgICAgIGJlZHJvY2suRm91bmRhdGlvbk1vZGVsSWRlbnRpZmllci5BTUFaT05fVElUQU5fRU1CRURfVEVYVF9WMl8wLm1vZGVsSWRcbiAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIGRpbWVuc2lvbnM6IHByb3BzLmVtYmVkZGluZ01vZGVsLnZlY3RvckRpbWVuc2lvbnMsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgc3RvcmFnZUNvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgdHlwZTogVmVjdG9yU3RvcmVUeXBlLk5FUFRVTkVfQU5BTFlUSUNTLFxuICAgICAgICBuZXB0dW5lQW5hbHl0aWNzQ29uZmlndXJhdGlvbjoge1xuICAgICAgICAgIGdyYXBoQXJuOiB0aGlzLmdyYXBoLmdyYXBoQXJuLFxuICAgICAgICAgIGZpZWxkTWFwcGluZzogdGhpcy5maWVsZE1hcHBpbmcsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gR3JhbnQgcGVybWlzc2lvbnNcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBBZGQgcGVybWlzc2lvbnMgb25seSBpZiBpdCBpcyBhIG5ld2x5IGNyZWF0ZWQgcm9sZVxuICAgIGlmICghcHJvcHMuZXhpc3RpbmdSb2xlKSB7XG4gICAgICBsZXQgZ3JhbnQgPSB0aGlzLmdyYXBoLmdyYW50UXVlcnkodGhpcy5yb2xlKTtcbiAgICAgIC8vIEFsbG93IEtCIHRvIGNyZWF0ZSBlbWJlZGRpbmdzIHdoZW4gaW5nZXN0aW5nIGRhdGFcbiAgICAgIGdyYW50ID0gZ3JhbnQuY29tYmluZSh0aGlzLmVtYmVkZGluZ01vZGVsLmdyYW50SW52b2tlKHRoaXMucm9sZSkpO1xuICAgICAgLy8gRW5zdXJlIHRoZSBwZXJtaXNzaW9ucyBhcmUgaW4gcGxhY2UgYmVmb3JlIEtCIGNyZWF0aW9uXG4gICAgICBncmFudC5hcHBseUJlZm9yZSh0aGlzLl9yZXNvdXJjZSk7XG4gICAgfVxuXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gQXR0cmlidXRlIGFzc2lnbm1lbnRzXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5rbm93bGVkZ2VCYXNlQXJuID0gdGhpcy5fcmVzb3VyY2UuYXR0cktub3dsZWRnZUJhc2VBcm47XG4gICAgdGhpcy5rbm93bGVkZ2VCYXNlSWQgPSB0aGlzLl9yZXNvdXJjZS5hdHRyS25vd2xlZGdlQmFzZUlkO1xuICB9XG59XG4iXX0=