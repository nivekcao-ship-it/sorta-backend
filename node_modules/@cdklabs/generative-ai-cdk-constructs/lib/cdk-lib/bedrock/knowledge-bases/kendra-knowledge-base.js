"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.KendraKnowledgeBase = exports.KendraKnowledgeBaseBase = exports.KnowledgeBaseBase = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
var knowledge_base_1 = require("./knowledge-base");
Object.defineProperty(exports, "KnowledgeBaseBase", { enumerable: true, get: function () { return knowledge_base_1.KnowledgeBaseBase; } });
const aws_cdk_lib_1 = require("aws-cdk-lib");
const bedrock = require("aws-cdk-lib/aws-bedrock");
const iam = require("aws-cdk-lib/aws-iam");
const knowledge_base_2 = require("./knowledge-base");
const utils_1 = require("../../../common/helpers/utils");
/******************************************************************************
 *                              ABSTRACT CLASS
 *****************************************************************************/
class KendraKnowledgeBaseBase extends knowledge_base_2.KnowledgeBaseBase {
    constructor() {
        super(...arguments);
        this.type = knowledge_base_2.KnowledgeBaseType.KENDRA;
    }
}
exports.KendraKnowledgeBaseBase = KendraKnowledgeBaseBase;
_a = JSII_RTTI_SYMBOL_1;
KendraKnowledgeBaseBase[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.KendraKnowledgeBaseBase", version: "0.1.309" };
/******************************************************************************
 *                        		  CONSTRUCT
 *****************************************************************************/
class KendraKnowledgeBase extends KendraKnowledgeBaseBase {
    // ------------------------------------------------------
    // Import Methods
    // ------------------------------------------------------
    static fromKnowledgeBaseAttributes(scope, id, attrs) {
        const stack = aws_cdk_lib_1.Stack.of(scope);
        class Import extends KendraKnowledgeBaseBase {
            constructor() {
                super(...arguments);
                this.role = iam.Role.fromRoleArn(this, `kb-${attrs.knowledgeBaseId}-role`, attrs.executionRoleArn);
                this.description = attrs.description;
                this.instruction = attrs.instruction;
                this.knowledgeBaseId = attrs.knowledgeBaseId;
                this.kendraIndex = attrs.kendraIndex;
                this.knowledgeBaseArn = stack.formatArn({
                    service: 'bedrock',
                    resource: 'knowledge-base',
                    resourceName: attrs.knowledgeBaseId,
                    arnFormat: aws_cdk_lib_1.ArnFormat.SLASH_RESOURCE_NAME,
                });
            }
        }
        return new Import(scope, id);
    }
    constructor(scope, id, props) {
        super(scope, id);
        /**
         * The type of Knowledge Base
         */
        this.type = knowledge_base_2.KnowledgeBaseType.KENDRA;
        // ------------------------------------------------------
        // Set properties or defaults
        // ------------------------------------------------------
        this.kendraIndex = props.kendraIndex;
        this.name =
            props.name ?? (0, utils_1.generatePhysicalNameV2)(this, 'kendra-kb', { maxLength: 32, separator: '-' });
        this.instruction = props.instruction;
        this.description = props.description;
        // ------------------------------------------------------
        // Role
        // ------------------------------------------------------
        let policyAddition;
        // Use existing role if provided, otherwise create a new one
        this.role = props.existingRole ?? (0, knowledge_base_2.createKnowledgeBaseServiceRole)(this);
        if (!props.existingRole) {
            policyAddition = this.role.addToPrincipalPolicy(new iam.PolicyStatement({
                sid: 'AmazonBedrockKnowledgeBaseKendraIndexAccessStatement',
                actions: ['kendra:Retrieve', 'kendra:DescribeIndex'],
                resources: [this.kendraIndex.indexArn],
            }));
        }
        // ------------------------------------------------------
        // L1 Instantiation
        // ------------------------------------------------------
        this._resource = new bedrock.CfnKnowledgeBase(this, 'MyCfnKnowledgeBase', {
            name: this.name,
            roleArn: this.role.roleArn,
            description: props.description,
            knowledgeBaseConfiguration: {
                type: knowledge_base_2.KnowledgeBaseType.KENDRA,
                kendraKnowledgeBaseConfiguration: {
                    kendraIndexArn: props.kendraIndex.indexArn,
                },
            },
        });
        // Ensure policy statement is added before creating KnowledgeBase
        this._resource.node.addDependency(policyAddition?.policyDependable);
        this.knowledgeBaseArn = this._resource.attrKnowledgeBaseArn;
        this.knowledgeBaseId = this._resource.attrKnowledgeBaseId;
    }
}
exports.KendraKnowledgeBase = KendraKnowledgeBase;
_b = JSII_RTTI_SYMBOL_1;
KendraKnowledgeBase[_b] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.KendraKnowledgeBase", version: "0.1.309" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2VuZHJhLWtub3dsZWRnZS1iYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2Nkay1saWIvYmVkcm9jay9rbm93bGVkZ2UtYmFzZXMva2VuZHJhLWtub3dsZWRnZS1iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7QUFFSCxtREFBcUQ7QUFBNUMsbUhBQUEsaUJBQWlCLE9BQUE7QUFDMUIsNkNBQStDO0FBQy9DLG1EQUFtRDtBQUNuRCwyQ0FBMkM7QUFFM0MscURBTzBCO0FBQzFCLHlEQUF1RTtBQXVDdkU7OytFQUUrRTtBQUMvRSxNQUFzQix1QkFBd0IsU0FBUSxrQ0FBaUI7SUFBdkU7O1FBT2tCLFNBQUksR0FBc0Isa0NBQWlCLENBQUMsTUFBTSxDQUFDO0tBQ3BFOztBQVJELDBEQVFDOzs7QUFFRDs7K0VBRStFO0FBQy9FLE1BQWEsbUJBQW9CLFNBQVEsdUJBQXVCO0lBQzlELHlEQUF5RDtJQUN6RCxpQkFBaUI7SUFDakIseURBQXlEO0lBQ2xELE1BQU0sQ0FBQywyQkFBMkIsQ0FDdkMsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLEtBQW9DO1FBRXBDLE1BQU0sS0FBSyxHQUFHLG1CQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTlCLE1BQU0sTUFBTyxTQUFRLHVCQUF1QjtZQUE1Qzs7Z0JBQ2tCLFNBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FDekMsSUFBSSxFQUNKLE1BQU0sS0FBSyxDQUFDLGVBQWUsT0FBTyxFQUNsQyxLQUFLLENBQUMsZ0JBQWdCLENBQ3ZCLENBQUM7Z0JBQ2MsZ0JBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO2dCQUNoQyxnQkFBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7Z0JBQ2hDLG9CQUFlLEdBQUcsS0FBSyxDQUFDLGVBQWUsQ0FBQztnQkFDeEMsZ0JBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO2dCQUNoQyxxQkFBZ0IsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO29CQUNqRCxPQUFPLEVBQUUsU0FBUztvQkFDbEIsUUFBUSxFQUFFLGdCQUFnQjtvQkFDMUIsWUFBWSxFQUFFLEtBQUssQ0FBQyxlQUFlO29CQUNuQyxTQUFTLEVBQUUsdUJBQVMsQ0FBQyxtQkFBbUI7aUJBQ3pDLENBQUMsQ0FBQztZQUNMLENBQUM7U0FBQTtRQUNELE9BQU8sSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUEyQkQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUErQjtRQUN2RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBUm5COztXQUVHO1FBQ2EsU0FBSSxHQUFzQixrQ0FBaUIsQ0FBQyxNQUFNLENBQUM7UUFNakUseURBQXlEO1FBQ3pELDZCQUE2QjtRQUM3Qix5REFBeUQ7UUFDekQsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJO1lBQ1AsS0FBSyxDQUFDLElBQUksSUFBSSxJQUFBLDhCQUFzQixFQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzdGLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztRQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7UUFFckMseURBQXlEO1FBQ3pELE9BQU87UUFDUCx5REFBeUQ7UUFDekQsSUFBSSxjQUEwRCxDQUFDO1FBQy9ELDREQUE0RDtRQUM1RCxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxZQUFZLElBQUksSUFBQSwrQ0FBOEIsRUFBQyxJQUFJLENBQUMsQ0FBQztRQUV2RSxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3hCLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUM3QyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7Z0JBQ3RCLEdBQUcsRUFBRSxzREFBc0Q7Z0JBQzNELE9BQU8sRUFBRSxDQUFDLGlCQUFpQixFQUFFLHNCQUFzQixDQUFDO2dCQUNwRCxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQzthQUN2QyxDQUFDLENBQ0gsQ0FBQztRQUNKLENBQUM7UUFDRCx5REFBeUQ7UUFDekQsbUJBQW1CO1FBQ25CLHlEQUF5RDtRQUN6RCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksT0FBTyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxvQkFBb0IsRUFBRTtZQUN4RSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPO1lBQzFCLFdBQVcsRUFBRSxLQUFLLENBQUMsV0FBVztZQUM5QiwwQkFBMEIsRUFBRTtnQkFDMUIsSUFBSSxFQUFFLGtDQUFpQixDQUFDLE1BQU07Z0JBQzlCLGdDQUFnQyxFQUFFO29CQUNoQyxjQUFjLEVBQUUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxRQUFRO2lCQUMzQzthQUNGO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsaUVBQWlFO1FBQ2pFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsZ0JBQWlCLENBQUMsQ0FBQztRQUVyRSxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQztRQUM1RCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUM7SUFDNUQsQ0FBQzs7QUF2R0gsa0RBd0dDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuZXhwb3J0IHsgS25vd2xlZGdlQmFzZUJhc2UgfSBmcm9tICcuL2tub3dsZWRnZS1iYXNlJztcbmltcG9ydCB7IEFybkZvcm1hdCwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBiZWRyb2NrIGZyb20gJ2F3cy1jZGstbGliL2F3cy1iZWRyb2NrJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgQ29tbW9uS25vd2xlZGdlQmFzZUF0dHJpYnV0ZXMsXG4gIENvbW1vbktub3dsZWRnZUJhc2VQcm9wcyxcbiAgY3JlYXRlS25vd2xlZGdlQmFzZVNlcnZpY2VSb2xlLFxuICBJS25vd2xlZGdlQmFzZSxcbiAgS25vd2xlZGdlQmFzZUJhc2UsXG4gIEtub3dsZWRnZUJhc2VUeXBlLFxufSBmcm9tICcuL2tub3dsZWRnZS1iYXNlJztcbmltcG9ydCB7IGdlbmVyYXRlUGh5c2ljYWxOYW1lVjIgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vaGVscGVycy91dGlscyc7XG5pbXBvcnQgeyBJS2VuZHJhR2VuQWlJbmRleCB9IGZyb20gJy4uLy4uL2tlbmRyYSc7XG5cbi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDT01NT04gSU5URVJGQUNFU1xuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuZXhwb3J0IGludGVyZmFjZSBJS2VuZHJhS25vd2xlZGdlQmFzZSBleHRlbmRzIElLbm93bGVkZ2VCYXNlIHtcbiAgLyoqXG4gICAqIFRoZSBHZW5BSSBLZW5kcmEgSW5kZXguXG4gICAqL1xuICByZWFkb25seSBrZW5kcmFJbmRleDogSUtlbmRyYUdlbkFpSW5kZXg7XG59XG5cbi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqICAgICAgICAgICAgICAgICAgICAgICAgUFJPUFMgRk9SIE5FVyBDT05TVFJVQ1RcbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cbi8qKlxuICogUHJvcGVydGllcyBmb3IgY3JlYXRpbmcgYSBLZW5kcmEgSW5kZXggS25vd2xlZGdlIEJhc2UuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgS2VuZHJhS25vd2xlZGdlQmFzZVByb3BzIGV4dGVuZHMgQ29tbW9uS25vd2xlZGdlQmFzZVByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBLZW5kcmEgSW5kZXggdG8gdXNlIGZvciB0aGUga25vd2xlZGdlIGJhc2UuXG4gICAqL1xuICByZWFkb25seSBrZW5kcmFJbmRleDogSUtlbmRyYUdlbkFpSW5kZXg7XG59XG5cbi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqICAgICAgICAgICAgICAgICAgICAgIEFUVFJTIEZPUiBJTVBPUlRFRCBDT05TVFJVQ1RcbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cbi8qKlxuICogUHJvcGVydGllcyBmb3IgaW1wb3J0aW5nIGEga25vd2xlZGdlIGJhc2Ugb3V0c2lkZSBvZiB0aGlzIHN0YWNrXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgS2VuZHJhS25vd2xlZGdlQmFzZUF0dHJpYnV0ZXMgZXh0ZW5kcyBDb21tb25Lbm93bGVkZ2VCYXNlQXR0cmlidXRlcyB7XG4gIC8qKlxuICAgKiBUaGUgR2VuQUkgS2VuZHJhIEluZGV4IEFSTi5cbiAgICovXG4gIHJlYWRvbmx5IGtlbmRyYUluZGV4OiBJS2VuZHJhR2VuQWlJbmRleDtcbn1cblxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBQlNUUkFDVCBDTEFTU1xuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEtlbmRyYUtub3dsZWRnZUJhc2VCYXNlIGV4dGVuZHMgS25vd2xlZGdlQmFzZUJhc2Uge1xuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkga25vd2xlZGdlQmFzZUFybjogc3RyaW5nO1xuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkga25vd2xlZGdlQmFzZUlkOiBzdHJpbmc7XG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSByb2xlOiBpYW0uSVJvbGU7XG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSBrZW5kcmFJbmRleDogSUtlbmRyYUdlbkFpSW5kZXg7XG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgcHVibGljIGFic3RyYWN0IHJlYWRvbmx5IGluc3RydWN0aW9uPzogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgdHlwZTogS25vd2xlZGdlQmFzZVR5cGUgPSBLbm93bGVkZ2VCYXNlVHlwZS5LRU5EUkE7XG59XG5cbi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqICAgICAgICAgICAgICAgICAgICAgICAgXHRcdCAgQ09OU1RSVUNUXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5leHBvcnQgY2xhc3MgS2VuZHJhS25vd2xlZGdlQmFzZSBleHRlbmRzIEtlbmRyYUtub3dsZWRnZUJhc2VCYXNlIHtcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIEltcG9ydCBNZXRob2RzXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBwdWJsaWMgc3RhdGljIGZyb21Lbm93bGVkZ2VCYXNlQXR0cmlidXRlcyhcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgYXR0cnM6IEtlbmRyYUtub3dsZWRnZUJhc2VBdHRyaWJ1dGVzLFxuICApOiBJS2VuZHJhS25vd2xlZGdlQmFzZSB7XG4gICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZihzY29wZSk7XG5cbiAgICBjbGFzcyBJbXBvcnQgZXh0ZW5kcyBLZW5kcmFLbm93bGVkZ2VCYXNlQmFzZSB7XG4gICAgICBwdWJsaWMgcmVhZG9ubHkgcm9sZSA9IGlhbS5Sb2xlLmZyb21Sb2xlQXJuKFxuICAgICAgICB0aGlzLFxuICAgICAgICBga2ItJHthdHRycy5rbm93bGVkZ2VCYXNlSWR9LXJvbGVgLFxuICAgICAgICBhdHRycy5leGVjdXRpb25Sb2xlQXJuLFxuICAgICAgKTtcbiAgICAgIHB1YmxpYyByZWFkb25seSBkZXNjcmlwdGlvbiA9IGF0dHJzLmRlc2NyaXB0aW9uO1xuICAgICAgcHVibGljIHJlYWRvbmx5IGluc3RydWN0aW9uID0gYXR0cnMuaW5zdHJ1Y3Rpb247XG4gICAgICBwdWJsaWMgcmVhZG9ubHkga25vd2xlZGdlQmFzZUlkID0gYXR0cnMua25vd2xlZGdlQmFzZUlkO1xuICAgICAgcHVibGljIHJlYWRvbmx5IGtlbmRyYUluZGV4ID0gYXR0cnMua2VuZHJhSW5kZXg7XG4gICAgICBwdWJsaWMgcmVhZG9ubHkga25vd2xlZGdlQmFzZUFybiA9IHN0YWNrLmZvcm1hdEFybih7XG4gICAgICAgIHNlcnZpY2U6ICdiZWRyb2NrJyxcbiAgICAgICAgcmVzb3VyY2U6ICdrbm93bGVkZ2UtYmFzZScsXG4gICAgICAgIHJlc291cmNlTmFtZTogYXR0cnMua25vd2xlZGdlQmFzZUlkLFxuICAgICAgICBhcm5Gb3JtYXQ6IEFybkZvcm1hdC5TTEFTSF9SRVNPVVJDRV9OQU1FLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgSW1wb3J0KHNjb3BlLCBpZCk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIEF0dHJpYnV0ZXNcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIGluaGVyaXRlZFxuICBwdWJsaWMgcmVhZG9ubHkga25vd2xlZGdlQmFzZUFybjogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkga25vd2xlZGdlQmFzZUlkOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSByb2xlOiBpYW0uSVJvbGU7XG4gIHB1YmxpYyByZWFkb25seSBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGluc3RydWN0aW9uPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUga25vd2xlZGdlIGJhc2UuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgR2VuQUkgS2VuZHJhIEluZGV4LlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGtlbmRyYUluZGV4OiBJS2VuZHJhR2VuQWlJbmRleDtcbiAgLyoqXG4gICAqIFRoZSB0eXBlIG9mIEtub3dsZWRnZSBCYXNlXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdHlwZTogS25vd2xlZGdlQmFzZVR5cGUgPSBLbm93bGVkZ2VCYXNlVHlwZS5LRU5EUkE7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfcmVzb3VyY2U6IGJlZHJvY2suQ2ZuS25vd2xlZGdlQmFzZTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogS2VuZHJhS25vd2xlZGdlQmFzZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBTZXQgcHJvcGVydGllcyBvciBkZWZhdWx0c1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMua2VuZHJhSW5kZXggPSBwcm9wcy5rZW5kcmFJbmRleDtcbiAgICB0aGlzLm5hbWUgPVxuICAgICAgcHJvcHMubmFtZSA/PyBnZW5lcmF0ZVBoeXNpY2FsTmFtZVYyKHRoaXMsICdrZW5kcmEta2InLCB7IG1heExlbmd0aDogMzIsIHNlcGFyYXRvcjogJy0nIH0pO1xuICAgIHRoaXMuaW5zdHJ1Y3Rpb24gPSBwcm9wcy5pbnN0cnVjdGlvbjtcbiAgICB0aGlzLmRlc2NyaXB0aW9uID0gcHJvcHMuZGVzY3JpcHRpb247XG5cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBSb2xlXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgbGV0IHBvbGljeUFkZGl0aW9uOiBpYW0uQWRkVG9QcmluY2lwYWxQb2xpY3lSZXN1bHQgfCB1bmRlZmluZWQ7XG4gICAgLy8gVXNlIGV4aXN0aW5nIHJvbGUgaWYgcHJvdmlkZWQsIG90aGVyd2lzZSBjcmVhdGUgYSBuZXcgb25lXG4gICAgdGhpcy5yb2xlID0gcHJvcHMuZXhpc3RpbmdSb2xlID8/IGNyZWF0ZUtub3dsZWRnZUJhc2VTZXJ2aWNlUm9sZSh0aGlzKTtcblxuICAgIGlmICghcHJvcHMuZXhpc3RpbmdSb2xlKSB7XG4gICAgICBwb2xpY3lBZGRpdGlvbiA9IHRoaXMucm9sZS5hZGRUb1ByaW5jaXBhbFBvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIHNpZDogJ0FtYXpvbkJlZHJvY2tLbm93bGVkZ2VCYXNlS2VuZHJhSW5kZXhBY2Nlc3NTdGF0ZW1lbnQnLFxuICAgICAgICAgIGFjdGlvbnM6IFsna2VuZHJhOlJldHJpZXZlJywgJ2tlbmRyYTpEZXNjcmliZUluZGV4J10sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbdGhpcy5rZW5kcmFJbmRleC5pbmRleEFybl0sXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gTDEgSW5zdGFudGlhdGlvblxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMuX3Jlc291cmNlID0gbmV3IGJlZHJvY2suQ2ZuS25vd2xlZGdlQmFzZSh0aGlzLCAnTXlDZm5Lbm93bGVkZ2VCYXNlJywge1xuICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgcm9sZUFybjogdGhpcy5yb2xlLnJvbGVBcm4sXG4gICAgICBkZXNjcmlwdGlvbjogcHJvcHMuZGVzY3JpcHRpb24sXG4gICAgICBrbm93bGVkZ2VCYXNlQ29uZmlndXJhdGlvbjoge1xuICAgICAgICB0eXBlOiBLbm93bGVkZ2VCYXNlVHlwZS5LRU5EUkEsXG4gICAgICAgIGtlbmRyYUtub3dsZWRnZUJhc2VDb25maWd1cmF0aW9uOiB7XG4gICAgICAgICAga2VuZHJhSW5kZXhBcm46IHByb3BzLmtlbmRyYUluZGV4LmluZGV4QXJuLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEVuc3VyZSBwb2xpY3kgc3RhdGVtZW50IGlzIGFkZGVkIGJlZm9yZSBjcmVhdGluZyBLbm93bGVkZ2VCYXNlXG4gICAgdGhpcy5fcmVzb3VyY2Uubm9kZS5hZGREZXBlbmRlbmN5KHBvbGljeUFkZGl0aW9uPy5wb2xpY3lEZXBlbmRhYmxlISk7XG5cbiAgICB0aGlzLmtub3dsZWRnZUJhc2VBcm4gPSB0aGlzLl9yZXNvdXJjZS5hdHRyS25vd2xlZGdlQmFzZUFybjtcbiAgICB0aGlzLmtub3dsZWRnZUJhc2VJZCA9IHRoaXMuX3Jlc291cmNlLmF0dHJLbm93bGVkZ2VCYXNlSWQ7XG4gIH1cbn1cbiJdfQ==