"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Prompt = exports.PromptBase = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const helpers_internal_1 = require("aws-cdk-lib/core/lib/helpers-internal");
const constructs_1 = require("constructs");
/**
 * Abstract base class for a Prompt.
 * Contains methods and attributes valid for Promtps either created with CDK or imported.
 */
class PromptBase extends aws_cdk_lib_1.Resource {
    /**
     * Grant the given identity permissions to get the prompt.
     */
    grantGet(grantee) {
        return aws_iam_1.Grant.addToPrincipal({
            grantee,
            resourceArns: [this.promptArn],
            actions: ['bedrock:GetPrompt'],
            scope: this,
        });
    }
}
exports.PromptBase = PromptBase;
_a = JSII_RTTI_SYMBOL_1;
PromptBase[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.PromptBase", version: "0.1.309" };
/******************************************************************************
 *                        NEW CONSTRUCT DEFINITION
 *****************************************************************************/
/**
 * Prompts are a specific set of inputs that guide FMs on Amazon Bedrock to
 * generate an appropriate response or output for a given task or instruction.
 * You can optimize the prompt for specific use cases and models.
 * @resource AWS::Bedrock::Prompt
 * @see https://docs.aws.amazon.com/bedrock/latest/userguide/prompt-management.html
 */
class Prompt extends constructs_1.Construct {
    // ------------------------------------------------------
    // Import Methods
    // ------------------------------------------------------
    static fromPromptAttributes(scope, id, attrs) {
        const formattedArn = aws_cdk_lib_1.Arn.split(attrs.promptArn, aws_cdk_lib_1.ArnFormat.SLASH_RESOURCE_NAME);
        class Import extends PromptBase {
            constructor() {
                super(...arguments);
                this.promptArn = attrs.promptArn;
                this.promptId = formattedArn.resourceName;
                this.promptVersion = attrs.promptVersion ?? 'DRAFT';
                this.kmsKey = attrs.kmsKey;
            }
        }
        return new Import(scope, id);
    }
    // ------------------------------------------------------
    // Constructor
    // ------------------------------------------------------
    constructor(scope, id, props) {
        super(scope, id);
        // ------------------------------------------------------
        // Set properties or defaults
        // ------------------------------------------------------
        this.promptName = props.promptName;
        this.kmsKey = props.kmsKey;
        this.variants = props.variants ?? [];
        // ------------------------------------------------------
        // Validation
        // ------------------------------------------------------
        this.node.addValidation({ validate: () => this.validatePromptName() });
        this.node.addValidation({ validate: () => this.validatePromptVariants() });
        // ------------------------------------------------------
        // CFN Props - With Lazy support
        // ------------------------------------------------------
        let cfnProps = {
            customerEncryptionKeyArn: this.kmsKey?.keyArn,
            defaultVariant: props.defaultVariant?.name,
            description: props.description,
            name: props.promptName,
            variants: aws_cdk_lib_1.Lazy.any({
                produce: () => this.variants,
            }),
        };
        // Hash calculation useful for versioning
        this._hash = (0, helpers_internal_1.md5hash)(JSON.stringify(cfnProps));
        // ------------------------------------------------------
        // L1 Instantiation
        // ------------------------------------------------------
        this._resource = new aws_cdk_lib_1.aws_bedrock.CfnPrompt(this, 'Prompt', cfnProps);
        this.promptArn = this._resource.attrArn;
        this.promptId = this._resource.attrId;
        this.promptVersion = this._resource.attrVersion;
    }
    // ------------------------------------------------------
    // Validation Methods
    // ------------------------------------------------------
    /**
     * Validates whether the prompt name is valid according to the specification.
     * @see https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-bedrock-prompt.html#cfn-bedrock-prompt-name
     */
    validatePromptName() {
        const errors = [];
        const matchesPattern = /^([0-9a-zA-Z][_-]?){1,100}$/.test(this.promptName);
        if (!matchesPattern) {
            errors.push('Valid characters are a-z, A-Z, 0-9, _ (underscore) and - (hyphen). And must not begin with a hyphen');
        }
        if (errors.length > 0) {
            errors.unshift(`Invalid prompt name (value: ${this.promptName})`);
        }
        return errors;
    }
    /**
     * Validates whether the number of prompt variants is respected.
     */
    validatePromptVariants() {
        const MAX_VARIANTS = 3;
        const errors = [];
        if (this.variants.length > MAX_VARIANTS) {
            errors.push(`Error: Too many variants specified. The maximum allowed is ${MAX_VARIANTS}, but you have provided ${this.variants.length} variants.`);
        }
        return errors;
    }
    // ------------------------------------------------------
    // Helper Methods
    // ------------------------------------------------------
    /**
     * Creates a prompt version, a static snapshot of your prompt that can be
     * deployed to production.
     */
    createVersion(description) {
        const version = new aws_cdk_lib_1.aws_bedrock.CfnPromptVersion(this, `PromptVersion-${this._hash}`, {
            promptArn: this.promptArn,
            description,
        });
        this.promptVersion = version.attrVersion;
        return this.promptVersion;
    }
    /**
     * Adds a prompt variant.
     */
    addVariant(variant) {
        this.variants.push(variant);
    }
}
exports.Prompt = Prompt;
_b = JSII_RTTI_SYMBOL_1;
Prompt[_b] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.Prompt", version: "0.1.309" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvbXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2Nkay1saWIvYmVkcm9jay9wcm9tcHRzL3Byb21wdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBOzs7Ozs7Ozs7OztHQVdHO0FBRUgsNkNBQXFHO0FBQ3JHLGlEQUF3RDtBQUV4RCw0RUFBZ0U7QUFDaEUsMkNBQXVDO0FBK0J2Qzs7O0dBR0c7QUFDSCxNQUFzQixVQUFXLFNBQVEsc0JBQVE7SUFNL0M7O09BRUc7SUFDSSxRQUFRLENBQUMsT0FBbUI7UUFDakMsT0FBTyxlQUFLLENBQUMsY0FBYyxDQUFDO1lBQzFCLE9BQU87WUFDUCxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQzlCLE9BQU8sRUFBRSxDQUFDLG1CQUFtQixDQUFDO1lBQzlCLEtBQUssRUFBRSxJQUFJO1NBQ1osQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7QUFoQkgsZ0NBaUJDOzs7QUFzREQ7OytFQUUrRTtBQUMvRTs7Ozs7O0dBTUc7QUFDSCxNQUFhLE1BQU8sU0FBUSxzQkFBUztJQUNuQyx5REFBeUQ7SUFDekQsaUJBQWlCO0lBQ2pCLHlEQUF5RDtJQUNsRCxNQUFNLENBQUMsb0JBQW9CLENBQUMsS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBdUI7UUFDdEYsTUFBTSxZQUFZLEdBQUcsaUJBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSx1QkFBUyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDL0UsTUFBTSxNQUFPLFNBQVEsVUFBVTtZQUEvQjs7Z0JBQ2tCLGNBQVMsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO2dCQUM1QixhQUFRLEdBQUcsWUFBWSxDQUFDLFlBQWEsQ0FBQztnQkFDdEMsa0JBQWEsR0FBRyxLQUFLLENBQUMsYUFBYSxJQUFJLE9BQU8sQ0FBQztnQkFDL0MsV0FBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFDeEMs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QUUsQ0FBQztRQUM1QixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLFlBQVksRUFBRSxDQUFDO1lBQ3hDLE1BQU0sQ0FBQyxJQUFJLENBQ1QsOERBQThELFlBQVksMkJBQTJCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxZQUFZLENBQ3RJLENBQUM7UUFDSixDQUFDO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVELHlEQUF5RDtJQUN6RCxpQkFBaUI7SUFDakIseURBQXlEO0lBQ3pEOzs7T0FHRztJQUNJLGFBQWEsQ0FBQyxXQUFvQjtRQUN2QyxNQUFNLE9BQU8sR0FBRyxJQUFJLHlCQUFPLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLGlCQUFpQixJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDaEYsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLFdBQVc7U0FDWixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsYUFBYSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFDekMsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7T0FFRztJQUNJLFVBQVUsQ0FBQyxPQUFzQjtRQUN0QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QixDQUFDOztBQTNKSCx3QkE0SkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBBcm4sIEFybkZvcm1hdCwgYXdzX2ttcyBhcyBrbXMsIExhenksIGF3c19iZWRyb2NrIGFzIGJlZHJvY2ssIFJlc291cmNlIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgR3JhbnQsIElHcmFudGFibGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IElLZXkgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mta21zJztcbmltcG9ydCB7IG1kNWhhc2ggfSBmcm9tICdhd3MtY2RrLWxpYi9jb3JlL2xpYi9oZWxwZXJzLWludGVybmFsJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgUHJvbXB0VmFyaWFudCB9IGZyb20gJy4vcHJvbXB0LXZhcmlhbnQnO1xuXG4vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENPTU1PTlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuLyoqXG4gKiBSZXByZXNlbnRzIGEgUHJvbXB0LCBlaXRoZXIgY3JlYXRlZCB3aXRoIENESyBvciBpbXBvcnRlZC5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJUHJvbXB0IHtcbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhlIHByb21wdC5cbiAgICogQGV4YW1wbGUgXCJhcm46YXdzOmJlZHJvY2s6dXMtZWFzdC0xOjEyMzQ1Njc4OTAxMjpwcm9tcHQvUFJPTVBUMTIzNDVcIlxuICAgKi9cbiAgcmVhZG9ubHkgcHJvbXB0QXJuOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgSUQgb2YgdGhlIHByb21wdC5cbiAgICogQGV4YW1wbGUgXCJQUk9NUFQxMjM0NVwiXG4gICAqL1xuICByZWFkb25seSBwcm9tcHRJZDogc3RyaW5nO1xuICAvKipcbiAgICogT3B0aW9uYWwgS01TIGVuY3J5cHRpb24ga2V5IGFzc29jaWF0ZWQgd2l0aCB0aGlzIHByb21wdC5cbiAgICovXG4gIHJlYWRvbmx5IGttc0tleT86IElLZXk7XG4gIC8qKlxuICAgKiBUaGUgdmVyc2lvbiBvZiB0aGUgcHJvbXB0LlxuICAgKiBAZGVmYXVsdCAtIFwiRFJBRlRcIlxuICAgKi9cbiAgcHJvbXB0VmVyc2lvbjogc3RyaW5nO1xufVxuXG4vKipcbiAqIEFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIGEgUHJvbXB0LlxuICogQ29udGFpbnMgbWV0aG9kcyBhbmQgYXR0cmlidXRlcyB2YWxpZCBmb3IgUHJvbXRwcyBlaXRoZXIgY3JlYXRlZCB3aXRoIENESyBvciBpbXBvcnRlZC5cbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFByb21wdEJhc2UgZXh0ZW5kcyBSZXNvdXJjZSBpbXBsZW1lbnRzIElQcm9tcHQge1xuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkgcHJvbXB0QXJuOiBzdHJpbmc7XG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSBwcm9tcHRJZDogc3RyaW5nO1xuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkga21zS2V5PzogSUtleTtcbiAgcHVibGljIGFic3RyYWN0IHByb21wdFZlcnNpb246IHN0cmluZztcblxuICAvKipcbiAgICogR3JhbnQgdGhlIGdpdmVuIGlkZW50aXR5IHBlcm1pc3Npb25zIHRvIGdldCB0aGUgcHJvbXB0LlxuICAgKi9cbiAgcHVibGljIGdyYW50R2V0KGdyYW50ZWU6IElHcmFudGFibGUpOiBHcmFudCB7XG4gICAgcmV0dXJuIEdyYW50LmFkZFRvUHJpbmNpcGFsKHtcbiAgICAgIGdyYW50ZWUsXG4gICAgICByZXNvdXJjZUFybnM6IFt0aGlzLnByb21wdEFybl0sXG4gICAgICBhY3Rpb25zOiBbJ2JlZHJvY2s6R2V0UHJvbXB0J10sXG4gICAgICBzY29wZTogdGhpcyxcbiAgICB9KTtcbiAgfVxufVxuXG4vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gKiAgICAgICAgICAgICAgICAgICAgICAgIFBST1BTIEZPUiBORVcgQ09OU1RSVUNUXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvbXB0UHJvcHMge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIHByb21wdC5cbiAgICovXG4gIHJlYWRvbmx5IHByb21wdE5hbWU6IHN0cmluZztcbiAgLyoqXG4gICAqIEEgZGVzY3JpcHRpb24gb2Ygd2hhdCB0aGUgcHJvbXB0IGRvZXMuXG4gICAqIEBkZWZhdWx0IC0gTm8gZGVzY3JpcHRpb24gcHJvdmlkZWQuXG4gICAqL1xuICByZWFkb25seSBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBLTVMga2V5IHRoYXQgdGhlIHByb21wdCBpcyBlbmNyeXB0ZWQgd2l0aC5cbiAgICogQGRlZmF1bHQgLSBBV1Mgb3duZWQgYW5kIG1hbmFnZWQga2V5LlxuICAgKi9cbiAgcmVhZG9ubHkga21zS2V5Pzoga21zLklLZXk7XG4gIC8qKlxuICAgKiBUaGUgUHJvbXB0IFZhcmlhbnQgdGhhdCB3aWxsIGJlIHVzZWQgYnkgZGVmYXVsdC5cbiAgICogQGRlZmF1bHQgLSBObyBkZWZhdWx0IHZhcmlhbnQgcHJvdmlkZWQuXG4gICAqL1xuICByZWFkb25seSBkZWZhdWx0VmFyaWFudD86IFByb21wdFZhcmlhbnQ7XG4gIC8qKlxuICAgKiBUaGUgdmFyaWFudHMgb2YgeW91ciBwcm9tcHQuIFZhcmlhbnRzIGNhbiB1c2UgZGlmZmVyZW50IG1lc3NhZ2VzLCBtb2RlbHMsXG4gICAqIG9yIGNvbmZpZ3VyYXRpb25zIHNvIHRoYXQgeW91IGNhbiBjb21wYXJlIHRoZWlyIG91dHB1dHMgdG8gZGVjaWRlIHRoZSBiZXN0XG4gICAqIHZhcmlhbnQgZm9yIHlvdXIgdXNlIGNhc2UuIE1heGltdW0gb2YgMyB2YXJpYW50cy5cbiAgICovXG4gIHJlYWRvbmx5IHZhcmlhbnRzPzogUHJvbXB0VmFyaWFudFtdO1xufVxuXG4vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gKiAgICAgICAgICAgICAgICAgICAgICBBVFRSUyBGT1IgSU1QT1JURUQgQ09OU1RSVUNUXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5leHBvcnQgaW50ZXJmYWNlIFByb21wdEF0dHJpYnV0ZXMge1xuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgcHJvbXB0LlxuICAgKiBAZXhhbXBsZSBcImFybjphd3M6YmVkcm9jazp1cy1lYXN0LTE6MTIzNDU2Nzg5MDEyOnByb21wdC9QUk9NUFQxMjM0NVwiXG4gICAqL1xuICByZWFkb25seSBwcm9tcHRBcm46IHN0cmluZztcbiAgLyoqXG4gICAqIE9wdGlvbmFsIEtNUyBlbmNyeXB0aW9uIGtleSBhc3NvY2lhdGVkIHdpdGggdGhpcyBwcm9tcHQuXG4gICAqL1xuICByZWFkb25seSBrbXNLZXk/OiBJS2V5O1xuICAvKipcbiAgICogVGhlIHZlcnNpb24gb2YgdGhlIHByb21wdC5cbiAgICogQGRlZmF1bHQgLSBcIkRSQUZUXCJcbiAgICovXG4gIHJlYWRvbmx5IHByb21wdFZlcnNpb24/OiBzdHJpbmc7XG59XG5cbi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqICAgICAgICAgICAgICAgICAgICAgICAgTkVXIENPTlNUUlVDVCBERUZJTklUSU9OXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG4vKipcbiAqIFByb21wdHMgYXJlIGEgc3BlY2lmaWMgc2V0IG9mIGlucHV0cyB0aGF0IGd1aWRlIEZNcyBvbiBBbWF6b24gQmVkcm9jayB0b1xuICogZ2VuZXJhdGUgYW4gYXBwcm9wcmlhdGUgcmVzcG9uc2Ugb3Igb3V0cHV0IGZvciBhIGdpdmVuIHRhc2sgb3IgaW5zdHJ1Y3Rpb24uXG4gKiBZb3UgY2FuIG9wdGltaXplIHRoZSBwcm9tcHQgZm9yIHNwZWNpZmljIHVzZSBjYXNlcyBhbmQgbW9kZWxzLlxuICogQHJlc291cmNlIEFXUzo6QmVkcm9jazo6UHJvbXB0XG4gKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9iZWRyb2NrL2xhdGVzdC91c2VyZ3VpZGUvcHJvbXB0LW1hbmFnZW1lbnQuaHRtbFxuICovXG5leHBvcnQgY2xhc3MgUHJvbXB0IGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgSVByb21wdCB7XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBJbXBvcnQgTWV0aG9kc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcHVibGljIHN0YXRpYyBmcm9tUHJvbXB0QXR0cmlidXRlcyhzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBhdHRyczogUHJvbXB0QXR0cmlidXRlcyk6IElQcm9tcHQge1xuICAgIGNvbnN0IGZvcm1hdHRlZEFybiA9IEFybi5zcGxpdChhdHRycy5wcm9tcHRBcm4sIEFybkZvcm1hdC5TTEFTSF9SRVNPVVJDRV9OQU1FKTtcbiAgICBjbGFzcyBJbXBvcnQgZXh0ZW5kcyBQcm9tcHRCYXNlIHtcbiAgICAgIHB1YmxpYyByZWFkb25seSBwcm9tcHRBcm4gPSBhdHRycy5wcm9tcHRBcm47XG4gICAgICBwdWJsaWMgcmVhZG9ubHkgcHJvbXB0SWQgPSBmb3JtYXR0ZWRBcm4ucmVzb3VyY2VOYW1lITtcbiAgICAgIHB1YmxpYyByZWFkb25seSBwcm9tcHRWZXJzaW9uID0gYXR0cnMucHJvbXB0VmVyc2lvbiA/PyAnRFJBRlQnO1xuICAgICAgcHVibGljIHJlYWRvbmx5IGttc0tleSA9IGF0dHJzLmttc0tleTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEltcG9ydChzY29wZSwgaWQpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBBdHRyaWJ1dGVzXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIHByb21wdC5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBwcm9tcHROYW1lOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgS01TIGtleSB0aGF0IHRoZSBwcm9tcHQgaXMgZW5jcnlwdGVkIHdpdGguXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkga21zS2V5PzogSUtleTtcbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhlIHByb21wdC5cbiAgICogQGV4YW1wbGUgXCJhcm46YXdzOmJlZHJvY2s6dXMtZWFzdC0xOjEyMzQ1Njc4OTAxMjpwcm9tcHQvUFJPTVBUMTIzNDVcIlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHByb21wdEFybjogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIElEIG9mIHRoZSBwcm9tcHQuXG4gICAqIEBleGFtcGxlIFwiUFJPTVBUMTIzNDVcIlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHByb21wdElkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgdmVyc2lvbiBvZiB0aGUgcHJvbXB0LlxuICAgKi9cbiAgcHVibGljIHByb21wdFZlcnNpb246IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSB2YXJpYW50cyBvZiB0aGUgcHJvbXB0LlxuICAgKi9cbiAgcmVhZG9ubHkgdmFyaWFudHM6IFByb21wdFZhcmlhbnRbXTtcbiAgLyoqXG4gICAqIFRoZSBjb21wdXRlZCBoYXNoIG9mIHRoZSBwcm9tcHQgcHJvcGVydGllcy5cbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgX2hhc2g6IHN0cmluZztcbiAgLyoqXG4gICAqIEwxIHJlc291cmNlXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IF9yZXNvdXJjZTogYmVkcm9jay5DZm5Qcm9tcHQ7XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIENvbnN0cnVjdG9yXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogUHJvbXB0UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIFNldCBwcm9wZXJ0aWVzIG9yIGRlZmF1bHRzXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5wcm9tcHROYW1lID0gcHJvcHMucHJvbXB0TmFtZTtcbiAgICB0aGlzLmttc0tleSA9IHByb3BzLmttc0tleTtcbiAgICB0aGlzLnZhcmlhbnRzID0gcHJvcHMudmFyaWFudHMgPz8gW107XG5cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBWYWxpZGF0aW9uXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5ub2RlLmFkZFZhbGlkYXRpb24oeyB2YWxpZGF0ZTogKCkgPT4gdGhpcy52YWxpZGF0ZVByb21wdE5hbWUoKSB9KTtcbiAgICB0aGlzLm5vZGUuYWRkVmFsaWRhdGlvbih7IHZhbGlkYXRlOiAoKSA9PiB0aGlzLnZhbGlkYXRlUHJvbXB0VmFyaWFudHMoKSB9KTtcblxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIENGTiBQcm9wcyAtIFdpdGggTGF6eSBzdXBwb3J0XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgbGV0IGNmblByb3BzOiBiZWRyb2NrLkNmblByb21wdFByb3BzID0ge1xuICAgICAgY3VzdG9tZXJFbmNyeXB0aW9uS2V5QXJuOiB0aGlzLmttc0tleT8ua2V5QXJuLFxuICAgICAgZGVmYXVsdFZhcmlhbnQ6IHByb3BzLmRlZmF1bHRWYXJpYW50Py5uYW1lLFxuICAgICAgZGVzY3JpcHRpb246IHByb3BzLmRlc2NyaXB0aW9uLFxuICAgICAgbmFtZTogcHJvcHMucHJvbXB0TmFtZSxcbiAgICAgIHZhcmlhbnRzOiBMYXp5LmFueSh7XG4gICAgICAgIHByb2R1Y2U6ICgpID0+IHRoaXMudmFyaWFudHMsXG4gICAgICB9KSxcbiAgICB9O1xuXG4gICAgLy8gSGFzaCBjYWxjdWxhdGlvbiB1c2VmdWwgZm9yIHZlcnNpb25pbmdcbiAgICB0aGlzLl9oYXNoID0gbWQ1aGFzaChKU09OLnN0cmluZ2lmeShjZm5Qcm9wcykpO1xuXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gTDEgSW5zdGFudGlhdGlvblxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMuX3Jlc291cmNlID0gbmV3IGJlZHJvY2suQ2ZuUHJvbXB0KHRoaXMsICdQcm9tcHQnLCBjZm5Qcm9wcyk7XG5cbiAgICB0aGlzLnByb21wdEFybiA9IHRoaXMuX3Jlc291cmNlLmF0dHJBcm47XG4gICAgdGhpcy5wcm9tcHRJZCA9IHRoaXMuX3Jlc291cmNlLmF0dHJJZDtcbiAgICB0aGlzLnByb21wdFZlcnNpb24gPSB0aGlzLl9yZXNvdXJjZS5hdHRyVmVyc2lvbjtcbiAgfVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBWYWxpZGF0aW9uIE1ldGhvZHNcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMgd2hldGhlciB0aGUgcHJvbXB0IG5hbWUgaXMgdmFsaWQgYWNjb3JkaW5nIHRvIHRoZSBzcGVjaWZpY2F0aW9uLlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9BV1NDbG91ZEZvcm1hdGlvbi9sYXRlc3QvVXNlckd1aWRlL2F3cy1yZXNvdXJjZS1iZWRyb2NrLXByb21wdC5odG1sI2Nmbi1iZWRyb2NrLXByb21wdC1uYW1lXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlUHJvbXB0TmFtZSgpIHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBjb25zdCBtYXRjaGVzUGF0dGVybiA9IC9eKFswLTlhLXpBLVpdW18tXT8pezEsMTAwfSQvLnRlc3QodGhpcy5wcm9tcHROYW1lKTtcbiAgICBpZiAoIW1hdGNoZXNQYXR0ZXJuKSB7XG4gICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgJ1ZhbGlkIGNoYXJhY3RlcnMgYXJlIGEteiwgQS1aLCAwLTksIF8gKHVuZGVyc2NvcmUpIGFuZCAtIChoeXBoZW4pLiBBbmQgbXVzdCBub3QgYmVnaW4gd2l0aCBhIGh5cGhlbicsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgIGVycm9ycy51bnNoaWZ0KGBJbnZhbGlkIHByb21wdCBuYW1lICh2YWx1ZTogJHt0aGlzLnByb21wdE5hbWV9KWApO1xuICAgIH1cbiAgICByZXR1cm4gZXJyb3JzO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlcyB3aGV0aGVyIHRoZSBudW1iZXIgb2YgcHJvbXB0IHZhcmlhbnRzIGlzIHJlc3BlY3RlZC5cbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVQcm9tcHRWYXJpYW50cygpIHtcbiAgICBjb25zdCBNQVhfVkFSSUFOVFMgPSAzO1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAodGhpcy52YXJpYW50cy5sZW5ndGggPiBNQVhfVkFSSUFOVFMpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgRXJyb3I6IFRvbyBtYW55IHZhcmlhbnRzIHNwZWNpZmllZC4gVGhlIG1heGltdW0gYWxsb3dlZCBpcyAke01BWF9WQVJJQU5UU30sIGJ1dCB5b3UgaGF2ZSBwcm92aWRlZCAke3RoaXMudmFyaWFudHMubGVuZ3RofSB2YXJpYW50cy5gLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGVycm9ycztcbiAgfVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBIZWxwZXIgTWV0aG9kc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBwcm9tcHQgdmVyc2lvbiwgYSBzdGF0aWMgc25hcHNob3Qgb2YgeW91ciBwcm9tcHQgdGhhdCBjYW4gYmVcbiAgICogZGVwbG95ZWQgdG8gcHJvZHVjdGlvbi5cbiAgICovXG4gIHB1YmxpYyBjcmVhdGVWZXJzaW9uKGRlc2NyaXB0aW9uPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCB2ZXJzaW9uID0gbmV3IGJlZHJvY2suQ2ZuUHJvbXB0VmVyc2lvbih0aGlzLCBgUHJvbXB0VmVyc2lvbi0ke3RoaXMuX2hhc2h9YCwge1xuICAgICAgcHJvbXB0QXJuOiB0aGlzLnByb21wdEFybixcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgIH0pO1xuICAgIHRoaXMucHJvbXB0VmVyc2lvbiA9IHZlcnNpb24uYXR0clZlcnNpb247XG4gICAgcmV0dXJuIHRoaXMucHJvbXB0VmVyc2lvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgcHJvbXB0IHZhcmlhbnQuXG4gICAqL1xuICBwdWJsaWMgYWRkVmFyaWFudCh2YXJpYW50OiBQcm9tcHRWYXJpYW50KSB7XG4gICAgdGhpcy52YXJpYW50cy5wdXNoKHZhcmlhbnQpO1xuICB9XG59XG4iXX0=