"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.OpenSearchIndexCRProvider = exports.VectorIndex = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const path = require("path");
const cdk = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const oss = require("aws-cdk-lib/aws-opensearchserverless");
const custom_resource_provider_helper_1 = require("../../common/helpers/custom-resource-provider-helper");
const utils_1 = require("../../common/helpers/utils");
/**
 * Deploy a vector index on the collection.
 */
class VectorIndex extends cdk.Resource {
    constructor(scope, id, props) {
        super(scope, id);
        this.indexName = props.indexName;
        this.vectorField = props.vectorField;
        this.vectorDimensions = props.vectorDimensions;
        const crProvider = exports.OpenSearchIndexCRProvider.getProvider(this);
        crProvider.role.addManagedPolicy(props.collection.aossPolicy);
        const manageIndexPolicyName = (0, utils_1.generatePhysicalNameV2)(this, 'ManageIndexPolicy', { maxLength: 32, lower: true });
        const manageIndexPolicy = new oss.CfnAccessPolicy(this, 'ManageIndexPolicy', {
            name: manageIndexPolicyName,
            type: 'data',
            policy: JSON.stringify([
                {
                    Rules: [
                        {
                            Resource: [`index/${props.collection.collectionName}/*`],
                            Permission: [
                                'aoss:DescribeIndex',
                                'aoss:CreateIndex',
                                'aoss:DeleteIndex',
                                'aoss:UpdateIndex',
                            ],
                            ResourceType: 'index',
                        },
                        {
                            Resource: [`collection/${props.collection.collectionName}`],
                            Permission: ['aoss:DescribeCollectionItems'],
                            ResourceType: 'collection',
                        },
                    ],
                    Principal: [crProvider.role.roleArn],
                    Description: '',
                },
            ]),
        });
        const analyzerProps = props.analyzer
            ? {
                CharacterFilters: props.analyzer.characterFilters,
                Tokenizer: props.analyzer.tokenizer,
                TokenFilters: props.analyzer.tokenFilters,
            }
            : undefined;
        const vectorIndex = new cdk.CustomResource(this, 'VectorIndex', {
            serviceToken: crProvider.serviceToken,
            properties: {
                Endpoint: `${props.collection.collectionId}.${cdk.Stack.of(this).region}.aoss.amazonaws.com`,
                IndexName: props.indexName,
                VectorField: props.vectorField,
                Dimensions: props.vectorDimensions,
                Precision: props.precision,
                DistanceType: props.distanceType,
                MetadataManagement: props.mappings.map((m) => {
                    return {
                        MappingField: m.mappingField,
                        DataType: m.dataType,
                        Filterable: m.filterable,
                    };
                }),
                Analyzer: analyzerProps,
            },
            resourceType: 'Custom::OpenSearchIndex',
        });
        vectorIndex.node.addDependency(manageIndexPolicy);
        vectorIndex.node.addDependency(props.collection);
        vectorIndex.node.addDependency(props.collection.dataAccessPolicy);
    }
}
exports.VectorIndex = VectorIndex;
_a = JSII_RTTI_SYMBOL_1;
VectorIndex[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.opensearch_vectorindex.VectorIndex", version: "0.1.309" };
/**
 * Custom Resource provider for OpenSearch Index operations.
 *
 * @internal This is an internal core function and should not be called directly by Solutions Constructs clients.
 */
exports.OpenSearchIndexCRProvider = (0, custom_resource_provider_helper_1.buildCustomResourceProvider)({
    providerName: 'OpenSearchIndexCRProvider',
    codePath: path.join(__dirname, '../../../lambda/opensearch-serverless-custom-resources'),
    handler: 'custom_resources.on_event',
    runtime: lambda.Runtime.PYTHON_3_12,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVjdG9yLWluZGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2Nkay1saWIvb3BlbnNlYXJjaC12ZWN0b3JpbmRleC92ZWN0b3ItaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7R0FXRztBQUVILDZCQUE2QjtBQUM3QixtQ0FBbUM7QUFDbkMsaURBQWlEO0FBQ2pELDREQUE0RDtBQUU1RCwwR0FBbUc7QUFDbkcsc0RBQW9FO0FBOEpwRTs7R0FFRztBQUNILE1BQWEsV0FBWSxTQUFRLEdBQUcsQ0FBQyxRQUFRO0lBYzNDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBdUI7UUFDL0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDakMsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLENBQUM7UUFFL0MsTUFBTSxVQUFVLEdBQUcsaUNBQXlCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9ELFVBQVUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUU5RCxNQUFNLHFCQUFxQixHQUFHLElBQUEsOEJBQXNCLEVBQ2xELElBQUksRUFDSixtQkFBbUIsRUFDbkIsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FDL0IsQ0FBQztRQUNGLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUMvQyxJQUFJLEVBQ0osbUJBQW1CLEVBQ25CO1lBQ0UsSUFBSSxFQUFFLHFCQUFxQjtZQUMzQixJQUFJLEVBQUUsTUFBTTtZQUNaLE1BQU0sRUFB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LCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgb3NzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1vcGVuc2VhcmNoc2VydmVybGVzcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IGJ1aWxkQ3VzdG9tUmVzb3VyY2VQcm92aWRlciB9IGZyb20gJy4uLy4uL2NvbW1vbi9oZWxwZXJzL2N1c3RvbS1yZXNvdXJjZS1wcm92aWRlci1oZWxwZXInO1xuaW1wb3J0IHsgZ2VuZXJhdGVQaHlzaWNhbE5hbWVWMiB9IGZyb20gJy4uLy4uL2NvbW1vbi9oZWxwZXJzL3V0aWxzJztcbmltcG9ydCB7IFZlY3RvckNvbGxlY3Rpb24gfSBmcm9tICcuLi9vcGVuc2VhcmNoc2VydmVybGVzcyc7XG5pbXBvcnQge1xuICBDaGFyYWN0ZXJGaWx0ZXJUeXBlLFxuICBUb2tlbkZpbHRlclR5cGUsXG4gIFRva2VuaXplclR5cGUsXG59IGZyb20gJy4uL29wZW5zZWFyY2hzZXJ2ZXJsZXNzL2FuYWx5c2lzLXBsdWdpbnMnO1xuXG4vKipcbiAqIE1ldGFkYXRhIGZpZWxkIGRlZmluaXRpb25zLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE1ldGFkYXRhTWFuYWdlbWVudEZpZWxkUHJvcHMge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGZpZWxkLlxuICAgKi9cbiAgcmVhZG9ubHkgbWFwcGluZ0ZpZWxkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgZGF0YSB0eXBlIG9mIHRoZSBmaWVsZC5cbiAgICovXG4gIHJlYWRvbmx5IGRhdGFUeXBlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoZSBmaWVsZCBpcyBmaWx0ZXJhYmxlLlxuICAgKi9cbiAgcmVhZG9ubHkgZmlsdGVyYWJsZTogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBNZXRhZGF0YSBmaWVsZCBkZWZpbml0aW9ucyBhcyB0aGUgQVBJIGV4cGVjdHMgdGhlbS5cbiAqXG4gKiBAaW50ZXJuYWwgLSBKU0lJIHJlcXVpcmVzIHRoZSBleHBvcnRlZCBpbnRlcmZhY2UgdG8gaGF2ZSBjYW1lbCBjYW1lbENhc2UgcHJvcGVydGllcyxcbiAqIGJ1dCB0aGUgQVBJIGV4cGVjdCBQYXNjYWxDYXNlIHByb3BlcnRpZXNcbiAqL1xudHlwZSBNZXRhZGF0YU1hbmFnZW1lbnRGaWVsZCA9IHtcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBmaWVsZC5cbiAgICovXG4gIHJlYWRvbmx5IE1hcHBpbmdGaWVsZDogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIGRhdGEgdHlwZSBvZiB0aGUgZmllbGQuXG4gICAqL1xuICByZWFkb25seSBEYXRhVHlwZTogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0aGUgZmllbGQgaXMgZmlsdGVyYWJsZS5cbiAgICovXG4gIHJlYWRvbmx5IEZpbHRlcmFibGU6IGJvb2xlYW47XG59O1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIHRoZSBDdXN0b206Ok9wZW5TZWFyY2hJbmRleCBjdXN0b20gcmVzb3VyY2UuXG4gKlxuICogQGludGVybmFsXG4gKi9cbmludGVyZmFjZSBWZWN0b3JJbmRleFJlc291cmNlUHJvcHMge1xuICAvKipcbiAgICogVGhlIE9wZW5TZWFyY2ggRW5kcG9pbnQuXG4gICAqL1xuICByZWFkb25seSBFbmRwb2ludDogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIGluZGV4LlxuICAgKi9cbiAgcmVhZG9ubHkgSW5kZXhOYW1lOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgdmVjdG9yIGZpZWxkLlxuICAgKi9cbiAgcmVhZG9ubHkgVmVjdG9yRmllbGQ6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBudW1iZXIgb2YgZGltZW5zaW9ucyBpbiB0aGUgdmVjdG9yLlxuICAgKi9cbiAgcmVhZG9ubHkgRGltZW5zaW9uczogbnVtYmVyO1xuICAvKipcbiAgICogVGhlIGRhdGFfdHlwZSBvZiB0aGUgYmluYXJ5IHZlY3RvciBpbmRleC5cbiAgICovXG4gIHJlYWRvbmx5IFByZWNpc2lvbjogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIHNwYWNlX3R5cGUgb2YgdGhlIGJpbmFyeSB2ZWN0b3IgaW5kZXguXG4gICAqL1xuICByZWFkb25seSBEaXN0YW5jZVR5cGU6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBtZXRhZGF0YSBtYW5hZ2VtZW50IGZpZWxkcy5cbiAgICovXG4gIHJlYWRvbmx5IE1ldGFkYXRhTWFuYWdlbWVudDogTWV0YWRhdGFNYW5hZ2VtZW50RmllbGRbXTtcbiAgLyoqXG4gICAqIFRoZSBhbmFseXplciB0byB1c2UuXG4gICAqL1xuICByZWFkb25seSBBbmFseXplcj86IEFuYWx5emVyUHJvcHM7XG59XG5cbi8qKlxuICogUHJvcGVydGllcyBmb3IgdGhlIEFuYWx5emVyIHVzZWQgaW4gQ3VzdG9tOjpPcGVuU2VhcmNoSW5kZXggY3VzdG9tIHJlc291cmNlLlxuICpcbiAqIEBpbnRlcm5hbCAtIEpTSUkgcmVxdWlyZXMgdGhlIGV4cG9ydGVkIGludGVyZmFjZSB0byBoYXZlIGNhbWVsIGNhbWVsQ2FzZSBwcm9wZXJ0aWVzXG4gKi9cbmludGVyZmFjZSBBbmFseXplclByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBhbmFseXplcnMgdG8gdXNlLlxuICAgKi9cbiAgcmVhZG9ubHkgQ2hhcmFjdGVyRmlsdGVyczogQ2hhcmFjdGVyRmlsdGVyVHlwZVtdO1xuICAvKipcbiAgICogVGhlIHRva2VuaXplciB0byB1c2UuXG4gICAqL1xuICByZWFkb25seSBUb2tlbml6ZXI6IFRva2VuaXplclR5cGU7XG4gIC8qKlxuICAgKiBUaGUgdG9rZW4gZmlsdGVycyB0byB1c2UuXG4gICAqL1xuICByZWFkb25seSBUb2tlbkZpbHRlcnM6IFRva2VuRmlsdGVyVHlwZVtdO1xufVxuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIHRoZSBBbmFseXplci5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBbmFseXplciB7XG4gIC8qKlxuICAgKiBUaGUgYW5hbHl6ZXJzIHRvIHVzZS5cbiAgICovXG4gIHJlYWRvbmx5IGNoYXJhY3RlckZpbHRlcnM6IENoYXJhY3RlckZpbHRlclR5cGVbXTtcbiAgLyoqXG4gICAqIFRoZSB0b2tlbml6ZXIgdG8gdXNlLlxuICAgKi9cbiAgcmVhZG9ubHkgdG9rZW5pemVyOiBUb2tlbml6ZXJUeXBlO1xuICAvKipcbiAgICogVGhlIHRva2VuIGZpbHRlcnMgdG8gdXNlLlxuICAgKi9cbiAgcmVhZG9ubHkgdG9rZW5GaWx0ZXJzOiBUb2tlbkZpbHRlclR5cGVbXTtcbn1cblxuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciB0aGUgVmVjdG9ySW5kZXguXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVmVjdG9ySW5kZXhQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgT3BlblNlYXJjaCBWZWN0b3IgQ29sbGVjdGlvbi5cbiAgICovXG4gIHJlYWRvbmx5IGNvbGxlY3Rpb246IFZlY3RvckNvbGxlY3Rpb247XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgaW5kZXguXG4gICAqL1xuICByZWFkb25seSBpbmRleE5hbWU6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSB2ZWN0b3IgZmllbGQuXG4gICAqL1xuICByZWFkb25seSB2ZWN0b3JGaWVsZDogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIG51bWJlciBvZiBkaW1lbnNpb25zIGluIHRoZSB2ZWN0b3IuXG4gICAqL1xuICByZWFkb25seSB2ZWN0b3JEaW1lbnNpb25zOiBudW1iZXI7XG4gIHJlYWRvbmx5IHByZWNpc2lvbjogc3RyaW5nO1xuICByZWFkb25seSBkaXN0YW5jZVR5cGU6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBtZXRhZGF0YSBtYW5hZ2VtZW50IGZpZWxkcy5cbiAgICovXG4gIHJlYWRvbmx5IG1hcHBpbmdzOiBNZXRhZGF0YU1hbmFnZW1lbnRGaWVsZFByb3BzW107XG4gIC8qKlxuICAgKiBUaGUgYW5hbHl6ZXIgdG8gdXNlLlxuICAgKiBAZGVmYXVsdCAtIE5vIGFuYWx5emVyLlxuICAgKi9cbiAgcmVhZG9ubHkgYW5hbHl6ZXI/OiBBbmFseXplcjtcbn1cblxuLyoqXG4gKiBEZXBsb3kgYSB2ZWN0b3IgaW5kZXggb24gdGhlIGNvbGxlY3Rpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBWZWN0b3JJbmRleCBleHRlbmRzIGNkay5SZXNvdXJjZSB7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgaW5kZXguXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgaW5kZXhOYW1lOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgdmVjdG9yIGZpZWxkLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHZlY3RvckZpZWxkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIGRpbWVuc2lvbnMgaW4gdGhlIHZlY3Rvci5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSB2ZWN0b3JEaW1lbnNpb25zOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFZlY3RvckluZGV4UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5pbmRleE5hbWUgPSBwcm9wcy5pbmRleE5hbWU7XG4gICAgdGhpcy52ZWN0b3JGaWVsZCA9IHByb3BzLnZlY3RvckZpZWxkO1xuICAgIHRoaXMudmVjdG9yRGltZW5zaW9ucyA9IHByb3BzLnZlY3RvckRpbWVuc2lvbnM7XG5cbiAgICBjb25zdCBjclByb3ZpZGVyID0gT3BlblNlYXJjaEluZGV4Q1JQcm92aWRlci5nZXRQcm92aWRlcih0aGlzKTtcbiAgICBjclByb3ZpZGVyLnJvbGUuYWRkTWFuYWdlZFBvbGljeShwcm9wcy5jb2xsZWN0aW9uLmFvc3NQb2xpY3kpO1xuXG4gICAgY29uc3QgbWFuYWdlSW5kZXhQb2xpY3lOYW1lID0gZ2VuZXJhdGVQaHlzaWNhbE5hbWVWMihcbiAgICAgIHRoaXMsXG4gICAgICAnTWFuYWdlSW5kZXhQb2xpY3knLFxuICAgICAgeyBtYXhMZW5ndGg6IDMyLCBsb3dlcjogdHJ1ZSB9LFxuICAgICk7XG4gICAgY29uc3QgbWFuYWdlSW5kZXhQb2xpY3kgPSBuZXcgb3NzLkNmbkFjY2Vzc1BvbGljeShcbiAgICAgIHRoaXMsXG4gICAgICAnTWFuYWdlSW5kZXhQb2xpY3knLFxuICAgICAge1xuICAgICAgICBuYW1lOiBtYW5hZ2VJbmRleFBvbGljeU5hbWUsXG4gICAgICAgIHR5cGU6ICdkYXRhJyxcbiAgICAgICAgcG9saWN5OiBKU09OLnN0cmluZ2lmeShbXG4gICAgICAgICAge1xuICAgICAgICAgICAgUnVsZXM6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIFJlc291cmNlOiBbYGluZGV4LyR7cHJvcHMuY29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZX0vKmBdLFxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb246IFtcbiAgICAgICAgICAgICAgICAgICdhb3NzOkRlc2NyaWJlSW5kZXgnLFxuICAgICAgICAgICAgICAgICAgJ2Fvc3M6Q3JlYXRlSW5kZXgnLFxuICAgICAgICAgICAgICAgICAgJ2Fvc3M6RGVsZXRlSW5kZXgnLFxuICAgICAgICAgICAgICAgICAgJ2Fvc3M6VXBkYXRlSW5kZXgnLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgUmVzb3VyY2VUeXBlOiAnaW5kZXgnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgUmVzb3VyY2U6IFtgY29sbGVjdGlvbi8ke3Byb3BzLmNvbGxlY3Rpb24uY29sbGVjdGlvbk5hbWV9YF0sXG4gICAgICAgICAgICAgICAgUGVybWlzc2lvbjogWydhb3NzOkRlc2NyaWJlQ29sbGVjdGlvbkl0ZW1zJ10sXG4gICAgICAgICAgICAgICAgUmVzb3VyY2VUeXBlOiAnY29sbGVjdGlvbicsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgUHJpbmNpcGFsOiBbY3JQcm92aWRlci5yb2xlLnJvbGVBcm5dLFxuICAgICAgICAgICAgRGVzY3JpcHRpb246ICcnLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0pLFxuICAgICAgfSxcbiAgICApO1xuXG4gICAgY29uc3QgYW5hbHl6ZXJQcm9wcyA9IHByb3BzLmFuYWx5emVyXG4gICAgICA/IHtcbiAgICAgICAgQ2hhcmFjdGVyRmlsdGVyczogcHJvcHMuYW5hbHl6ZXIuY2hhcmFjdGVyRmlsdGVycyxcbiAgICAgICAgVG9rZW5pemVyOiBwcm9wcy5hbmFseXplci50b2tlbml6ZXIsXG4gICAgICAgIFRva2VuRmlsdGVyczogcHJvcHMuYW5hbHl6ZXIudG9rZW5GaWx0ZXJzLFxuICAgICAgfVxuICAgICAgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgdmVjdG9ySW5kZXggPSBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHRoaXMsICdWZWN0b3JJbmRleCcsIHtcbiAgICAgIHNlcnZpY2VUb2tlbjogY3JQcm92aWRlci5zZXJ2aWNlVG9rZW4sXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIEVuZHBvaW50OiBgJHtwcm9wcy5jb2xsZWN0aW9uLmNvbGxlY3Rpb25JZH0uJHtcbiAgICAgICAgICBjZGsuU3RhY2sub2YodGhpcykucmVnaW9uXG4gICAgICAgIH0uYW9zcy5hbWF6b25hd3MuY29tYCxcbiAgICAgICAgSW5kZXhOYW1lOiBwcm9wcy5pbmRleE5hbWUsXG4gICAgICAgIFZlY3RvckZpZWxkOiBwcm9wcy52ZWN0b3JGaWVsZCxcbiAgICAgICAgRGltZW5zaW9uczogcHJvcHMudmVjdG9yRGltZW5zaW9ucyxcbiAgICAgICAgUHJlY2lzaW9uOiBwcm9wcy5wcmVjaXNpb24sXG4gICAgICAgIERpc3RhbmNlVHlwZTogcHJvcHMuZGlzdGFuY2VUeXBlLFxuICAgICAgICBNZXRhZGF0YU1hbmFnZW1lbnQ6IHByb3BzLm1hcHBpbmdzLm1hcCgobSkgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBNYXBwaW5nRmllbGQ6IG0ubWFwcGluZ0ZpZWxkLFxuICAgICAgICAgICAgRGF0YVR5cGU6IG0uZGF0YVR5cGUsXG4gICAgICAgICAgICBGaWx0ZXJhYmxlOiBtLmZpbHRlcmFibGUsXG4gICAgICAgICAgfTtcbiAgICAgICAgfSksXG4gICAgICAgIEFuYWx5emVyOiBhbmFseXplclByb3BzLFxuICAgICAgfSBhcyBWZWN0b3JJbmRleFJlc291cmNlUHJvcHMsXG4gICAgICByZXNvdXJjZVR5cGU6ICdDdXN0b206Ok9wZW5TZWFyY2hJbmRleCcsXG4gICAgfSk7XG5cbiAgICB2ZWN0b3JJbmRleC5ub2RlLmFkZERlcGVuZGVuY3kobWFuYWdlSW5kZXhQb2xpY3kpO1xuICAgIHZlY3RvckluZGV4Lm5vZGUuYWRkRGVwZW5kZW5jeShwcm9wcy5jb2xsZWN0aW9uKTtcbiAgICB2ZWN0b3JJbmRleC5ub2RlLmFkZERlcGVuZGVuY3kocHJvcHMuY29sbGVjdGlvbi5kYXRhQWNjZXNzUG9saWN5KTtcbiAgfVxufVxuXG4vKipcbiAqIEN1c3RvbSBSZXNvdXJjZSBwcm92aWRlciBmb3IgT3BlblNlYXJjaCBJbmRleCBvcGVyYXRpb25zLlxuICpcbiAqIEBpbnRlcm5hbCBUaGlzIGlzIGFuIGludGVybmFsIGNvcmUgZnVuY3Rpb24gYW5kIHNob3VsZCBub3QgYmUgY2FsbGVkIGRpcmVjdGx5IGJ5IFNvbHV0aW9ucyBDb25zdHJ1Y3RzIGNsaWVudHMuXG4gKi9cbmV4cG9ydCBjb25zdCBPcGVuU2VhcmNoSW5kZXhDUlByb3ZpZGVyID0gYnVpbGRDdXN0b21SZXNvdXJjZVByb3ZpZGVyKHtcbiAgcHJvdmlkZXJOYW1lOiAnT3BlblNlYXJjaEluZGV4Q1JQcm92aWRlcicsXG4gIGNvZGVQYXRoOiBwYXRoLmpvaW4oXG4gICAgX19kaXJuYW1lLCAnLi4vLi4vLi4vbGFtYmRhL29wZW5zZWFyY2gtc2VydmVybGVzcy1jdXN0b20tcmVzb3VyY2VzJyksXG4gIGhhbmRsZXI6ICdjdXN0b21fcmVzb3VyY2VzLm9uX2V2ZW50JyxcbiAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfMTIsXG59KTtcbiJdfQ==