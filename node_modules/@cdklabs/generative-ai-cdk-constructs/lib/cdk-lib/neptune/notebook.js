"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.NeptuneGraphNotebook = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const aws_cdk_lib_1 = require("aws-cdk-lib");
const ec2 = require("aws-cdk-lib/aws-ec2");
const iam = require("aws-cdk-lib/aws-iam");
const sagemaker = require("aws-cdk-lib/aws-sagemaker");
const utils_1 = require("../../common/helpers/utils");
/**
 * Creates a Neptune Graph Notebook for a given graph.
 *
 * A Neptune Graph Notebook provides:
 * - Web-based interactive environment for querying and visualizing graph data
 * - Support for multiple query languages:
 *   - OpenCypher for property graph queries
 *   - Gremlin for traversal-based queries
 *   - SPARQL for RDF graph queries
 * - Built-in visualization capabilities for exploring graph relationships
 * - Sample notebooks and tutorials to help you get started
 * - Integration with popular data science libraries   *
 * This option is only supported when `publicConnectivity` is set to `true`. For private graphs,
 * you should create your own notebook deployment using the `NeptuneGraphNotebook` Construct and
 * configure the appropriate VPC and security group settings.
 *
 * **Note: Creating a notebook will incur additional AWS costs for the notebook instance.**
 *
 * @see https://docs.aws.amazon.com/neptune/latest/userguide/graph-notebooks.html
 */
class NeptuneGraphNotebook extends aws_cdk_lib_1.Resource {
    // ------------------------------------------------------
    // Attributes
    // ------------------------------------------------------
    constructor(scope, id, props) {
        super(scope, id);
        const region = aws_cdk_lib_1.Stack.of(scope).region;
        // Set properties
        this.volumeSize = props.volumeSize ?? aws_cdk_lib_1.Size.gibibytes(5);
        this.instanceType =
            props.instanceType ?? ec2.InstanceType.of(ec2.InstanceClass.T3, ec2.InstanceSize.MEDIUM);
        // Create lifecycle configuration for Neptune notebook
        this.lifecycleConfig = new sagemaker.CfnNotebookInstanceLifecycleConfig(this, 'NeptuneNotebookLifecycle', {
            onStart: [
                {
                    content: aws_cdk_lib_1.Fn.base64(`#!/bin/bash
sudo -u ec2-user -i <<'EOF'

echo "export GRAPH_NOTEBOOK_AUTH_MODE=IAM" >> ~/.bashrc
echo "export GRAPH_NOTEBOOK_SSL=True" >> ~/.bashrc
echo "export GRAPH_NOTEBOOK_SERVICE=neptune-graph" >> ~/.bashrc
echo "export GRAPH_NOTEBOOK_HOST=${props.graph.graphEndpoint}" >> ~/.bashrc
echo "export GRAPH_NOTEBOOK_PORT=8182" >> ~/.bashrc
echo "export NEPTUNE_LOAD_FROM_S3_ROLE_ARN=" >> ~/.bashrc
echo "export AWS_REGION=${region}" >> ~/.bashrc

aws s3 cp s3://aws-neptune-notebook-${region}/graph_notebook.tar.gz /tmp/graph_notebook.tar.gz
rm -rf /tmp/graph_notebook
tar -zxvf /tmp/graph_notebook.tar.gz -C /tmp
/tmp/graph_notebook/install.sh

EOF`),
                },
            ],
        });
        // Creates a role associated to the notebook instance
        this.role = new iam.Role(this, 'NeptuneNotebookRole', {
            assumedBy: new iam.ServicePrincipal('sagemaker.amazonaws.com'),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonSageMakerFullAccess'),
                // Allows downloading the graph_notebook package
                iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonS3ReadOnlyAccess'),
            ],
        });
        // Allows the notebook to access the graph
        props.graph.grantFullAccess(this.role);
        // ------------------------------------------------------
        // Set properties or defaults
        // ------------------------------------------------------
        this.__resource = new sagemaker.CfnNotebookInstance(this, 'Resource', {
            instanceType: `ml.${this.instanceType.toString()}`,
            roleArn: this.role.roleArn,
            lifecycleConfigName: this.lifecycleConfig.attrNotebookInstanceLifecycleConfigName,
            notebookInstanceName: (0, utils_1.generatePhysicalNameV2)(this, 'aws-neptune-notebook', {
                separator: '-',
                maxLength: 63,
                lower: true,
            }),
            volumeSizeInGb: this.volumeSize.toGibibytes(),
            platformIdentifier: 'notebook-al2-v2',
            rootAccess: 'Disabled',
            instanceMetadataServiceConfiguration: {
                minimumInstanceMetadataServiceVersion: '2',
            },
            directInternetAccess: 'Enabled',
            tags: [
                {
                    key: 'aws-neptune-graph-id',
                    value: props.graph.graphId,
                },
            ],
        });
        this.graphExplorerEndpoint = `https://${this.__resource.attrNotebookInstanceName}.notebook.${region}.sagemaker.aws/proxy/9250/explorer/`;
        this.jupyterLabEndpoint = `https://${this.__resource.attrNotebookInstanceName}.notebook.${region}.sagemaker.aws/lab`;
        // Output Graph Explorer Endpoint
        new aws_cdk_lib_1.CfnOutput(this, 'GraphExplorerEndpoint', {
            value: this.graphExplorerEndpoint,
        });
    }
}
exports.NeptuneGraphNotebook = NeptuneGraphNotebook;
_a = JSII_RTTI_SYMBOL_1;
NeptuneGraphNotebook[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.neptune.NeptuneGraphNotebook", version: "0.1.309" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90ZWJvb2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2RrLWxpYi9uZXB0dW5lL25vdGVib29rLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7QUFFSCw2Q0FBbUU7QUFFbkUsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUMzQyx1REFBdUQ7QUFHdkQsc0RBQW9FO0FBMkJwRTs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQUNILE1BQWEsb0JBQXFCLFNBQVEsc0JBQVE7SUFhaEQseURBQXlEO0lBQ3pELGFBQWE7SUFDYix5REFBeUQ7SUFDekQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFnQztRQUN4RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sTUFBTSxHQUFHLG1CQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUV0QyxpQkFBaUI7UUFDakIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsVUFBVSxJQUFJLGtCQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxZQUFZO1lBQ2YsS0FBSyxDQUFDLFlBQVksSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTNGLHNEQUFzRDtRQUN0RCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksU0FBUyxDQUFDLGtDQUFrQyxDQUNyRSxJQUFJLEVBQ0osMEJBQTBCLEVBQzFCO1lBQ0UsT0FBTyxFQUFFO2dCQUNQO29CQUNFLE9BQU8sRUFBRSxnQkFBRSxDQUFDLE1BQU0sQ0FDaEI7Ozs7OzttQ0FNcUIsS0FBSyxDQUFDLEtBQUssQ0FBQyxhQUFhOzs7MEJBR2xDLE1BQU07O3NDQUVNLE1BQU07Ozs7O0lBS3hDLENBQ1M7aUJBQ0Y7YUFDRjtTQUNGLENBQ0YsQ0FBQztRQUVGLHFEQUFxRDtRQUNyRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUscUJBQXFCLEVBQUU7WUFDcEQsU0FBUyxFQUFFLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLHlCQUF5QixDQUFDO1lBQzlELGVBQWUsRUFBRTtnQkFDZixHQUFHLENBQUMsYUFBYSxDQUFDLHdCQUF3QixDQUFDLDJCQUEyQixDQUFDO2dCQUN2RSxnREFBZ0Q7Z0JBQ2hELEdBQUcsQ0FBQyxhQUFhLENBQUMsd0JBQXdCLENBQUMsd0JBQXdCLENBQUM7YUFDckU7U0FDRixDQUFDLENBQUM7UUFFSCwwQ0FBMEM7UUFDMUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXZDLHlEQUF5RDtRQUN6RCw2QkFBNkI7UUFDN0IseURBQXlEO1FBQ3pELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxTQUFTLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUNwRSxZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQ2xELE9BQU8sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU87WUFDMUIsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyx1Q0FBdUM7WUFDakYsb0JBQW9CLEVBQUUsSUFBQSw4QkFBc0IsRUFBQyxJQUFJLEVBQUUsc0JBQXNCLEVBQUU7Z0JBQ3pFLFNBQVMsRUFBRSxHQUFHO2dCQUNkLFNBQVMsRUFBRSxFQUFFO2dCQUNiLEtBQUssRUFBRSxJQUFJO2FBQ1osQ0FBQztZQUNGLGNBQWMsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRTtZQUM3QyxrQkFBa0IsRUFBRSxpQkFBaUI7WUFDckMsVUFBVSxFQUFFLFVBQVU7WUFDdEIsb0NBQW9DLEVBQUU7Z0JBQ3BDLHFDQUFxQyxFQUFFLEdBQUc7YUFDM0M7WUFDRCxvQkFBb0IsRUFBRSxTQUFTO1lBQy9CLElBQUksRUFBRTtnQkFDSjtvQkFDRSxHQUFHLEVBQUUsc0JBQXNCO29CQUMzQixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPO2lCQUMzQjthQUNGO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLHFCQUFxQixHQUFHLFdBQVcsSUFBSSxDQUFDLFVBQVUsQ0FBQyx3QkFBd0IsYUFBYSxNQUFNLHFDQUFxQyxDQUFDO1FBQ3pJLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxXQUFXLElBQUksQ0FBQyxVQUFVLENBQUMsd0JBQXdCLGFBQWEsTUFBTSxvQkFBb0IsQ0FBQztRQUVySCxpQ0FBaUM7UUFDakMsSUFBSSx1QkFBUyxDQUFDLElBQUksRUFBRSx1QkFBdUIsRUFBRTtZQUMzQyxLQUFLLEVBQUUsSUFBSSxDQUFDLHFCQUFxQjtTQUNsQyxDQUFDLENBQUM7SUFDTCxDQUFDOztBQXhHSCxvREF5R0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBDZm5PdXRwdXQsIEZuLCBSZXNvdXJjZSwgU2l6ZSwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5cbmltcG9ydCAqIGFzIGVjMiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCAqIGFzIHNhZ2VtYWtlciBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc2FnZW1ha2VyJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgSU5lcHR1bmVHcmFwaCB9IGZyb20gJy4vZ3JhcGgnO1xuaW1wb3J0IHsgZ2VuZXJhdGVQaHlzaWNhbE5hbWVWMiB9IGZyb20gJy4uLy4uL2NvbW1vbi9oZWxwZXJzL3V0aWxzJztcblxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogICAgICAgICAgICAgICAgICAgICAgICBQUk9QUyBGT1IgTkVXIENPTlNUUlVDVFxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciBjcmVhdGluZyBhIG5ldyBOZXB0dW5lIEdyYXBoIE5vdGVib29rXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTmVwdHVuZUdyYXBoTm90ZWJvb2tQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgTmVwdHVuZSBBbmFseXRpY3MgR3JhcGggdGhpcyBub3RlYm9vayB3aWxsIGJlIGNvbm5lY3RlZCB0b1xuICAgKi9cbiAgcmVhZG9ubHkgZ3JhcGg6IElOZXB0dW5lR3JhcGg7XG5cbiAgLyoqXG4gICAqIFRoZSBpbnN0YW5jZSB0eXBlIG9mIHRoZSBub3RlYm9vayBpbnN0YW5jZVxuICAgKiBAZGVmYXVsdCBcImVjMi5JbnN0YW5jZVR5cGUub2YoZWMyLkluc3RhbmNlQ2xhc3MuVDMsIGVjMi5JbnN0YW5jZVNpemUuTUVESVVNKVwiXG4gICAqL1xuICByZWFkb25seSBpbnN0YW5jZVR5cGU/OiBlYzIuSW5zdGFuY2VUeXBlO1xuXG4gIC8qKlxuICAgKiBUaGUgc2l6ZSBvZiB0aGUgRUJTIHZvbHVtZVxuICAgKiBAZGVmYXVsdCAtIDUgR2lCXG4gICAqL1xuICByZWFkb25seSB2b2x1bWVTaXplPzogU2l6ZTtcbn1cblxuLyoqXG4gKiBDcmVhdGVzIGEgTmVwdHVuZSBHcmFwaCBOb3RlYm9vayBmb3IgYSBnaXZlbiBncmFwaC5cbiAqXG4gKiBBIE5lcHR1bmUgR3JhcGggTm90ZWJvb2sgcHJvdmlkZXM6XG4gKiAtIFdlYi1iYXNlZCBpbnRlcmFjdGl2ZSBlbnZpcm9ubWVudCBmb3IgcXVlcnlpbmcgYW5kIHZpc3VhbGl6aW5nIGdyYXBoIGRhdGFcbiAqIC0gU3VwcG9ydCBmb3IgbXVsdGlwbGUgcXVlcnkgbGFuZ3VhZ2VzOlxuICogICAtIE9wZW5DeXBoZXIgZm9yIHByb3BlcnR5IGdyYXBoIHF1ZXJpZXNcbiAqICAgLSBHcmVtbGluIGZvciB0cmF2ZXJzYWwtYmFzZWQgcXVlcmllc1xuICogICAtIFNQQVJRTCBmb3IgUkRGIGdyYXBoIHF1ZXJpZXNcbiAqIC0gQnVpbHQtaW4gdmlzdWFsaXphdGlvbiBjYXBhYmlsaXRpZXMgZm9yIGV4cGxvcmluZyBncmFwaCByZWxhdGlvbnNoaXBzXG4gKiAtIFNhbXBsZSBub3RlYm9va3MgYW5kIHR1dG9yaWFscyB0byBoZWxwIHlvdSBnZXQgc3RhcnRlZFxuICogLSBJbnRlZ3JhdGlvbiB3aXRoIHBvcHVsYXIgZGF0YSBzY2llbmNlIGxpYnJhcmllcyAgICpcbiAqIFRoaXMgb3B0aW9uIGlzIG9ubHkgc3VwcG9ydGVkIHdoZW4gYHB1YmxpY0Nvbm5lY3Rpdml0eWAgaXMgc2V0IHRvIGB0cnVlYC4gRm9yIHByaXZhdGUgZ3JhcGhzLFxuICogeW91IHNob3VsZCBjcmVhdGUgeW91ciBvd24gbm90ZWJvb2sgZGVwbG95bWVudCB1c2luZyB0aGUgYE5lcHR1bmVHcmFwaE5vdGVib29rYCBDb25zdHJ1Y3QgYW5kXG4gKiBjb25maWd1cmUgdGhlIGFwcHJvcHJpYXRlIFZQQyBhbmQgc2VjdXJpdHkgZ3JvdXAgc2V0dGluZ3MuXG4gKlxuICogKipOb3RlOiBDcmVhdGluZyBhIG5vdGVib29rIHdpbGwgaW5jdXIgYWRkaXRpb25hbCBBV1MgY29zdHMgZm9yIHRoZSBub3RlYm9vayBpbnN0YW5jZS4qKlxuICpcbiAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL25lcHR1bmUvbGF0ZXN0L3VzZXJndWlkZS9ncmFwaC1ub3RlYm9va3MuaHRtbFxuICovXG5leHBvcnQgY2xhc3MgTmVwdHVuZUdyYXBoTm90ZWJvb2sgZXh0ZW5kcyBSZXNvdXJjZSB7XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBQcm9wZXJ0aWVzXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gIHB1YmxpYyByZWFkb25seSByb2xlOiBpYW0uUm9sZTtcbiAgcHVibGljIHJlYWRvbmx5IGxpZmVjeWNsZUNvbmZpZzogc2FnZW1ha2VyLkNmbk5vdGVib29rSW5zdGFuY2VMaWZlY3ljbGVDb25maWc7XG4gIHB1YmxpYyByZWFkb25seSB2b2x1bWVTaXplOiBTaXplO1xuICBwdWJsaWMgcmVhZG9ubHkgaW5zdGFuY2VUeXBlOiBlYzIuSW5zdGFuY2VUeXBlO1xuICBwdWJsaWMgcmVhZG9ubHkgZ3JhcGhFeHBsb3JlckVuZHBvaW50OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBqdXB5dGVyTGFiRW5kcG9pbnQ6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBfX3Jlc291cmNlOiBzYWdlbWFrZXIuQ2ZuTm90ZWJvb2tJbnN0YW5jZTtcblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gQXR0cmlidXRlc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IE5lcHR1bmVHcmFwaE5vdGVib29rUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgcmVnaW9uID0gU3RhY2sub2Yoc2NvcGUpLnJlZ2lvbjtcblxuICAgIC8vIFNldCBwcm9wZXJ0aWVzXG4gICAgdGhpcy52b2x1bWVTaXplID0gcHJvcHMudm9sdW1lU2l6ZSA/PyBTaXplLmdpYmlieXRlcyg1KTtcbiAgICB0aGlzLmluc3RhbmNlVHlwZSA9XG4gICAgICBwcm9wcy5pbnN0YW5jZVR5cGUgPz8gZWMyLkluc3RhbmNlVHlwZS5vZihlYzIuSW5zdGFuY2VDbGFzcy5UMywgZWMyLkluc3RhbmNlU2l6ZS5NRURJVU0pO1xuXG4gICAgLy8gQ3JlYXRlIGxpZmVjeWNsZSBjb25maWd1cmF0aW9uIGZvciBOZXB0dW5lIG5vdGVib29rXG4gICAgdGhpcy5saWZlY3ljbGVDb25maWcgPSBuZXcgc2FnZW1ha2VyLkNmbk5vdGVib29rSW5zdGFuY2VMaWZlY3ljbGVDb25maWcoXG4gICAgICB0aGlzLFxuICAgICAgJ05lcHR1bmVOb3RlYm9va0xpZmVjeWNsZScsXG4gICAgICB7XG4gICAgICAgIG9uU3RhcnQ6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBjb250ZW50OiBGbi5iYXNlNjQoXG4gICAgICAgICAgICAgIGAjIS9iaW4vYmFzaFxuc3VkbyAtdSBlYzItdXNlciAtaSA8PCdFT0YnXG5cbmVjaG8gXCJleHBvcnQgR1JBUEhfTk9URUJPT0tfQVVUSF9NT0RFPUlBTVwiID4+IH4vLmJhc2hyY1xuZWNobyBcImV4cG9ydCBHUkFQSF9OT1RFQk9PS19TU0w9VHJ1ZVwiID4+IH4vLmJhc2hyY1xuZWNobyBcImV4cG9ydCBHUkFQSF9OT1RFQk9PS19TRVJWSUNFPW5lcHR1bmUtZ3JhcGhcIiA+PiB+Ly5iYXNocmNcbmVjaG8gXCJleHBvcnQgR1JBUEhfTk9URUJPT0tfSE9TVD0ke3Byb3BzLmdyYXBoLmdyYXBoRW5kcG9pbnR9XCIgPj4gfi8uYmFzaHJjXG5lY2hvIFwiZXhwb3J0IEdSQVBIX05PVEVCT09LX1BPUlQ9ODE4MlwiID4+IH4vLmJhc2hyY1xuZWNobyBcImV4cG9ydCBORVBUVU5FX0xPQURfRlJPTV9TM19ST0xFX0FSTj1cIiA+PiB+Ly5iYXNocmNcbmVjaG8gXCJleHBvcnQgQVdTX1JFR0lPTj0ke3JlZ2lvbn1cIiA+PiB+Ly5iYXNocmNcblxuYXdzIHMzIGNwIHMzOi8vYXdzLW5lcHR1bmUtbm90ZWJvb2stJHtyZWdpb259L2dyYXBoX25vdGVib29rLnRhci5neiAvdG1wL2dyYXBoX25vdGVib29rLnRhci5nelxucm0gLXJmIC90bXAvZ3JhcGhfbm90ZWJvb2tcbnRhciAtenh2ZiAvdG1wL2dyYXBoX25vdGVib29rLnRhci5neiAtQyAvdG1wXG4vdG1wL2dyYXBoX25vdGVib29rL2luc3RhbGwuc2hcblxuRU9GYCxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZXMgYSByb2xlIGFzc29jaWF0ZWQgdG8gdGhlIG5vdGVib29rIGluc3RhbmNlXG4gICAgdGhpcy5yb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsICdOZXB0dW5lTm90ZWJvb2tSb2xlJywge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ3NhZ2VtYWtlci5hbWF6b25hd3MuY29tJyksXG4gICAgICBtYW5hZ2VkUG9saWNpZXM6IFtcbiAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKCdBbWF6b25TYWdlTWFrZXJGdWxsQWNjZXNzJyksXG4gICAgICAgIC8vIEFsbG93cyBkb3dubG9hZGluZyB0aGUgZ3JhcGhfbm90ZWJvb2sgcGFja2FnZVxuICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ0FtYXpvblMzUmVhZE9ubHlBY2Nlc3MnKSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICAvLyBBbGxvd3MgdGhlIG5vdGVib29rIHRvIGFjY2VzcyB0aGUgZ3JhcGhcbiAgICBwcm9wcy5ncmFwaC5ncmFudEZ1bGxBY2Nlc3ModGhpcy5yb2xlKTtcblxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIFNldCBwcm9wZXJ0aWVzIG9yIGRlZmF1bHRzXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5fX3Jlc291cmNlID0gbmV3IHNhZ2VtYWtlci5DZm5Ob3RlYm9va0luc3RhbmNlKHRoaXMsICdSZXNvdXJjZScsIHtcbiAgICAgIGluc3RhbmNlVHlwZTogYG1sLiR7dGhpcy5pbnN0YW5jZVR5cGUudG9TdHJpbmcoKX1gLFxuICAgICAgcm9sZUFybjogdGhpcy5yb2xlLnJvbGVBcm4sXG4gICAgICBsaWZlY3ljbGVDb25maWdOYW1lOiB0aGlzLmxpZmVjeWNsZUNvbmZpZy5hdHRyTm90ZWJvb2tJbnN0YW5jZUxpZmVjeWNsZUNvbmZpZ05hbWUsXG4gICAgICBub3RlYm9va0luc3RhbmNlTmFtZTogZ2VuZXJhdGVQaHlzaWNhbE5hbWVWMih0aGlzLCAnYXdzLW5lcHR1bmUtbm90ZWJvb2snLCB7XG4gICAgICAgIHNlcGFyYXRvcjogJy0nLFxuICAgICAgICBtYXhMZW5ndGg6IDYzLFxuICAgICAgICBsb3dlcjogdHJ1ZSxcbiAgICAgIH0pLFxuICAgICAgdm9sdW1lU2l6ZUluR2I6IHRoaXMudm9sdW1lU2l6ZS50b0dpYmlieXRlcygpLFxuICAgICAgcGxhdGZvcm1JZGVudGlmaWVyOiAnbm90ZWJvb2stYWwyLXYyJyxcbiAgICAgIHJvb3RBY2Nlc3M6ICdEaXNhYmxlZCcsXG4gICAgICBpbnN0YW5jZU1ldGFkYXRhU2VydmljZUNvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgbWluaW11bUluc3RhbmNlTWV0YWRhdGFTZXJ2aWNlVmVyc2lvbjogJzInLFxuICAgICAgfSxcbiAgICAgIGRpcmVjdEludGVybmV0QWNjZXNzOiAnRW5hYmxlZCcsXG4gICAgICB0YWdzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBrZXk6ICdhd3MtbmVwdHVuZS1ncmFwaC1pZCcsXG4gICAgICAgICAgdmFsdWU6IHByb3BzLmdyYXBoLmdyYXBoSWQsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgdGhpcy5ncmFwaEV4cGxvcmVyRW5kcG9pbnQgPSBgaHR0cHM6Ly8ke3RoaXMuX19yZXNvdXJjZS5hdHRyTm90ZWJvb2tJbnN0YW5jZU5hbWV9Lm5vdGVib29rLiR7cmVnaW9ufS5zYWdlbWFrZXIuYXdzL3Byb3h5LzkyNTAvZXhwbG9yZXIvYDtcbiAgICB0aGlzLmp1cHl0ZXJMYWJFbmRwb2ludCA9IGBodHRwczovLyR7dGhpcy5fX3Jlc291cmNlLmF0dHJOb3RlYm9va0luc3RhbmNlTmFtZX0ubm90ZWJvb2suJHtyZWdpb259LnNhZ2VtYWtlci5hd3MvbGFiYDtcblxuICAgIC8vIE91dHB1dCBHcmFwaCBFeHBsb3JlciBFbmRwb2ludFxuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgJ0dyYXBoRXhwbG9yZXJFbmRwb2ludCcsIHtcbiAgICAgIHZhbHVlOiB0aGlzLmdyYXBoRXhwbG9yZXJFbmRwb2ludCxcbiAgICB9KTtcbiAgfVxufVxuIl19